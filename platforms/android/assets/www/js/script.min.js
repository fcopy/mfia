function getElementsByAttribute(e,t,n,o){for(var r,i,a="*"==t&&e.all?e.all:e.getElementsByTagName(t),s=new Array,c="undefined"!=typeof o?new RegExp("(^|\\s)"+o+"(\\s|$)","i"):null,l=0;l<a.length;l++)r=a[l],i=r.getAttribute&&r.getAttribute(n),"string"==typeof i&&i.length>0&&("undefined"==typeof o||c&&c.test(i))&&s.push(r);return s}function toggleClass(e,t){strHasClass(e.className,t)?removeClass(e,t):addClass(e,t)}function addRemoveClass(e,t,n){var o=e.className,r=!0;if(t)for(var i=0;i<t.length;i++)strHasClass(o,t[i])||(r=!1,o+=(""==o?"":" ")+t[i]);if(n)for(var i=0;i<n.length;i++)strHasClass(o,n[i])&&(r=!1,o=strRemoveClass(o,n[i]));r||(e.className=o.trim())}function addClass(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])||(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(strHasClass(n,t))return;n+=(""==n?"":" ")+t}e.className=n}function removeClass(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)strHasClass(n,t[r])&&(o=!1,n=strRemoveClass(n,t[r]));if(o)return}else{if(!strHasClass(n,t))return;n=strRemoveClass(n,t)}n=n.trim(),""==n?e.removeAttribute("class"):e.className=n}function getClassThatStartsWith(e,t){for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o].indexOf(t)>-1)return n[o]}function hasClass(e,t){return strHasClass(e.className,t)}function strHasClass(e,t){for(var n=e.trim().split(" "),o=0;o<n.length;o++)if(n[o]==t)return!0;return!1}function strRemoveClass(e,t){for(var n=e.trim().split(" "),o=0;o<n.length;o++)n[o]==t&&(n[o]=null);return n.join(" ")}function removeElement(e){e&&e.parentNode&&e.parentNode.removeChild(e)}function guid(){function e(){return Math.floor(65536*(1+Math.random())).toString(16).substring(1)}return e()+e()+"-"+e()+"-"+e()+"-"+e()+"-"+e()+e()+e()}function getDateTime(){var e=new Date,t=e.getFullYear(),n=e.getMonth()+1,o=e.getDate(),r=e.getHours(),i=e.getMinutes(),a=e.getSeconds();if(1==n.toString().length)var n="0"+n;if(1==o.toString().length)var o="0"+o;if(1==r.toString().length)var r="0"+r;if(1==i.toString().length)var i="0"+i;if(1==a.toString().length)var a="0"+a;var s=t+"/"+n+"/"+o+" "+r+":"+i+":"+a;return s}function getFormData(e){var t=new FormData;for(var n in e)e[n]&&t.append(n,e[n]);return t}function newBlob(e,t){try{var n=new Blob([e],{type:t});return n}catch(o){if(window.BlobBuilder=window.BlobBuilder||window.WebKitBlobBuilder||window.MozBlobBuilder||window.MSBlobBuilder,"TypeError"==o.name&&window.BlobBuilder){var r=new BlobBuilder;r.append(e.buffer);var n=r.getBlob(t);return n}if("InvalidStateError"==o.name){var n=new Blob([e.buffer],{type:t});return n}}}function clone(e){if(null==e||"object"!=typeof e)return e;var t=e.constructor();for(var n in e)e.hasOwnProperty(n)&&(t[n]=clone(e[n]));return t}function rgb2hex(e){function t(e){return("0"+parseInt(e).toString(16)).slice(-2)}return/^#[0-9A-F]{6}$/i.test(e)?e:(e=e.match(/^rgb\((\d+),\s*(\d+),\s*(\d+)\)$/))?"#"+t(e[1])+t(e[2])+t(e[3]):void 0}function timeOut(e,t){var n=setInterval(function(){e(),clearInterval(n)},t);return n}function wrapNode(e,t){var n=document.createRange();n.selectNode(e),n.surroundContents(document.createElement(t))}function wrapNodeFromTo(e,t,n,o){var r=document.createRange();r.setStart(e,n),r.setEnd(e,o),r.surroundContents(document.createElement(t))}function XMLEscape(e,t){for(var n="",o=0;o<e.length;o++){var r=e.charAt(o);n+="&"==r?"&amp;":"'"==r?t?"&apos;":"&#39;":r}return n}function replaceHTML(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o}function kTemplate(e){return mobile?""+(config.overflowScroll?"templates/mobileOverflow/":"templates/mobile/")+e:"templates/web/"+e}function arrayContainsProperty(e,t,n){for(var o=0;o<e.length;o++)if(e[o][t]==n)return!0;return!1}function cacheBust(e){return e+"?"+Math.floor(9999*Math.random())}function addPrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.addEventListener(o[r]+t,n,!1)}function removePrefixedEvent(e,t,n){for(var o=["webkit","moz","MS","o",""],r=0;r<o.length;r++)o[r]||(t=t.toLowerCase()),e.removeEventListener(o[r]+t,n,!1)}function redrawForChrome(e){-1!=navigator.userAgent.toLowerCase().indexOf("chrome")&&(e.style.display="inline-block",e.offsetHeight,e.style.display="")}function pauseVideoAndAudio(e){for(var t=e.getElementsByTagName("audio"),n=t.length;n--;)try{t[n].pause()}catch(o){}for(var r=e.getElementsByTagName("video"),n=r.length;n--;)try{r[n].pause()}catch(o){}}function isEmpty(e){for(var t in e)if(e.hasOwnProperty(t))return!1;return!0&&JSON.stringify(e)===JSON.stringify({})}function asyncCheck(e,t,n,o){return e?o():(n.push(o),t.apply(this,n))}function autoprefixTransform(e,t){t||(t=""),e.style.transform=e.style.msTransform=e.style.webkitTransform=e.style.mozTransform=t}function detectIE(){var e=window.navigator.userAgent,t=e.indexOf("MSIE ");if(t>0)return parseInt(e.substring(t+5,e.indexOf(".",t)),10);var n=e.indexOf("Trident/");if(n>0){var o=e.indexOf("rv:");return parseInt(e.substring(o+3,e.indexOf(".",o)),10)}var r=e.indexOf("Edge/");return r>0?parseInt(e.substring(r+5,e.indexOf(".",r)),10):!1}function applyPreview(e){console.log(e);var t=angular.element(document.body).scope();console.log(t),t.config=config=e,t.$apply(),angular.element(document.getElementById("home")).scope().injectUserCSS(e)}function getCookie(e){var t="; "+document.cookie,n=t.split("; "+e+"=");return 2==n.length?n.pop().split(";").shift():void 0}function getVar(e){return Modernizr.localstorage?localStorage[e]:getCookie("continueWithoutHTML5")}function setVar(e,t){Modernizr.localstorage?localStorage[e]=t:document.cookie=e+"="+t}function putTest(){}function continueLocally(){setVar("continueLocally","true"),location.reload()}function continueWithoutHTML5(){setVar("continueWithoutHTML5","true"),location.reload()}function kInteractionStart(){this.log=function(e){console.log(e)},kInteractive.setDOMParser(),kInteractive.preRender(),kInteractive.postRender()}!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(o){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser),ph={},ph.removeHash=function(e){return-1==e.indexOf("#")?e:e.substring(0,e.lastIndexOf("#"))},ph.getHash=function(e){return e.indexOf("#")>=0?e.substr(e.lastIndexOf("#")+1):void 0},ph.normalize=function(e){return ph.normalizedArray(e).join("/")},ph.normalizedArray=function(e){e=e.replace(/\\/g,"/");for(var t=e.split("/"),n=t.length;n--;)t[n]?".."==t[n]&&n>0&&".."!=t[n-1]&&(t.splice(n,1),t.splice(n-1,1)):t.splice(n,1);return t[0].match(/http[s]?:$/g)&&(t[0]+="//"+t[1],t.splice(1,1)),"file:"==t[0]&&(t[0]+="///"+t[1],t.splice(1,1)),t},ph.basename=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1]},ph.removeFilename=function(e){var t=ph.normalizedArray(e);return-1==t[t.length-1].indexOf(".")?e:(t.splice(t.length-1,1),t.join("/"))},ph.removeExtension=function(e){if(-1==e.indexOf("."))return e;var t=e.split(".");return t.splice(t.length-1,1),t.join(".")},ph.getExtension=function(e){if(-1==e.indexOf("."))return"";var t=e.split(".");return t[t.length-1]},ph.dirname=function(e){if(-1==e.indexOf("/"))return e;var t=ph.normalizedArray(e);return t[t.length-1].indexOf(".")>=0&&t.splice(t.length-1,1),1==t.length?t[0]:t[t.length-1]},ph.relative=function(e,t){var n,o,r=ph.normalizedArray(e),i=ph.normalizedArray(t),a=new Array;for(r[r.length-1].indexOf(".")>=0&&r.splice(r.length-1,1),n=0;n<r.length&&r[n]==i[n];n++);for(o=n;o<r.length;o++)a.push("..");for(o=n;o<i.length;o++)a.push(i[o]);return a.join("/")},ph.join=function(){for(var e=new Array,t=0;t<arguments.length;t++){var n=ph.normalizedArray(arguments[t]);t<arguments.length-1&&n[n.length-1].indexOf(".")>=0&&n.splice(n.length-1,1),e=e.concat(n)}var o=ph.normalize(e.join("/"));return"/"==arguments[0].substr(0,1)&&(o="/"+o),o};var startDate=Date.now(),log=function(e){debug&&(null==e&&(e="null"),debugDuration&&(e=Date.now()-startDate+" "+e),console.log(e))},Base64Binary={_keyStr:"ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",decodeArrayBuffer:function(e){var t=e.length/4*3,n=new ArrayBuffer(t);return this.decode(e,n),n},decode:function(e,t){var n=this._keyStr.indexOf(e.charAt(e.length-1)),o=this._keyStr.indexOf(e.charAt(e.length-2)),r=e.length/4*3;64==n&&r--,64==o&&r--;var i,a,s,c,l,d,u,p,f=0,g=0;for(i=new Uint8Array(t?t:r),e=e.replace(/[^A-Za-z0-9\+\/\=]/g,""),f=0;r>f;f+=3)l=this._keyStr.indexOf(e.charAt(g++)),d=this._keyStr.indexOf(e.charAt(g++)),u=this._keyStr.indexOf(e.charAt(g++)),p=this._keyStr.indexOf(e.charAt(g++)),a=l<<2|d>>4,s=(15&d)<<4|u>>2,c=(3&u)<<6|p,i[f]=a,64!=u&&(i[f+1]=s),64!=p&&(i[f+2]=c);return i}},currentIndex,parser=new DOMParser,preview,previewParams,app,mobile=/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent),mobileDebug=!1,ios=/iPhone|iPad|iPod/i.test(navigator.userAgent),debug=!1,native,bookPath,noFlash,desktop,chromeApp,os,uuid,partitionEnabled="Android"==mobile&&config.kotobee.segregate,isKotobee=!0,debugDuration=!1,swipeMode="chapter",parseSecsSeparate=!0,overflowScroll=!mobile|config.overflowScroll,rootDir="",postOptions={transformRequest:angular.identity,headers:{"Content-Type":void 0}};null==config.mediaTab&&(config.mediaTab=!0),null==config.settingsTab&&(config.settingsTab=!0),null==config.textSizeControls&&(config.textSizeControls=!0),null==config.chaptersTab&&(config.chaptersTab=!0),null==config.showCategories&&(config.showCategories=!0),null==config.styleControls&&(config.styleControls=!1),function(){function e(){for(var e,t,n=document.getElementsByTagName("head")[0],o=n.innerHTML,r=document.getElementsByTagName("script"),i=0;i<r.length;i++)if(r[i].getAttribute("src")&&r[i].getAttribute("src").indexOf("lib/ionic/release/js")>=0){var a=r[i].getAttribute("src").split("lib/ionic/release/js");rootDir=a[0];break}mobile?(t=[],e=[rootDir+"lib/ionic/release/css/ionic.min.css"]):(t=[],e=[rootDir+"css/ionicWeb.css"]),e=[rootDir+"lib/ionic/release/css/ionic.min.css"];for(var i=0;i<t.length;i++)o+='<script src="'+t[i]+'"></script>';for(var i=0;i<e.length;i++)o='<link rel="stylesheet" href="'+e[i]+'">'+o;n.innerHTML=o}function t(){angular.module("ngIOS9UIWebViewPatch",["ng"]).config(["$provide",function(e){"use strict";e.decorator("$browser",["$delegate","$window",function(e,t){function n(e){return/(iPhone|iPad|iPod).* OS 9_\d/.test(e)&&!/Version\/9\./.test(e)}function o(e){function t(){n=null}var n=null,o=e.url;return e.url=function(){return arguments.length?(n=arguments[0],o.apply(e,arguments)):n||o.apply(e,arguments)},window.addEventListener("popstate",t,!1),window.addEventListener("hashchange",t,!1),e}return n(t.navigator.userAgent)?o(e):e}])}])}if(detectIE()&&timeOut(function(){addClass(document.getElementsByTagName("body")[0],"ie")},100),window.location.href.indexOf("?preview")>0){preview=!0,mobileDebug=!0;var n=window.location.href.split("?");n=n[1].split("&"),previewParams={};for(var o=0;o<n.length;o++){var r=n[o].split("=");previewParams[r[0]]=r[1]}mobile=previewParams.mobile}else if("file:"==window.location.protocol){if(mobile)native=!0;else if(window.chrome&&chrome.app&&chrome.app.runtime&&chrome.storage){try{if(!chromeEnabled)return}catch(i){return}chromeApp=!0}else if("undefined"!=typeof require)desktop=!0,os="mac",process.env.OS&&process.env.OS.toLowerCase().indexOf("windows")>=0&&(os=process.env.PROCESSOR_ARCHITECTURE.indexOf("64")>=0?"win64":"win32");else if("true"!=getVar("continueLocally"))return timeOut(function(){document.getElementById("localFallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e()}else"chrome-extension:"==window.location.protocol&&(chromeApp=!0);if(!chromeApp){if("true"!=getVar("continueWithoutHTML5")&&!(Modernizr.audio&&Modernizr.video&&Modernizr.backgroundsize&&Modernizr.borderradius&&Modernizr.canvas&&Modernizr.opacity&&Modernizr.localstorage&&Modernizr.rgba))return timeOut(function(){document.getElementById("html5Fallback").style.display="block",document.getElementById("kotobeeLink").style.display="none",document.getElementsByTagName("body")[0].style.cssText="overflow-y: scroll;"},100),void e();setVar("continueLocally","false"),setVar("continueWithoutHTML5","false")}e(),t(),app=angular.module("reader.Kotobee",["templates","ionic","angular.css.injector","scormwrapper","ngIOS9UIWebViewPatch"]),ionic.Platform.isFullScreen=!1,app.config(["$stateProvider","$urlRouterProvider","$ionicConfigProvider","$compileProvider",function(e,t,n,o){chromeApp&&o.imgSrcSanitizationWhitelist(/^\s*((https?|ftp|file|blob|chrome-extension):|data:image\/)/),n.views.swipeBackEnabled(!1),t.otherwise("/loading"),e.state("home",{url:"/loading",templateUrl:kTemplate("views/home.html")}).state("login",{url:"/login",templateUrl:kTemplate("views/login.html")}).state("register",{url:"/register",templateUrl:kTemplate("views/register.html")}).state("forgotPwd",{url:"/forgotpwd",templateUrl:kTemplate("views/forgotPwd.html")}).state("redeemCode",{url:"/redeemcode",templateUrl:kTemplate("views/redeemCode.html")}).state("library",{url:"/library",templateUrl:kTemplate("views/library.html")}).state("library.tab",{url:"/tab/:tab",templateUrl:kTemplate("views/library.html")}).state("reader",{url:"/reader",templateUrl:kTemplate("views/reader.html")}).state("reader.chapter",{url:"/chapter/:ch",templateUrl:kTemplate("views/reader.html")}).state("reader.chapterhash",{url:"/chapter/:ch/:hash",templateUrl:kTemplate("views/reader.html")}).state("app",{url:"/app",templateUrl:kTemplate("views/app.html")})}]),putTest("prerun timeout start"),window.setTimeout(function(){putTest("prerun timeout found!!")},300),app.run(["$ionicPlatform","$location","chapters",function(e,t,n){var o=t.path();if(0==o.indexOf("/reader/chapter/")){var r=o.split("/reader/chapter/")[1],i=r.split("/");i.length>0&&(n.startChapter=Number(i[0])),i.length>1&&(n.startHash=i[1])}t.path("/loading"),e.ready(function(){try{try{ios||StatusBar&&(StatusBar.overlaysWebView(!1),StatusBar.backgroundColorByHexString("#2c1c3c"))}catch(e){}try{document.addEventListener("deviceready",function(){},!1)}catch(e){}try{navigator.splashscreen&&setTimeout(function(){navigator.splashscreen.hide()},1e3)}catch(e){}putTest("app 1"),putTest(setTimeout),putTest(window.setTimeout),putTest(window.setTimeout==setTimeout),window.setTimeout(function(){putTest("timeout A")},100),putTest("app 1b"),window.setTimeout(function(){putTest("timeout B")},300),putTest("app 1c"),setTimeout(function(){putTest("timeout C")},600),putTest("app 1d"),window.setTimeout(function(){putTest("timeout D")},600),putTest("app 1e"),setTimeout(function(){putTest("app 1a");try{{cordova?"CT":"CF",window.cordova?"FT":"FF",cordova.plugins?"T":"F",window.cordova.plugins?"T":"F"}putTest("app 2")}catch(e){putTest("app 3")}putTest("app 4"),window.cordova&&window.cordova.plugins.Keyboard&&cordova.plugins.Keyboard.hideKeyboardAccessoryBar(!0),putTest("app 5"),window.StatusBar&&StatusBar.styleDefault(),putTest("app 6"),putTest(angular.element(document.body).scope().start),angular.element(document.body).scope().start(),putTest("app 7")},1e3),putTest("setTimeout called")}catch(e){putTest("in catch"),putTest(e)}})}])}();var kInteractive={scormWrapper:null,preRender:function(e){for(var t=(new DOMParser,e?e:document),n=t.getElementsByClassName("kInteractive"),o=n.length;o--;){var r=n[o];if(this.hasClass(r,"gallery")){var i=t.createDocumentFragment(),a=kInteractive.readData(r);r.innerHTML="";var s=document.createElement("div");s.className="images "+a.scale;for(var c=0;c<a.imgs.length;c++){var l=document.createElement("div");l.className="imgContainer"+(c?"":" selected");var d="undefined"==typeof isKotobee?a.imgs[c].path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,a.imgs[c].path);l.setAttribute("style","background-color:"+a.bgColor+";background-image:url('"+d+"')"+(c?"":";display:block")),s.appendChild(l)}i.appendChild(s);var u=document.createElement("a");u.className="next btn ki-btn",1==a.imgs.length&&(u.className+=" disable"),i.appendChild(u);var p=document.createElement("a");p.className="prev btn ki-btn disable",i.appendChild(p),"undefined"==typeof isKotobee&&(u.addEventListener("click",this.actionEvent),p.addEventListener("click",this.actionEvent)),r.appendChild(i)}if(this.hasClass(r,"questions")){var i=t.createDocumentFragment(),f=kInteractive.readData(r);if(r.id||(r.id="ki-qs-"+o+"-"+Math.ceil(1e3*Math.random())),f.options&&f.options.randomize){for(var g,m,h=f.q.length;0!==h;)m=Math.floor(Math.random()*h),h-=1,g=f.q[h],f.q[h]=f.q[m],f.q[m]=g;kInteractive.writeData(r,f)}f.options&&f.options.rtl&&(r.style.direction="rtl"),r.appendChild(i)}if(this.hasClass(r,"image")&&"undefined"==typeof isKotobee&&r.addEventListener("click",this.actionEvent),this.hasClass(r,"link")){var v=kInteractive.readData(r);if("div"==r.nodeName.toLowerCase()){var b=document.createElement("a");b.setAttribute("href","popup"==v.type?"":r.getAttribute("href")),b.setAttribute("target",v.target),b.setAttribute("style",r.getAttribute("style")),b.setAttribute("data-kotobee",r.getAttribute("data-kotobee")),b.className="kInteractive link btn",b.style.opacity=Number(v.transparency)/100,r.parentNode.replaceChild(b,r),r=b}"undefined"==typeof isKotobee&&("popup"==v.type&&r.setAttribute("onclick","return false;"),r.addEventListener("click",this.actionEvent))}if(this.hasClass(r,"container")){var y=kInteractive.readData(r);if(y.path){var d=y.path;"undefined"!=typeof isKotobee&&(d=ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,y.path));var k=r.getAttribute("style");r.setAttribute("style",k+' background-image:url("'+d+'");')}"cScroll"==y.type&&kInteractive.isMobile()&&(r.style.minHeight=r.style.height,r.style.height="auto",r.style.overflowY=null)}}},clearAudioVideo:function(e){for(var t=e?e:document,n=t.getElementsByTagName("audio"),o=n.length;o--;)try{n[o].pause(),n[o].children.length||(n[o].src="")}catch(r){}for(var i=t.getElementsByTagName("video"),o=i.length;o--;)i[o].pause(),i[o].children.length||(i[o].src="")},postRender:function(e){kInteractive.videoIsFullscreen=!1,kInteractive.timestamp=new Date,kInteractive.currentVideo=kInteractive.currentAudio=null,kInteractive.clearAudioVideo(e);for(var t=e?e:document,n=t.getElementsByClassName("kInteractive"),o=n.length;o--;){var r=n[o];if(this.hasClass(r,"questions")){var i=t.createDocumentFragment(),a=kInteractive.readData(r);if(r.innerHTML="",a.title){var s=document.createElement("span");s.innerHTML="<h4>"+kInteractive.escapeHtml(a.title)+"</h4>",i.appendChild(s)}for(var c=0;c<a.q.length;c++){var l=a.q[c],d=document.createElement("div");if(d.className="ques",d.innerHTML="<p><strong>"+(c+1)+". "+kInteractive.escapeHtml(l.q)+"</strong></p>",l.path){var u="undefined"==typeof isKotobee?l.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,l.path),p=document.createElement("img");p.src=u,d.appendChild(p)}if("mcq"==l.type||"mmcq"==l.type)for(var f=l.c,g=0;g<f.length;g++){var m="ki-mcq-"+o+"-"+c+"-"+g,h=document.createElement("input");"mmcq"==l.type?(h.name="name",h.type="checkbox"):(h.name="mcq-"+c,h.type="radio"),h.className="ans",h.id=m;var v=document.createElement("label");v.htmlFor=m,v.innerHTML=" "+kInteractive.escapeHtml(f[g].t)+"<br/>",v.className="ki-noHighlight";var b=document.createElement("div");b.className="answer",document[r.id]&&document[r.id].preserve&&document[r.id].q&&document[r.id].q[c]&&(h.checked=document[r.id].q[c][g],a.options&&a.options.highlightCorrect&&a.q[c].c[g].a&&kInteractive.c.addClass(b,"correct")),b.appendChild(h),b.appendChild(v),d.appendChild(b)}else if("tf"==l.type)for(var g=0;2>g;g++){var m="ki-tf-"+o+"-"+c+"-"+g,y=document.createElement("input");y.type="radio",y.name="tf-"+c,y.className="ans",y.id=m;var v=document.createElement("label");v.htmlFor=m,v.innerHTML=l.choice1&&l.choice2?kInteractive.escapeHtml(" "+(0==g?l.choice1:l.choice2)):" "+(0==g?"True":"False"),v.className="ki-noHighlight";var b=document.createElement("div");document[r.id]&&document[r.id].preserve&&document[r.id].q&&document[r.id].q[c]&&(y.checked=document[r.id].q[c][g],a.options&&a.options.highlightCorrect&&(0==g&&a.q[c].a||1==g&&!a.q[c].a)&&kInteractive.c.addClass(b,"correct")),b.appendChild(y),b.appendChild(v),d.appendChild(b)}if(d.appendChild(document.createElement("p")),document[r.id]&&document[r.id].preserve&&document[r.id].q&&document[r.id].q[c]&&a.q[c].exp){var k=d.getElementsByClassName("explanation");if(!k.length){var w=document.createElement("p");w.className="explanation",w.innerHTML=kInteractive.escapeHtml(a.q[c].exp),d.appendChild(w)}}i.appendChild(d)}var C=null;if("none"!=a.action){C=document.createElement("input");var T="ki-"+o+"-btn";C.type="submit",C.value=a.dict?a.dict.submit:"Submit Answers",C.id=T,C.className="btn ki-btn ki-mcq"}var E=null,x=null;if(a.options&&(a.options.clearAnswers&&(E=document.createElement("input"),E.type="submit",E.value=a.dict?a.dict.clear:"Clear Answers",E.className="btn ki-btn ki-questions questions-clear","undefined"==typeof isKotobee&&E.addEventListener("click",this.actionEvent)),a.options.preserveAnswers)){x=document.createElement("div"),x.style.marginTop="5px";var S=document.createElement("input");S.type="checkbox",S.name="preserveAnswers",S.className="ki-btn ki-questions questions-preserve",S.id="ki-"+o+"-preserveAnswersBtn",document[r.id]&&(S.checked=document[r.id].preserve),x.appendChild(S);var v=document.createElement("label");v.htmlFor=S.id,v.innerHTML=" "+(a.dict?a.dict.preserve:"Preserve submitted answers"),v.className="ki-noHighlight",x.appendChild(v),"undefined"==typeof isKotobee&&S.addEventListener("change",this.actionEvent)}"undefined"==typeof isKotobee&&C&&C.addEventListener("click",this.actionEvent),C&&i.appendChild(C),i.appendChild(document.createTextNode(" ")),E&&i.appendChild(E),x&&i.appendChild(x),i.appendChild(document.createElement("p")),r.appendChild(i)}else if(this.hasClass(r,"widget")){var I,i=t.createDocumentFragment(),B=kInteractive.readData(r);I=B.path?"undefined"==typeof isKotobee?B.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,B.path):"undefined"==typeof isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/";var A=B.name,$=B.src,N=B.width,L=B.height;if("page"==B.mode){if(r.children.length)return;if(!B.interaction){var O=document.createElement("div");O.className="cover",i.appendChild(O)}var M=document.createElement("iframe");M.setAttribute("nwdisable","true"),M.setAttribute("nwfaketop","true"),M.setAttribute("width",r.style.width?r.style.width:N+B.widthUnit),M.setAttribute("height",r.style.height?r.style.height:L+"px"),M.src=I+"/"+A+"/"+$,i.appendChild(M);var H=r.style.width,R=r.style.height;H.indexOf("px")>=0&&(B.widthUnit="px"),H.indexOf("%")>=0&&(B.widthUnit="%");try{B.width=Number(B.widthUnit?H.split(B.widthUnit)[0]:H)}catch(P){B.width=Number(H)}try{B.height=Number(R.split("px")[0])}catch(P){B.height=Number(R)}kInteractive.writeData(r,B)}else{if(r.setAttribute("wdgt-src",$),r.setAttribute("wdgt-name",A),!r.children.length&&!r.innerHTML.trim()){var D=document.createElement("img");D.src=I+"/"+A+"/Icon.png",i.appendChild(D)}"undefined"==typeof isKotobee&&r.addEventListener("click",this.actionEvent)}r.appendChild(i)}else if(this.hasClass(r,"video")){var i=t.createDocumentFragment(),z=kInteractive.readData(r),F="";z.splash&&(F="undefined"==typeof isKotobee?z.splash:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,z.splash));var j=r.style.cssText;-1==j.indexOf("background-image")&&r.setAttribute("style","background-image:url('"+F+"');"+j),r.setAttribute("id","ki-video-"+o),r.innerHTML="";var V=document.createElement("div");V.setAttribute("id","ki-video-"+o+"-container"),V.className="container";var q=document.createElement("a");q.className="playBtn ki-btn","undefined"==typeof isKotobee&&q.addEventListener("click",this.actionEvent),i.appendChild(q),i.appendChild(V),r.appendChild(i)}else if(this.hasClass(r,"audio")){{var i=t.createDocumentFragment();kInteractive.readData(r)}r.setAttribute("id","ki-audio-"+o),r.innerHTML="";var V=document.createElement("div");V.setAttribute("id","ki-audio-"+o+"-container"),V.className="container";var q=document.createElement("a");q.className="playBtn ki-btn","undefined"==typeof isKotobee&&q.addEventListener("click",this.actionEvent),i.appendChild(q),i.appendChild(V),r.appendChild(i)}else if(this.hasClass(r,"threed")){var i=t.createDocumentFragment(),U=kInteractive.readData(r);r.innerHTML="";var _=r.getAttribute("style");if(U.inter.placeholderPath){var W="undefined"==typeof isKotobee?U.inter.placeholderPath:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,U.inter.placeholderPath);_+="background-image:url('"+W+"');"}r.setAttribute("style",_);var K=document.createElement("a");U.inter.includeMsg?(K.innerHTML=kInteractive.escapeHtml(U.inter.msg),K.className="msgBtn ki-btn"):K.className="invisibleBtn ki-btn",i.appendChild(K),"undefined"==typeof isKotobee&&K&&K.addEventListener("click",this.actionEvent),r.appendChild(i)}else this.hasClass(r,"gallery")||this.hasClass(r,"image")}this.firstRun&&(window.addEventListener("resize",function(t){kInteractive.resizeEvent(e,t)}),this.firstRun=!1),kInteractive.resizeEvent(e)},actionEvent:function(e){kInteractive.action(e.target)},action:function(e){function t(){var e="Questions: "+l+". Score: "+u+" questions out of "+f;e+=". Action: "+B,"selfAnswerReport"==B&&(e+=". Details: "+g),kInteractive.tinCan({verb:"solved",activity:e})}function n(e,t){e.style.webkitAnimation=e.style.mozAnimation=e.style.animation=t}function o(e,t){e.style.webkitAnimationDuration=e.style.mozAnimationDuration=e.style.animationDuration=t}function r(e,t){e.style.webkitAnimationIterationCount=e.style.mozAnimationIterationCount=e.style.animationIterationCount=t}function i(e){var t=document.createElement("video");t.setAttribute("width","100%"),t.setAttribute("height","100%"),t.setAttribute("src",e),t.setAttribute("autoplay","true"),t.setAttribute("data-tap-disabled","false"),t.setAttribute("type","video/mp4"),t.setAttribute("webkit-playsinline","true"),t.setAttribute("controls","true"),t.className="ki-noHighlight",t.innerHTML="Your browser doesn't support HTML5 video.",t.oncanplay=function(){kInteractive.currentVideo==s&&(Q.className="playBtn ki-btn hide",kInteractive.tinCan({verb:"played",activity:"Video: "+e}))},t.addEventListener("webkitfullscreenchange",function(){var e=null!==document.webkitFullscreenElement;kInteractive.videoIsFullscreen=e});var n=s.getElementsByClassName("container")[0];n.setAttribute("data-tap-disabled","true"),n.appendChild(t),t.play()}function a(){function e(e){function n(){try{var e=document.createElement("canvas");return!(!window.WebGLRenderingContext||!e.getContext("webgl")&&!e.getContext("experimental-webgl"))}catch(t){return!1}}function o(t){var n=function(e){if(e.lengthComputable){var t=e.loaded/e.total*100;console.log(Math.round(t,2)+"% downloaded")}},r=function(){};if(!(t>=dt.objects.length)){var a=dt.objects[t],s="undefined"==typeof isKotobee?a.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,a.path),c=new THREE.OBJLoader(d);c.load(s,function(n){ut&&ut.parentNode&&ut.parentNode.removeChild(ut),i.domElement.parentNode||e.appendChild(i.domElement),n.position.set(a.x,a.y,a.z),n.traverse(function(e){if(e instanceof THREE.Mesh){var r=e==n.children[n.children.length-1];if(a.textPath){var i=new THREE.ImageLoader(d),s="undefined"==typeof isKotobee?a.textPath:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,a.textPath);i.load(s,function(i){var a=new THREE.Texture;a.image=i,a.needsUpdate=!0,e.material.map=a,r&&l.add(n),o(++t)},function(){},function(){})}else r&&l.add(n),o(++t)}})},n,r)}}function r(){i.render(l,c);y.getDelta();t=requestAnimFrame(r)}console.log("Threed found!!"),console.log(dt),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("_3D",dt.name?dt.name:"Model"),e.description="Opened 3D model: "+(dt.name?dt.name:"No name"),e.learnerResponses="Viewed",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800),t&&cancelAnimationFrame(t);var i;i=n()?new THREE.WebGLRenderer({precision:"highp"}):new THREE.CanvasRenderer;var a=e.offsetWidth,s=e.offsetHeight,c=new THREE.PerspectiveCamera(dt.camera.viewAngle,a/s,dt.camera.near,dt.camera.far),l=new THREE.Scene;null!=dt.scene.bgColor&&i.setClearColor(dt.scene.bgColor,1),l.add(c),c.position.x=dt.camera.x,c.position.y=dt.camera.y,c.position.z=dt.camera.z,i.setSize(a,s),dt.scene.floor&&(floor=new THREE.Mesh(new THREE.PlaneGeometry(500,500,1,1),new THREE.MeshPhongMaterial({color:dt.scene.floorColor?dt.scene.floorColor:10066329})),floor.applyMatrix((new THREE.Matrix4).makeRotationX(-Math.PI/2)),floor.position.y=-80,floor.receiveShadow=!0,l.add(floor));var d=new THREE.LoadingManager;d.onProgress=function(e,t,n){console.log(e,t,n)},o(0);var u=new THREE.OrbitControls(c,i.domElement);u.target=new THREE.Vector3(0,0,0);for(var p=0;p<dt.lights.length;p++)if("pointLight"==dt.lights[p].type){var f=new THREE.PointLight(dt.lights[p].color);f.position.set(dt.lights[p].x,dt.lights[p].y,dt.lights[p].z),l.add(f)}else if("directionalLight"==dt.lights[p].type){var g=new THREE.DirectionalLight(dt.lights[p].color,dt.lights[p].intensity);g.position.set(dt.lights[p].x,dt.lights[p].y,dt.lights[p].z),l.add(g)}else if("hemisphereLight"==dt.lights[p].type){var m=new THREE.HemisphereLight(dt.lights[p].sky,dt.lights[p].ground,dt.lights[p].intensity);m.position.set(dt.lights[p].x,dt.lights[p].y,dt.lights[p].z),l.add(m)}else if("spotLight"==dt.lights[p].type){var h=new THREE.SpotLight(dt.lights[p].color,dt.lights[p].intensity,dt.lights[p].distance,dt.lights[p].angle,dt.lights[p].exponent,dt.lights[p].decay);h.position.set(dt.lights[p].x,dt.lights[p].y,dt.lights[p].z),l.add(h)}else if("ambientLight"==dt.lights[p].type){var v=new THREE.AmbientLight(dt.lights[p].color);l.add(v)}else if("areaLight"==dt.lights[p].type){var b=new THREE.AreaLight(dt.lights[p].color,dt.lights[p].intensity);l.add(b)}var y=new THREE.Clock;r()}var t,n=s;if("inPanel"==dt.inter.target){var o={};o["class"]="threed",o.cb=function(t){var n=document.createElement("div");n.className="container",t.appendChild(n),e(n)},o.closed=function(){kInteractive.c.removeClass(s,"running")},kInteractive.openFrame(o)}else e(n)}for(var s=e;!this.hasClass(s,"kInteractive");)if(s=s.parentNode,s==document.body)return;if(this.hasClass(s,"questions")){var c=kInteractive.readData(s),l="Untitled questions",d=s.getElementsByTagName("h4");d.length&&(l=d[0].textContent||d[0].data);var u=0,p=s.getElementsByClassName("ques"),f=p.length,g="";if(this.hasClass(e,"questions-clear")){for(var m=s.getElementsByClassName("ans"),h=0;h<m.length;h++)m[h].checked=!1,kInteractive.c.removeClass(m[h].parentNode,"correct");for(var v=s.getElementsByClassName("explanation"),h=v.length;h--;)v[h].parentNode.removeChild(v[h]);return void(document[s.id]=null)}if(this.hasClass(e,"questions-preserve"))return console.log("clicked!"),document[s.id]||(document[s.id]={}),void(document[s.id].preserve=e.checked);for(var b=0,y=0,k=[],h=0;h<p.length;h++){var m=p[h].getElementsByClassName("ans"),w=m.length>0;if(kInteractive.scorm&&c.options&&c.options.answerOnce&&kInteractive.scorm.interactionExists(kInteractive.getScormId(s.id+"-"+(h+1),c.q[h].q))){var C="<p style='text-align:center'>"+(c.dict.alreadySubmitted?c.dict.alreadySubmitted:"This test has already been submitted!")+"</p>";return void kInteractive.alert({content:C})
}var T={};k.push(T),T.id=kInteractive.getScormId(s.id+"-"+(h+1),c.q[h].q),T.qid=s.id,T.type=m[0].getAttribute("id").indexOf("ki-tf-")>=0?"true-false":"choice",T.objective=c.options?c.options.objective:null,T.timestamp=kInteractive.timestamp,T.latency=Math.round(((new Date).getTime()-kInteractive.timestamp.getTime())/1e3),T.description=c.q[h].q;for(var E=0;E<m.length;E++)m[E].getAttribute("id").indexOf("ki-tf-")>=0?(0==E&&c.q[h].a?T.correctResponses=c.q[h].choice1:1!=E||c.q[h].a||(T.correctResponses=c.q[h].choice2),m[E].checked?(T.learnerResponses=E?c.q[h].choice2:c.q[h].choice1,0!=E||c.q[h].a?1==E&&c.q[h].a&&(w=!1):w=!1):0==E&&c.q[h].a?w=!1:1!=E||c.q[h].a||(w=!1),c.options&&c.options.highlightCorrect&&(0==E&&c.q[h].a||1==E&&!c.q[h].a)&&kInteractive.c.addClass(m[E].parentNode,"correct")):(c.q[h].c[E].a&&(T.correctResponses=c.q[h].c[E].t),m[E].checked&&(T.learnerResponses=c.q[h].c[E].t),m[E].checked&&!c.q[h].c[E].a?w=!1:!m[E].checked&&c.q[h].c[E].a&&(w=!1),c.options&&c.options.highlightCorrect&&c.q[h].c[E].a&&kInteractive.c.addClass(m[E].parentNode,"correct"));if(T.result=0,null!=c.q[h].weight&&(b+=c.q[h].weight,w&&(y+=c.q[h].weight,T.result=c.q[h].weight)),T.scoreMax=c.options?Number(c.options.totalScore):null,c.q[h].exp){var x=p[h].getElementsByClassName("explanation");if(!x.length){var v=document.createElement("p");v.className="explanation",v.innerHTML=kInteractive.escapeHtml(c.q[h].exp),p[h].appendChild(v)}}var S=c.dict?c.dict.question.replace("[no]",h+1):"Question "+(h+1);w?(g+="<span style='border-bottom: dotted 1px #aaa;' title='"+c.q[h].q+"'>"+S+".</span>  <span style='color:#366c20'>"+c.dict.correct+"</span><br/>",u++):g+="<span style='border-bottom: dotted 1px #aaa;' title='"+c.q[h].q+"'>"+S+".</span>  <span style='color:#7a1818'>"+c.dict.incorrect+"</span><br/>"}for(var h=0;h<k.length;h++)k[h].weighting=Math.round(1e3*c.options.totalScore/b)/1e3;var I,B=c.action;if(c.options.totalScore&&b&&(I=Math.round(10*c.options.totalScore*y/b)/10),"selfAnswer"==B||"selfAnswerReport"==B){var A="";"ar"==c.options.language&&(A=' direction="rtl"');var C="";if(c.dict){if(c.dict.scoreWeight&&null!=I){var $=I>c.options.passScore?c.dict.questionPass:c.dict.questionFail;$&&($+=". "),C+="<h3"+A+">"+($?$:"")+c.dict.scoreWeight.replace("[score]",I).replace("[total]",c.options.totalScore)+"</h3>"}C+="<p"+A+">"+c.dict.score.replace("[correct]",u).replace("[total]",f)+"</p>"}else C="You scored "+u+" question(s) out of "+f;"selfAnswerReport"==B&&(C="<p"+A+"><strong>"+C+"</strong></p><p><strong>"+(c.dict?c.dict.details:"Details")+"</strong></p><p class='kbAlertScroll'>"+g+"</p>"),kInteractive.alert({content:C}),t()}else if("email"==B){if("undefined"==typeof isKotobee)return void kInteractive.alert({content:c.dict.cloudOnly,title:c.dict?c.dict.sorry:"Sorry"});if(!config.kotobee.cloudid)return void kInteractive.alert({content:c.dict.cloudOnly,title:c.dict?c.dict.sorry:"Sorry"});var N={};N.ans=new Array;for(var E=0;E<p.length;E++)for(var m=p[E].getElementsByClassName("ans"),h=0;h<m.length;h++)m[h].checked&&N.ans.push({q:E,index:h,label:m[h].nextSibling.textContent||m[h].nextSibling.data});N.title=l;var L={};L.recipient=c.address,L.content=JSON.stringify(N),L.mode=config.kotobee.mode,L.cloudid=config.kotobee.cloudid,L.email=angular.element(document.body).scope().data.user.email;var O=e.value;e.value=c.dict?c.dict.submitting:"Submitting ..",e.setAttribute("disabled","true");var M=new XMLHttpRequest;M.onreadystatechange=function(){try{if(4===M.readyState&&200===M.status){e.value=O,e.removeAttribute("disabled");var t=JSON.parse(M.responseText);kInteractive.alert(t.success?{content:c.dict?c.dict.submitted:"Answers submitted!"}:{content:c.dict?c.dict.errorSubmitting:"An error has occurred while sending answers to the server"})}}catch(n){e.value=O,e.setAttribute("value",e.value),e.removeAttribute("disabled"),kInteractive.alert({content:c.dict?c.dict.errorSubmitting:"An error has occurred while sending answers to the server"})}};var H=config.kotobee.liburl?config.kotobee.liburl:"http://www.kotobee.com/";H+="library/report/questions",M.open("POST",H),M.setRequestHeader("Content-type","application/x-www-form-urlencoded");var R="a=a";for(var P in L){var D=L[P];void 0!=D&&"object"!=typeof D&&("string"==typeof D&&(D=encodeURIComponent(D)),"boolean"==typeof D&&(D=D?1:0),R+="&"+P+"="+D)}M.send(R),t()}document[s.id]||(document[s.id]={}),document[s.id].q=[];for(var z=s.getElementsByClassName("ques"),E=0;E<z.length;E++){document[s.id].q[E]=[];for(var F=z[E].getElementsByClassName("ans"),h=0;h<F.length;h++)document[s.id].q[E][h]=F[h].checked}kInteractive.scorm&&setTimeout(function(){kInteractive.scorm.setInteractions(k)},500)}else if(this.hasClass(s,"widget")){var j,V=kInteractive.readData(s);j=V.path?"undefined"==typeof isKotobee?V.path:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,V.path):"undefined"==typeof isKotobee?"../js/widgets/":bookPath+"EPUB/js/widgets/";var H=j+"/"+V.name+"/"+V.src,q=document.createElement("iframe");q.setAttribute("nwdisable","true"),q.setAttribute("nwfaketop","true"),V.cb=function(e){q.src=H,e.appendChild(q)},V.cb1="yes",V.closed=function(){},kInteractive.openFrame(V),kInteractive.tinCan({verb:"opened",activity:"Widget: "+V.name}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("widget",V.name),e.description="Opened popup widget: "+V.name,e.learnerResponses="Opened",e.type="other",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}else{if(this.hasClass(e,"link")){var L=kInteractive.readData(e);if("popup"==L.type){var C="<p class='kbAlertScroll'>"+L.msg+"</p>";kInteractive.alert({content:C}),kInteractive.scorm&&setTimeout(function(){var e={};e.id=kInteractive.getScormId("popup",L.msg),e.description="Shown popup message: "+L.msg,e.type="other",e.learnerResponses="Shown",e.timestamp=new Date,kInteractive.scorm.setInteractions([e])},800)}return!1}if(this.hasClass(e,"image")){var L=kInteractive.readData(e),U=L.behavior;if("none"==U)return;n(e,"none"),o(e,"none"),r(e,"none"),setTimeout(function(){function t(){var e,t=document.createElement("fakeelement"),n={animation:"animationend",OAnimation:"oAnimationEnd",MozAnimation:"animationend",WebkitAnimation:"webkitAnimationEnd"};for(e in n)if(void 0!==t.style[e])return n[e]}function i(){n(e,"none"),o(e,"none"),r(e,"none"),e.removeEventListener(a,i)}"wiggle"==U?(n(e,"wiggle"),o(e,"0.5s"),r(e,"1")):"jump"==U?(n(e,"jump"),o(e,"0.7s"),r(e,"1")):"scale"==U&&(n(e,"scale"),o(e,"0.5s"),r(e,"1"));var a=t();a&&e.addEventListener(a,i)}),kInteractive.tinCan({verb:"clicked",activity:U+"image: "+e.getAttribute("src")})}else if(this.hasClass(s,"gallery")){var _=s.getElementsByClassName("images")[0],u=_.children.length,W=s.getElementsByClassName("selected")[0],K=Number(W.style.left.slice(0,-2)),Y=Number(_.style.left.slice(0,-2));if(this.hasClass(e,"next")){var J=W.nextSibling;if(!J)return;kInteractive.c.removeClass(W,"selected"),kInteractive.c.addClass(J,"selected"),J.style.left=K+s.offsetWidth+"px",J.style.display="block",_.style.left=Y-s.offsetWidth+"px",J.nextSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(s.getElementsByClassName("prev")[0],"disable")}else if(this.hasClass(e,"prev")){var G=W.previousSibling;if(!G)return;kInteractive.c.removeClass(W,"selected"),kInteractive.c.addClass(G,"selected"),G.style.left=K-s.offsetWidth+"px",G.style.display="block",_.style.left=Y+s.offsetWidth+"px",G.previousSibling?kInteractive.c.removeClass(e,"disable"):kInteractive.c.addClass(e,"disable"),kInteractive.c.removeClass(s.getElementsByClassName("next")[0],"disable")}}else if(this.hasClass(s,"audio")){kInteractive.stopCurrentMedia();var X=kInteractive.readData(s);s.style.height=s.offsetHeight+"px";var Z=s.getAttribute("id")+"-container",Q=s.getElementsByClassName("playBtn")[0];if(Q.className="playBtn ki-btn hide",kInteractive.scorm){var T={};T.id=kInteractive.getScormId(s.getAttribute("id"),X.src),T.description="Played audio: "+X.src,T.type="other",T.learnerResponses="Played",T.objective=X.options?X.options.objective:null,T.timestamp=new Date,kInteractive.scorm.setInteractions([T])}var et=X.src;"file"==X.type&&(et="undefined"==typeof isKotobee?X.audio:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,X.audio));var tt=document.createElement("audio");tt.setAttribute("controls","true"),tt.setAttribute("autoplay","true"),tt.setAttribute("data-tap-disabled","false");var nt=document.createElement("source");nt.src=et,tt.appendChild(nt),tt.appendChild(document.createTextNode("Your browser does not support the audio element")),tt.className="ki-noHighlight",tt.oncanplay=function(){kInteractive.currentAudio==s&&kInteractive.tinCan({verb:"played",activity:"Audio: "+et})};var ot=s.getElementsByClassName("container")[0];ot.appendChild(tt),tt.play(),kInteractive.currentAudio=s,kInteractive.c.addClass(kInteractive.currentAudio,"playing")}else if(this.hasClass(s,"video")){var rt=kInteractive.readData(s),Z=s.getAttribute("id")+"-container",Q=s.getElementsByClassName("playBtn")[0];if(Q.className.indexOf("loading")>=0)return;if(kInteractive.stopCurrentMedia(),Q.className="playBtn ki-btn loading",kInteractive.scorm){var T={};T.id=kInteractive.getScormId(s.getAttribute("id"),rt.src),T.description="Played video: "+rt.src,T.type="other",T.learnerResponses="Played",T.objective=rt.options?rt.options.objective:null,T.timestamp=new Date,kInteractive.scorm.setInteractions([T])}if("file"==rt.type){var et="undefined"==typeof isKotobee?rt.video:ph.join(angular.element(document.body).scope().data.book.chapter.absoluteURL,rt.video);i(et)}else if(rt.src.indexOf("youtube.com")>=0||rt.src.indexOf("youtu.be/")>=0){var it;if(rt.src.indexOf("youtube.com")>=0){var at=rt.src.split("watch?v=");it=at[1]}else{if(!(rt.src.indexOf("youtu.be/")>=0))return;var at=rt.src.split("youtu.be/");it=at[at.length-1]}var st={videoId:it,playerVars:{autoplay:1,rel:"0"},events:{onReady:function(){},onStateChange:function(e){e.data==YT.PlayerState.PLAYING&&kInteractive.tinCan({verb:"played",activity:"Video: "+rt.src})}}};if(kInteractive.youTubeStatus)if("loading"==kInteractive.youTubeStatus){if(kInteractive.vQueue)return;kInteractive.vQueue=function(){Q.className="playBtn ki-btn hide",new YT.Player(Z,st)}}else"ready"==kInteractive.youTubeStatus&&(Q.className="playBtn ki-btn hide",new YT.Player(Z,st));else{window.onYouTubePlayerAPIReady=function(){kInteractive.youTubeStatus="ready",kInteractive.vQueue(),kInteractive.vQueue=null};var ct=document.createElement("script");ct.src="https://www.youtube.com/player_api";var lt=document.getElementsByTagName("script")[0];lt.parentNode.insertBefore(ct,lt),kInteractive.youTubeStatus="loading",kInteractive.vQueue=function(){Q.className="playBtn ki-btn hide",new YT.Player(Z,st)}}}else i(rt.src);kInteractive.currentVideo=s,kInteractive.c.addClass(kInteractive.currentVideo,"playing")}else if(this.hasClass(s,"threed")){var dt=kInteractive.readData(s);"inPanel"==dt.inter.target?kInteractive.c.addClass(s,"running"):s.innerHTML="";var ut=document.createElement("div");if(ut.className="loading",s.appendChild(ut),"undefined"==typeof THREE){var pt,ft=document.getElementsByTagName("head")[0],gt=ft.getElementsByTagName("script");if("undefined"!=typeof isKotobee)pt=bookPath+"EPUB/js/kotobeeInteractive3D.js";else for(var E=0;E<gt.length;E++)if(gt[E].src.indexOf("kotobeeinteractive.js")>=0){pt=gt[E].src.replace("kotobeeinteractive.js","kotobeeinteractive3D.js");break}if(!pt)return;var mt=document.createElement("script");mt.type="text/javascript",mt.src=pt,mt.onload=a,mt.onreadystatechange=function(){"complete"==this.readyState&&a()},ft.appendChild(mt)}else a()}}},openFrame:function(e){function t(){o.style.display="block",o.className="show";var t=window.innerHeight||document.documentElement.clientHeight||document.getElementsByTagName("body")[0].clientHeight,i=window.innerWidth||document.documentElement.clientWidth||document.getElementsByTagName("body")[0].clientWidth;t-=20,i-=20;var a=1;if(e.width&&e.height){var s=i/e.width,c=t/e.height;a=c>s?s:c,a>1&&(a=1)}var d="display:block;";d+=r;var u=e.width||e.height?"-50%,-50%":"0%,0%";d+="-webkit-transform:translate("+u+") scale("+a+");-moz-transform:translate("+u+") scale("+a+");transform:translate("+u+") scale("+a+");",n.style.cssText=d,n.className=l+" ready";var p=n.getElementsByClassName("closeBtn");if(p.length){var f=p[0],g=1/a,m="-50%";kInteractive.hasClass(f,"side")&&(m="0%"),f.style.cssText="-webkit-transform: translate("+m+",0%) scale("+g+");-webkit-transform-origin: 50% 50%;-moz-transform: translate("+m+",0%) scale("+g+");-moz-transform-origin: 50% 50%;transform: translate("+m+",0%) scale("+g+");transform-origin: 50% 50%;"}}var n=document.getElementById("kInteractiveFrame"),o=document.getElementById("kiDarkOverlay"),r="";if(e.dict||(e.dict={}),e.width&&(r+="width:"+e.width+"px;max-width:"+e.width+"px;"),e.height&&(r+="height:"+e.height+"px;max-height:"+e.height+"px;"),n||(o=document.createElement("div"),o.id="kiDarkOverlay",document.body.appendChild(o),o.style.display="none",o.addEventListener("click",kInteractive.closeFrame),n=document.createElement("div"),n.id="kInteractiveFrame"),e.pos||(e.pos="top"),"none"!=e.pos){var i=document.createElement("a"),a="closeBtn";e.pos&&(a+=" "+e.pos),i.className=a;var s=e.dict.close?e.dict.close:"Close";try{s=angular.element(document.body).scope().translit("close")}catch(c){}"side"!=e.pos&&(i.innerHTML=s),i.addEventListener("click",kInteractive.closeFrame),n.appendChild(i)}var l=e["class"]?e["class"]:"";(e.width||e.height)&&(l+=" fixed"),n.style.display="block",n.className=l,document.body.appendChild(n),kInteractive.frameIsOpen=!0,kInteractive.frameOb=e,kInteractive.openFrame.resized=t,window.addEventListener("resize",t),setTimeout(function(){t(),e.cb&&e.cb(n)},100)},closeAlert:function(e){e&&e.stopPropagation();var t=document.getElementById("kiSystemAlertBox"),n=document.getElementById("kiSystemAlertBackdrop");t.parentNode.removeChild(t),n.parentNode.removeChild(n),kInteractive.alertIsOpen=!1},closeFrame:function(){var e=document.getElementById("kInteractiveFrame"),t=document.getElementById("kiDarkOverlay");kInteractive.frameIsOpen=!1,window.removeEventListener("resize",kInteractive.openFrame.resized),kInteractive.openFrame.resized=null,kInteractive.c.removeClass(e,"ready");var n=kInteractive.frameOb,o="";n.width&&(o+="width:"+n.width+"px;max-width:"+n.width+"px;"),n.height&&(o+="height:"+n.height+"px;max-height:"+n.height+"px;"),e.style.cssText=o,t.className="",setTimeout(function(){e.innerHTML="",e.style.display=t.style.display="none",n.closed&&n.closed(),kInteractive.frameOb=null},300)},stopCurrentMedia:function(){if(kInteractive.currentVideo){var e=kInteractive.currentVideo.getAttribute("id")+"-container",t=document.getElementById(e);t.parentNode.removeChild(t);var n=document.createElement("div");n.setAttribute("id",e),n.className="container";var o=kInteractive.currentVideo.getElementsByClassName("playBtn")[0];o.className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentVideo,"playing"),kInteractive.currentVideo.appendChild(n)}if(kInteractive.currentAudio){var e=kInteractive.currentAudio.getAttribute("id")+"-container",t=document.getElementById(e);t.parentNode.removeChild(t);var n=document.createElement("div");n.setAttribute("id",e),n.className="container";var o=kInteractive.currentAudio.getElementsByClassName("playBtn")[0];o.className="playBtn ki-btn",kInteractive.c.removeClass(kInteractive.currentAudio,"playing"),kInteractive.currentAudio.appendChild(n)}},hasClass:function(e,t){if(e&&e.className)for(var n=e.className.trim().split(" "),o=0;o<n.length;o++)if(n[o]&&n[o].trim()==t)return!0},replaceHTML:function(e,t){var n="string"==typeof e?document.getElementById(e):e,o=n.cloneNode(!1);return o.innerHTML=t,n.parentNode.replaceChild(o,n),o},tinCan:function(e){if("undefined"!=typeof isKotobee)try{angular.element(document.body).scope().tinCanShortcut(e)}catch(t){}},setDOMParser:function(){!function(e){"use strict";var t=e.prototype,n=t.parseFromString;try{if((new e).parseFromString("","text/html"))return}catch(o){}t.parseFromString=function(e,t){if(/^\s*text\/html\s*(?:;|$)/i.test(t)){var o,r=document.implementation.createHTMLDocument(""),i=r.documentElement;return i.innerHTML=e,o=i.firstElementChild,1===i.childElementCount&&"html"===o.localName.toLowerCase()&&r.replaceChild(o,i),r}return n.apply(this,arguments)}}(DOMParser)},readData:function(e){try{var t=e.getAttribute("data-kotobee");return t||(t=e.getAttribute("data")),JSON.parse(decodeURI(kInteractive.XORCipher().decode("kotobee%%author",t)))}catch(n){try{return JSON.parse(kInteractive.XORCipher().decode("kotobee%%author",t))}catch(n){}}},writeData:function(e,t){var n=encodeURI(JSON.stringify(t)),o=e.hasAttribute("data-kotobee")?"data-kotobee":"data";e.setAttribute(o,kInteractive.XORCipher().encode("kotobee%%author",n))},XORCipher:function(){function e(e){var t,n,o,r,i,s,c,l,d,u=0,p="";if(!e)return e;do t=e[u++],n=e[u++],o=e[u++],l=t<<16|n<<8|o,r=l>>18&63,i=l>>12&63,s=l>>6&63,c=63&l,p+=a.charAt(r)+a.charAt(i)+a.charAt(s)+a.charAt(c);while(u<e.length);return d=e.length%3,(d?p.slice(0,d-3):p)+"===".slice(d||3)}function t(e){var t,n,o,r,i,s,c,l,d=0,u=[];if(!e)return e;e+="";do r=a.indexOf(e.charAt(d++)),i=a.indexOf(e.charAt(d++)),s=a.indexOf(e.charAt(d++)),c=a.indexOf(e.charAt(d++)),l=r<<18|i<<12|s<<6|c,t=l>>16&255,n=l>>8&255,o=255&l,u.push(t),64!==s&&(u.push(n),64!==c&&u.push(o));while(d<e.length);return u}function n(e,t){return e.charCodeAt(Math.floor(t%e.length))}function o(e,t){return i(t,function(t,o){return t.charCodeAt(0)^n(e,o)})}function r(e,t){return i(t,function(t,o){return String.fromCharCode(t^n(e,o))}).join("")}function i(e,t){for(var n=[],o=0;o<e.length;o++)n[o]=t(e[o],o);return n}var a="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=",s={encode:function(t,n){return n=o(t,n),e(n)},decode:function(e,n){return n=t(n),r(e,n)}};return s},getScormId:function(e,t){return e+"-"+t.replace(/[^a-zA-Z0-9]/g,"-").substr(0,80)},alert:function(e){var t=document.createElement("div");t.setAttribute("id","kiSystemAlertBox");var n=document.createElement("div");n.innerHTML=e.content,n.className="content",t.appendChild(n);var o=document.createElement("div");if(o.className="footer",e.title){var r=document.createElement("div");r.innerHTML=e.title,r.className="header",t.insertBefore(r,t.firstChild)}var i=document.createElement("a"),a="OK";try{a=angular.element(document.body).scope().translit("ok")}catch(s){}i.innerHTML=a,i.className="okBtn",kInteractive.alertIsOpen=!0,i.addEventListener("click",kInteractive.closeAlert),o.appendChild(i),t.appendChild(o);var c=document.createElement("div");c.setAttribute("id","kiSystemAlertBackdrop"),c.addEventListener("click",kInteractive.closeAlert),document.body.appendChild(c),document.body.appendChild(t),i.focus(),setTimeout(function(){t.className="show",c.className="show"},50)},c:{addClass:function(e,t){var n=e.className.trim();if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)-1==n.indexOf(t[r])&&(o=!1,n+=(""==n?"":" ")+t[r]);if(o)return}else{if(n.indexOf(t)>=0)return;n+=(""==n?"":" ")+t}e.className=n},removeClass:function(e,t){var n=e.className;if(t instanceof Array){for(var o=!0,r=0;r<t.length;r++)n.indexOf(t[r])>=0&&(o=!1,n=n.replace(t[r],""));if(o)return}else{if(-1==n.indexOf(t))return;n=n.replace(t,"")}n=n.trim(),""==n?e.removeAttribute("class"):e.className=n}},escapeHtml:function(e){var t={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#039;"};return e.replace(/[&<>"']/g,function(e){return t[e]})},resizeEvent:function(e){for(var t=e?e:document,n=t.getElementsByClassName("kInteractive"),o=n.length;o--;){var r=n[o];if(this.hasClass(r,"widget")){var i=kInteractive.readData(r);if("page"!=i.mode)continue;if("px"!=i.widthUnit)continue;var a=i.width,s=i.height,c=r.parentNode;if(!c)continue;if(a>c.offsetWidth){var l=c.offsetWidth/a,d=r.children.length-1;r.children[d].style.transform=r.children[d].style.webkitTransform=r.children[d].style.mozTransform="scale("+l+")",r.children[d].style.transformOrigin=r.children[d].style.webkitTransformOrigin=r.children[d].style.mozTransformOrigin="0 0",r.style.maxWidth=r.style.width,r.style.height=Math.round(s*l)+"px"}else{for(var d=0;d<r.children.length;d++)r.children[d].style.transform=r.children[d].style.webkitTransform=r.children[d].style.mozTransform=r.children[d].style.transformOrigin=r.children[d].style.webkitTransformOrigin=r.children[d].style.mozTransformOrigin=null;r.style.maxWidth=null,r.style.height=s+"px"}}}},isMobile:function(){return/Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent)},closeFullscreenVideo:function(){kInteractive.currentVideo&&(kInteractive.currentVideo.webkitExitFullscreen?kInteractive.currentVideo.webkitExitFullscreen():kInteractive.currentVideo.mozCancelFullScreen&&kInteractive.currentVideo.mozCancelFullScreen(),kInteractive.videoIsFullscreen=!1)},vQueue:[],youTubeReady:!1,firstRun:!0};if("undefined"==typeof isKotobee)try{document.addEventListener("DOMContentLoaded",kInteractionStart,!1)}catch(er){window.addEventListener("load",kInteractionStart,!1)}app.controller("BookInfoCtrl",["$scope","$timeout","translit","crdv","sync","status","stg","book","modals","chapters","$location","backend",function(e,t,n,o,r,i,a,s,c,l,d,u){function p(){if(g(),native&&"download"==k&&(k="loading"),native||"open"!=k||(k="loading"),m(),"loading"==k){var t=e.modal.bookInfoOptions.book;u.hasAccessTo({testagainst:t.id},function(t){t.success?g():k="denied",m(),e.$$phase||e.$apply()})}}function f(e){return a.data.info||(a.data.info={}),a.data.info["book"+e.id]||(a.data.info["book"+e.id]={}),a.data.info["book"+e.id]}function g(){if(e.modal){var t=e.modal.bookInfoOptions.book;native?k=t.exists?"open":f(t).loading?"downloading":f(t).extracting?"extracting":u.cloudParam("public")?"download":e.data.user.loggedIn?"download":u.cloudParam("entry")?"login":"download":u.cloudParam("public")?k="open":e.data.user.loggedIn?k="open":u.cloudParam("entry")&&(k="login")}}function m(){e.actionBtnIcon=v(),e.actionBtnSpinnerIcon=b(),e.actionBtnLabel=y(),e.actionBtnStyle=h()}function h(){return"open"==k?"openBtn":"login"==k?"openBtn":"downloading"==k?"downloadingBtn":"extracting"==k?"downloadingBtn":"loading"==k?"loadingBtn":"denied"==k?"deniedBtn":"downloadBtn"}function v(){return"open"==k?"ion-eye size18":"login"==k?"ion-person":"download"==k?"ion-code-download":"downloading"==k?null:"loading"==k?null:void 0}function b(){return"downloading"==k?"dots":"loading"==k?"dots":void 0}function y(){return"open"==k?"openBook":"login"==k?"loginToRead":"download"==k?"download":"downloading"==k?"downloading":"extracting"==k?"extracting":"loading"==k?"pleaseWait":"denied"==k?"accessDenied":void 0}var k;e.init=function(){p()},e.open=function(t){return preview?(c.hide(),void setTimeout(function(){c.show({mode:"generalError",errorOptions:{msg:n.get("cantPreviewLibBook")}})},500)):(native?(o.vibrate(),bookPath=o.libEbooksDirectory.nativeURL+t.path+"/EPUB/"):bookPath=config.kotobee.liburl+"books/"+t.path+"/EPUB/",e.hideModal(),void setTimeout(function(){function e(e){native&&t.exists?e({success:!0}):u.hasAccessTo({testagainst:t.id},e)}i.update(n.get("pleaseWait"),null,{dots:!0}),e(function(e){return e.success?void s.loadBook().then(function(){a.data.book.id=t.id,i.update(),d.path("/reader"),r.initialize(),setTimeout(function(){l.initialize()},1e3)}):void i.update()})},200))},e.download=function(r){function i(t){f(r).progress=Math.ceil(100*t),e.$$phase||e.$apply()}f(r).loading||(o.vibrate(),o.toast(n.get("bookIsDownloading")),f(r).loading=!0,g(),m(),f(r).progress=0,setTimeout(function(){u.downloadEbook(r,i,function(n){f(r).loading=null,f(r).extracting=!0,g(),m(),t(function(){o.writeEbook("src.zip",r,n,function(){f(r).extracting=null,g(),m(),c.hide(),t(function(){c.show({mode:"bookDownloaded",downloadedOptions:{book:r,open:e.open},apply:!0}),o.applyExistingBooks(a.data.currentLibrary.books),u.addBookStat({type:"download"})},1e3)})})})},500))},e.actionBtnClicked=function(t){"loading"!=k&&"denied"!=k&&("open"==k?e.open(t):"login"==k?(c.hide(),setTimeout(u.login,1e3)):"download"==k&&e.download(t),g(),m())},e["delete"]=function(t){o.toast(n.get("deletingBook")),o.vibrate(),o.deleteEbook(t,function(){g(),m(),e.$$phase||e.$apply()})},e.addToFav=function(e){i.update(n.get("addingToFavorites"),null,{dots:!0}),u.addtoFav(e,function(){e.favorite=!0,i.update()})},e.removeFav=function(e){i.update(n.get("removingFromFavorites"),null,{dots:!0}),u.removeFav(e,function(){e.favorite=!1,i.update();var t=angular.element(document.getElementById("library")).scope();t.loadFavorites()})},e.categoryClicked=function(t){c.hide(),e.modal.bookInfoOptions.categoryClicked(t)}}]),app.controller("BookSettingsCtrl",["$scope","stg","crdv","$element","nav","backend","$location","$ionicSideMenuDelegate","cssParser","modals","sync","markers","settings","$timeout",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f){e.init=function(){e.navAnims=[{label:"flip",val:"navBookBlock"},{label:"card",val:"navFlip"},{label:"slide",val:"navSlide"},{label:"fade",val:"navFade"}],e.navModes=[{label:"vertical",val:"vertical"},{label:"horizontal",val:"horizontal"}]},e.stylingChanged=function(){f(p.stylingChanged,300)},e.navAnimChanged=function(){p.saveSettings()},e.navModeChanged=function(){p.saveSettings()},e.lineAdjustChanged=function(){f(p.lineAdjustChanged,300)},e.editFontSize=function(){e.header.mode="textSize",s.toggleRight(!1),s.toggleLeft(!1)},e.langChanged=function(){s.toggleLeft(!1),s.toggleRight(!1),f(p.langChanged,500)},e.sync=function(){s.toggleRight(!1),s.toggleLeft(!1),p.sync()},e.fullscreen=function(){s.toggleRight(!1),s.toggleLeft(!1),r.fullscreen()},e.logout=function(){s.toggleRight(!1),s.toggleLeft(!1),i.logout()},e.about=function(){e.openAuthorWebsite()},e.exit=function(){l.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}]),app.controller("CatMenuCtrl",["$scope","backend","translit","$ionicScrollDelegate","$ionicModal","$timeout","stg",function(){}]),app.controller("ChaptersCtrl",["$scope","initializer","$stateParams","status","stg","nav","modals","$ionicHistory","crdv","virt","chapters","$ionicGesture","cache","$q","book","$timeout","$ionicPopup","$ionicSideMenuDelegate","$location","$ionicScrollDelegate","selection","$filter",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b,y){e.init=function(){e.putTest("ChaptersCtrl init"),e.$on("$stateChangeStart",function(e,t,n){if(0==t.name.indexOf("reader")){var o=n.ch?n.ch:0,r=n.hash?n.hash:null;d.loadChapterByIndex(Number(o),{hash:r})}}),e["native"]||e.$on("$ionicView.beforeEnter",function(){var e=!t.initialized||!config.kotobee["public"]&&!r.data.user.loggedIn;if(e){var n="loading";s.forwardView()?n=s.forwardView().stateId:s.backView()&&(n=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),b.path("/"+n)}})},e.nextChapter=function(){return d.nextChapter()},e.prevChapter=function(){return d.prevChapter()},e.isFirstChapter=function(){return d.isFirstChapter()},e.isLastChapter=function(){return d.isLastChapter()},e.pinched=function(){},e.applySelectedChapter=function(e,t){if(null==t&&(t=!0),addClass(e,"selected"),addClass(e,"currentChapter"),t){for(var n=e,o=p.getOb("chaptersContent");;){if(e=e.parentNode,!e)break;if(e==o)break;"li"==e.nodeName.toLowerCase()&&addClass(e,"expanded")}overflowScroll?o.scrollTop=Math.round(n.offsetTop):y.$getByHandle("chapters").scrollTo(0,Math.round(n.offsetTop-o.parentNode.offsetHeight/2),!1)}},e.deApplySelectedChapter=function(){for(var e=p.getOb("chaptersContent"),t=e.getElementsByClassName("selected"),n=t.length;n--;)removeClass(t[n],"selected");t=e.getElementsByClassName("currentChapter");for(var n=t.length;n--;)t[n].removeAttribute("name")},e.showBookInfo=function(){native&&c.vibrate();var e=r.data.book;e.coverImg=r.data.epub.bookThumb,e.coverStyle={"background-image":"url('"+e.coverImg+"')"},e.name=e.meta.dc.title;var t={};t.book=e,config.kotobee.cloudid&&"book"==config.kotobee.mode&&(t.book.stats=config.kotobee.stats),t.noAction=!0,a.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up",bookInfoOptions:t})}}]),app.controller("ContentCtrl",["$location","nav","virt","$sce","$filter","stg","crdv","$rootScope","$element","cache","$scope","settings","$ionicSideMenuDelegate","$http","chapters","$timeout","selection","book","$ionicScrollDelegate",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b){d.init=function(){},d.mouseDown=function(){mobile&&t.resize(),n.enable()},d.mouseUp=function(){n.disableAfter(2e3)};var y;d.scroll=function(){i.data.book&&(config.preserveLoc&&"app"!=config.kotobee.mode&&(y&&clearTimeout(y),y=setTimeout(function(){if("app"!=config.kotobee.mode){var e=b.$getByHandle("content");if(e){var t=e.getScrollPosition();t&&i.writeSlot("lastLocY"+i.getBookId(),t.top)}}},2e3)),mobile||(n.enable(),n.disableAfter(2e3)))}}]),app.controller("ForgotPwdCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,n,o,r,i,a,s,c,l,d,u,p,f,g,m){e.init=function(){t=g,mobile||i.stylize("forgotPwd",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){f.setOb("title",replaceHTML(f.getOb("title"),g.get("forgotPwd")))}),e["native"]||e.$on("$ionicView.beforeEnter",function(){var e=!n.initialized||u.cloudParam("public")||a.data.user&&a.data.user.loggedIn;if(e){var t="loading";l.forwardView()?t=l.forwardView().stateId:l.backView()&&(t=l.backView().stateId),l.nextViewOptions({disableAnimate:!0}),s.path("/"+t)}})},e.showMenu=function(){var e=[{name:g.get("exit"),func:function(){o.hide(),c.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){r.exit()}}})}}];o.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){e.user&&e.user.email&&u.forgotPwd(e.user,function(e){return e.error?void d.update({error:"s_authError"==e.error?"accessDenied":e.error}):(c.show({mode:"success",successOptions:{msg:g.get("pwdEmailSent")}}),void m.history.back())})},e.backClicked=function(){m.history.back()}}]),app.controller("GlobalCtrl",["cache","modals","popovers","crdv","$http","$rootScope","initializer","translit","error","$sce","design","settings","status","tinCan","$scope","backend","stg","$location",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v){g.putTest=function(e){return},g.init=function(){g.putTest("Global init"),g.mobile=mobile,g["native"]=native,g.desktop=desktop,g.ios=ios,g.preview=preview,g.config=config,g.putTest("Global init good")},g.start=function(){g.putTest("Global Start"),g.putTest("TO HOME!"),i.data=h.data,g.cloudParam=m.cloudParam,t.setScope(g),n.setScope(g),g.started=!0,g.putTest("A!"),setTimeout(function(){g.putTest("timeout postInitialize"),a.postInitialize(g)},700),g.$$phase||g.$apply()},g.tinCanShortcut=function(e){f.send(e)},g.location=function(e){v.path(e)},g.kTemplate=function(e){return kTemplate(e)},g.translit=function(e){return s.get(e)},g.htmlSafe=function(e){return l.trustAsHtml(e)},g.openAuthorWebsite=function(){var e=h.data.settings.language;"en"!=e&&"es"!=e&&"ar"!=e&&"fr"!=e&&(e="en"),window.open("https://www.kotobee.com/"+e+"/products/author","_system")},g.testModals=function(){t.show({mode:"loading",loadingMsg:s.get("pleaseWait")});t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"login",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"update",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"generalError"}),t.show({mode:"loading",loadingMsg:s.get("pleaseWait"),backdropClickToClose:!0}),t.show({mode:"note",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"hlight"}),t.show({mode:"externalSite",dynamic:!0,animation:"slide-in-up",backdropClickToClose:!0}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"flashUnsupported",flashOb:{text:"Text for flash unsupported site"}}),t.show({mode:"success",successOptions:{msg:"SUCCESS MSG"}}),t.show({mode:"localOnlyError"}),t.show({mode:"xFrameError"}),t.show({mode:"networkError"}),t.show({mode:"exit"}),t.show({mode:"waitTimeout"}),t.show({mode:"backToLib"}),t.show({mode:"notebook",dynamic:!0,animation:"slide-in-up",scope:{notebookClose:t.hide}}),t.show({mode:"search",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"image",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up"}),t.show({mode:"encryptionKey",backdropClickToClose:!0});
t.show({mode:"loading",loadingMsg:s.get("pleaseWait"),timeLimit:3e3});return}}]),app.controller("HomeCtrl",["$scope","design","initializer","$timeout","$ionicHistory","$location",function(e,t,n,o,r,i){e.init=function(){e.putTest("HomeCtrl!");var t=n.getLogo();e.$parent.logo=t.logo,e.$parent.slogan=t.slogan;var o=document.getElementById("home").getElementsByClassName("logo")[0],a=o.getElementsByTagName("img")[0],s=o.style.backgroundImage;if(!s){var c="";c+=config.hideLogo?"display:none":"background-image:url('"+t.logo+"');",o.style.cssText=c,e.putTest("HomeCtrl1")}a.onload=function(){if(!s){var e=window,t=document,n=t.documentElement,r=t.getElementsByTagName("body")[0],i=e.screen.width||e.innerWidth||n.clientWidth||r.clientWidth,l=e.screen.height||e.innerHeight||n.clientHeight||r.clientHeight,d={};d.width=i-80,d.height=.5*l-40,c+="opacity:1;",c+=d.height<a.height||d.width<a.width?"background-size:contain;":"background-size:auto;",o.style.cssText=c}},e.putTest("HomeCtrl2"),n.initialized||n.preInitialize(e),e.putTest("k"),e["native"]||(e.putTest("k2"),e.$on("$ionicView.beforeEnter",function(){e.putTest("be4 enter"),n.initialized&&(e.putTest("obbaa"),r.forwardView()&&(e.putTest("yup"),r.nextViewOptions({disableAnimate:!0}),i.path("/"+r.forwardView().stateId)))}))},e.injectUserCSS=function(e){t.injectUserCSS(e)}}]),app.controller("LibraryCtrl",["$scope","error","$sce","$location","$ionicPlatform","$rootScope","$element","$ionicHistory","auth","modals","popovers","translit","library","chapters","status","book","$timeout","$ionicPopup","$ionicModal","$ionicScrollDelegate","backend","crdv","$filter","stg","settings",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b,y,k,w,C,T,E){function x(){if(p.initialize(),p.addListener(S),e.initialized=!0,T.data.user.loggedIn&&("account"!=T.data.currentLibrary.authbookview||k.cloudParam("public")||(e.supportsAccountView=!0)),0==o.path().indexOf("/library/tab/downloads"))e.downloadedClicked();else if(e.supportsAccountView)I("account"),h(function(){B({account:!0})});else{if(I("all"),!k.cloudParam("public")&&"hide"==T.data.currentLibrary.authbookview&&!T.data.user.loggedIn)return e.paneMsg="noEbooksAvailable",void A();h(B)}}function S(){var t,n=arguments[0];if("preload"==n){var o=arguments[1];o.accumulated||(t=!0),mobile||(t=!0),e.paneMsg=null,t&&$()}if("postload"==n){var o=arguments[1],r=arguments[2];t=!1,e.stopInfiniteScroll(),L=!1,e.stopRefresher(),e.moreData=r.length>=p.maxResults}}function I(t){e.tab=t,mobile?y.$getByHandle("thumbs").scrollTop(!1):document.getElementById("libraryThumbs").scrollTop=0}function B(t){t||(t={}),e.paneMsg=null,M&&(t.catid=M.id),O&&(t.key=O),p.getEbooks(t,function(t){("all"==e.tab||"account"==e.tab)&&(t.empty&&(e.paneMsg="noEbooksAvailable"),A())})}function A(){addClass(document.getElementById("libLoaderAnim"),"hide")}function $(){removeClass(document.getElementById("libLoaderAnim"),"hide")}function N(){H&&H(),H=r.registerBackButtonAction(function(){e.searchOb.enabled?e.disableSearch():M?e.back():O&&e.back(),e.$apply()},102)}var L,O,M,H;e.initialized=!1,e.init=function(){k.setLibraryLoginCallback(function(){x()}),k.setLibraryLogoutCallback(function(){e.supportsAccountView&&"all"!=e.tab&&(I("all"),h(B)),e.supportsAccountView=!1,A()}),e.sortOb={},e.sortOb.options=[{name:"titleA-Z",data:"name",dir:"asc"},{name:"titleZ-A",data:"name",dir:"desc"},{name:"dateAddedOldestFirst",data:"date",dir:"asc"},{name:"dateAddedNewestFirst",data:"date",dir:"desc"},{name:"none",data:"none"}],e.sortOb.method=e.sortOb.options[3],p.sortMethod=e.sortOb.method;var t;e.$on("$ionicView.beforeEnter",function(n,r){if(t=null,!(e["native"]||c.authenticated&&"library"==config.kotobee.mode)){var i="loading";s.forwardView()?i=s.forwardView().stateId:s.backView()&&(i=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),o.path("/"+i)}s.forwardView()&&(t=s.forwardView().stateId),s.backView()&&(t=s.backView().stateId),"forward"==r.direction&&(T.data.currentLibrary.books=[],T.data.favorites=[])}),e.$on("$ionicView.afterEnter",function(e,t){return"back"==t.direction?(A(),void p.setBrowserTitle()):void(k.cloudParam("entry")?k.getUnauthLibrary(function(){k.login().then(function(e){e.error&&x()})}):k.cloudParam("public")?k.getUnauthLibrary(x):x())})},e.userLogin=function(){e.data.user.loggedIn?k.logout():t.update({error:"s_authError"})},e.langSelected=function(t){e.langDropdownExpanded=!1,T.data.settings.language=t,E.langChanged()},e.showLibraryMenu=function(){d.show({mode:"libraryMenu",menuItem:e.menuItemClicked,backdropClickToClose:!1})},e.scroll=function(t){var n=t.scrollTop/(document.getElementById("libraryThumbsContent").offsetHeight-t.offsetHeight);if(n>.8){if(L)return;if(!e.moreDataExists())return;L=!0,e.loadMore()}},e.bookClicked=function(t){e.book,native&&w.vibrate(),t.coverImg=C("coverPath")(t.cover,t.path),t.coverStyle={"background-image":"url('"+t.coverImg+"')"};var n={};for(var o in t.meta)n[o]=t.meta[o];t.meta.dc=n;var r={};r.book=t,r.categoryClicked=e.categoryClicked,l.show({mode:"bookInfo",dynamic:!0,animation:"slide-in-up",bookInfoOptions:r})},e.refresherExists=function(){try{if(!T.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;if("favorites"==e.tab)return!0;if("account"==e.tab)return!0;if("all"==e.tab)return!0}catch(t){return!1}return!0},e.doRefresh=function(){var t={accumulated:!0};"all"==e.tab?B(t):"account"==e.tab?(t.account=!0,B(t)):"favorites"==e.tab?e.loadFavorites(t):e.stopRefresher()},e.sort=function(){p.sortMethod=e.sortOb.method,"downloaded"==e.tab?C("orderBy")(e.data.downloaded,e.sortOb.method.data):"account"==e.tab?B({account:!0}):B()},e.menuItemClicked=function(n){"language"==n&&E.langChanged(),"info"==n&&(d.hide(),l.show({mode:"libraryInfo",dynamic:!0,animation:"slide-in-up",libraryInfo:T.data.currentLibrary.libraryinfo})),"logout"==n&&(d.hide(),e.data.user.pwd||e.data.user.code?k.logout():t.update({error:"s_authError"})),"exit"==n&&(d.hide(),l.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){w.exit()}}}))},e.loadFavorites=function(t){t||(t={}),e.paneMsg=null,M&&(t.catid=M.id),O&&(t.key=O),t.favs=!0,p.getEbooks(t,function(t){"favorites"==e.tab&&(t.error&&(e.paneMsg="failedToGetFavs"),0==t.length&&(e.paneMsg="noFavsAvailable"),A())})},e.searchEbooks=function(t){e.subMode="search",e.title="searchResults",O=p.currentKey=t,M=p.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(I("account"),h(function(){B({account:!0})})):(I("all"),h(B)),N()},e.enableSearch=function(){e.searchOb.enabled=!0,N()},e.disableSearch=function(){e.searchOb.enabled=!1,H&&H()},e.loadMore=function(){var t={more:!0,accumulated:!0};"all"==e.tab?B(t):"account"==e.tab?(t.account=!0,B(t)):"favorites"==e.tab?e.loadFavorites(t):(e.stopInfiniteScroll(),L=!0)},e.stopInfiniteScroll=function(){i.$broadcast("scroll.infiniteScrollComplete")},e.stopRefresher=function(){i.$broadcast("scroll.refreshComplete")},e.moreDataExists=function(){try{if(!T.data.currentLibrary)return!1;if("categories"==e.tab)return!1;if("downloaded"==e.tab)return!1;var t;if("favorites"==e.tab&&(t=e.data.favorites),"all"==e.tab&&(t=T.data.currentLibrary.books),"account"==e.tab&&(t=T.data.currentLibrary.books),0==t.length)return!1}catch(n){return!1}return e.moreData},e.back=function(){e.subMode=!1,e.title=null,O=p.currentKey=null,M=p.currentCat=null,e.supportsAccountView&&"all"!=e.tab?(I("account"),h(function(){B({account:!0})})):(I("all"),h(B)),H&&H()},e.categoryClicked=function(t){native&&w.vibrate();var n={};M=p.currentCat=t,O=p.currentKey=null,n.catid=M.id,e.subMode="category",e.title=M.name,e.supportsAccountView?(I("account"),h(function(){B({account:!0})})):(I("all"),h(B)),N()},e.categoriesClicked=function(){native&&w.vibrate(),I("categories"),e.paneMsg=null,A()},e.accountClicked=function(){native&&w.vibrate(),I("account"),A(),h(function(){B({account:!0})})},e.allClicked=function(){native&&w.vibrate(),I("all"),h(B)},e.downloadedClicked=function(){native&&w.vibrate(),I("downloaded"),e.paneMsg=null,0==T.data.downloaded.length&&(e.paneMsg="noEbooksDownloaded"),A()},e.favoritesClicked=function(){native&&w.vibrate(),I("favorites"),e.loadFavorites()}}]),app.controller("LoginCtrl",["$scope","initializer","crdv","$ionicHistory","popovers","design","modals","error","backend","auth","stg","cache","translit","$location",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f){e.model={},e.init=function(){mobile||i.stylize("login",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),p.get("login")))}),e["native"]||e.$on("$ionicView.beforeEnter",function(){var e=!t.initialized||config.kotobee["public"]||d.data.user.loggedIn;if(e){var n="loading";o.forwardView()?n=o.forwardView().stateId:o.backView()&&(n=o.backView().stateId),o.nextViewOptions({disableAnimate:!0}),f.path("/"+n)}})},e.showMenu=function(){var e=[{name:p.get("exit"),func:function(){r.hide(),a.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){n.exit()}}})}}];r.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.login=function(){return d.data.user.email?e.model.pwd?(d.data.user.pwd=e.model.pwd,d.data.user.code=null,void c.login({dontShowErrorDialog:!0,userInput:!0}).then(function(t){return t.error?void s.update({error:"s_authError"==t.error?"accessDenied":t.error}):(e.model.pwd=null,void l.startup())})):void s.update({error:"enterYourPwd"}):void s.update({error:"enterYourEmail"})},e.register=function(){a.hide(),f.path("/register")},e.forgotPassword=function(){f.path("/forgotpwd")},e.redeemCode=function(){f.path("/redeemcode")}}]),app.controller("MediaCtrl",["$ionicScrollDelegate","media","$ionicModal","$location","$rootScope","$scope","selection","crdv","stg","$ionicLoading",function(e,t,n,o,r,i){i.init=function(){},i.mediaClicked=function(e){t.show(e)},i.hide=function(){t.hide()}}]),app.controller("ReaderCtrl",["$ionicScrollDelegate","modals","library","$sce","$location","$rootScope","$scope","selection","$ionicSideMenuDelegate","$state","$ionicPopover","chapters","book","$timeout","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g){a.init=function(){a.mode="reading"},a.chapterClicked=function(){g.data.settings.rtl?c.toggleRight():c.toggleLeft()},a.backClicked=function(){c.isOpenLeft()||t.show({mode:"backToLib",backdropClickToClose:!1,backToLibOptions:{back:function(){t.hide(),u.clearContent(),setTimeout(n.setBrowserTitle,600),setTimeout(g.resetBook,600),r.path("/library")}}})},a.searchClicked=function(){a.applyHeader("search")},a.menuClicked=function(){},a.setting1Clicked=function(){},a.setting2Clicked=function(){},a.setting3Clicked=function(){},a.linkClicked=function(){}}]),app.controller("RedeemCodeCtrl",["$scope","initializer","popovers","crdv","design","stg","$location","modals","$ionicHistory","error","backend","auth","cache","translit","$window",function(e,n,o,r,i,a,s,c,l,d,u,p,f,g,m){e.init=function(){t=g,mobile||i.stylize("redeemCode",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){f.setOb("title",replaceHTML(f.getOb("title"),g.get("redeemCode")))}),e["native"]||e.$on("$ionicView.beforeEnter",function(){var e=!n.initialized||u.cloudParam("public")||a.data.user&&a.data.user.loggedIn;if(e){var t="loading";l.forwardView()?t=l.forwardView().stateId:l.backView()&&(t=l.backView().stateId),l.nextViewOptions({disableAnimate:!0}),s.path("/"+t)}})},e.showMenu=function(){var e=[{name:g.get("exit"),func:function(){o.hide(),c.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){r.exit()}}})}}];o.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.submit=function(){e.user&&e.user.code&&(a.data.user.code=e.user.code,a.data.user.email=a.data.user.pwd=null,u.cloudParam("entry")?(m.history.back(),u.login()):u.login().then(function(e){return e.error?void d.update({error:"s_authError"==e.error?"accessDenied":e.error}):void p.startup()}))},e.backClicked=function(){m.history.back()}}]),app.controller("RegisterCtrl",["$scope","initializer","popovers","crdv","modals","design","stg","$ionicHistory","$location","translit","backend","backend","translit","cache","error","$window",function(e,t,n,o,r,i,a,s,c,l,d,d,l,u,p,f){function g(){var t=e.user;if(-1==t.email1.indexOf("@"))return p.update({error:"emailFormatError"}),!1;var n=/^([\w-]+(?:\.[\w-]+)*)@((?:[\w-]+\.)*\w[\w-]{0,66})\.([a-z]{2,6}(?:\.[a-z]{2})?)$/i;return n.test(t.email1)?t.email1!=t.email2?(p.update({error:"emailsDontMatch"}),!1):!0:(p.update({error:"emailFormatError"}),!1)}e.init=function(){e.user={email1:"",email2:""},mobile||i.stylize("register",i.getBgStyle()),e.$on("$ionicView.afterEnter",function(){u.setOb("title",replaceHTML(u.getOb("title"),l.get("register")))}),e["native"]||e.$on("$ionicView.beforeEnter",function(){var e=!t.initialized||config.kotobee["public"]||a.data.user.loggedIn;if(e){var n="loading";s.forwardView()?n=s.forwardView().stateId:s.backView()&&(n=s.backView().stateId),s.nextViewOptions({disableAnimate:!0}),c.path("/"+n)}})},e.showMenu=function(){var e=[{name:l.get("exit"),func:function(){n.hide(),r.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){o.exit()}}})}}];n.show({mode:"cornerList",listOb:e,backdropClickToClose:!1})},e.create=function(){g()&&d.register(e.user,function(e){if(e.error)return void p.update(e);var t="d_accountCreated";e.success&&e.success.approvalRequired&&(t="d_accountCreatedApprovalRequired"),r.show({mode:"success",successOptions:{msg:l.get(t)}}),f.history.back()})},e.backClicked=function(){f.history.back()}}]),app.controller("RendererCtrl",["$rootScope","$ionicHistory","modals","nav","backend","library","settings","auth","status","popovers","$sce","error","translit","cache","$ionicPlatform","bookmarks","hlights","notes","$ionicSideMenuDelegate","$scope","$ionicScrollDelegate","$filter","chapters","$ionicPopup","$location","$timeout","selection","crdv","$ionicLoading","stg","search","$ionicModal",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b,y,k,w,C,T,E,x,S,I,B,A,$){y.init=function(){e.renderScope=y,S.listener=y.selection,y.searchContent={},y.sideMenuMode="bookSettings";var r=g.registerBackButtonAction(function(){kInteractive.frameIsOpen?kInteractive.closeFrame():kInteractive.alertIsOpen?kInteractive.closeAlert():kInteractive.videoIsFullscreen?kInteractive.closeFullscreenVideo():"default"!=y.header.mode?"selection"==y.header.mode?S.reset():y.applyHeader("default"):A.data.book.chapter.viewport&&o.getFxlScale()!=o.getFxlBestFit()?o.fxlZoomFit():"library"==config.kotobee.mode?E.path("/library"):e.readerApp?E.path("/app"):n.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){I.exit()}}}),y.$apply()},103);if(y.$on("$destroy",r),!desktop&&!chromeApp&&ZeroClipboard){ZeroClipboard.config({trustedDomains:["*"],trustedOrigins:["*"]});var i=new ZeroClipboard(document.getElementById("copyBtn"));i.on("ready",function(){i.on("aftercopy",function(e){e.target.style.display="none",c.showAndHide(p.get("copiedToClipboard"),500)})}),i.on("error",function(){noFlash=!0})}y["native"]||y.$on("$ionicView.beforeEnter",function(){if(!s.authenticated){var e="loading";t.forwardView()?e=t.forwardView().stateId:t.backView()&&(e=t.backView().stateId),t.nextViewOptions({disableAnimate:!0}),E.path("/"+e)}})},y.setSideMenuMode=function(e){y.sideMenuMode=e},y.applyHeader=function(e){try{y.header.mode=e}catch(t){}},y.header={mode:"default"},y.selection=function(e){mobile?"activated"==e||"selectionFixed"==e?y.applyHeader("selection"):"deactivated"==e&&y.applyHeader("default"):"selectionFixed"==e?(addClass(document.getElementById("selectionOptions"),"showBar"),document.getElementById("copyBtn").setAttribute("data-clipboard-text",S.getSelectedText())):"deactivated"==e&&removeClass(document.getElementById("selectionOptions"),"showBar")},y.contentLink=function(e){C.applyChapterStateFromURL(e.getAttribute("href"))},y.chapterLink=function(e){if(e.parentElement.getElementsByTagName("ol").length>0){var t=e.offsetHeight+20;if(overflowScroll||k.$getByHandle("chapters").scrollBy(0,t,!0),!e.getAttribute("href")||e.getAttribute("data-dontshow"))return void(hasClass(e.parentElement,"expanded")?removeClass(e.parentElement,"expanded"):addClass(e.parentElement,"expanded"));addClass(e.parentElement,"expanded")}b.toggleLeft(!1),b.toggleRight(!1),timeOut(function(){y.deApplySelectedChapter(),y.applySelectedChapter(e.parentNode,!1),C.applyChapterStateFromURL(e.getAttribute("href")),y.$$phase||y.$apply()},250)},y.targetCurrentChapter=function(){mobile&&o.resize();var e=S.getIdArray(),t=A.data.book.chapter.url;y.deApplySelectedChapter();for(var n=f.getOb("chaptersContentAnchors"),r=document.getElementById("chaptersContent"),n=r.getElementsByTagName("a"),i=[],a=0;a<n.length;a++)-1!=n[a].getAttribute("href").indexOf(t)&&i.push({elem:n[a],id:ph.getHash(n[a].getAttribute("href"))});e.push(void 0);for(var s=0;s<e.length;s++)for(var a=0;a<i.length;a++)if(e[s]==i[a].id)return void y.applySelectedChapter(i[a].elem.parentNode)},y.externalLink=function(e){var t=e.getAttribute("href");return void r.externalLink(t)},y.bookmarkClicked=function(){m.addBookmark()},y.noteClicked=function(e,t){v.noteClicked(e,t)},y.search=function(e,t,o,r){if(e&&e.length&&0!=e.length){if(e.length<3)return u.update({error:"lessThan3Characters"}),void n.hide();y.applyHeader("default"),void 0==o&&(y.searchStack=[0]),c.update(p.get("searching"),null,{dots:!0,timeoutDuration:6e4}),t||(t="all",o||(o=0));var i={key:e,mode:t,limit:40,start:o,array:r};x(function(){$.start(i,function(e){c.update(null),y.searchContent=e;for(var n=0;n<y.searchContent.results.length;n++)if(y.searchContent.results[n]&&y.searchContent.results[n].matches.length){y.searchContent.notEmpty=!0;break}"all"==t?(y.$broadcast("scroll.infiniteScrollComplete"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:k.$getByHandle("searchScroll").scrollTop()):"chapter"==t&&x(function(){y.applyHeader("searchItems")},500)})},500)}},y.searchMore=function(){for(var e,t=y.searchContent.results.length;t--;)if(y.searchContent.results[t]&&y.searchContent.results[t].matches[0]){e=y.searchContent.results[t].matches[0];break}return e?(y.searchStack.push(e.chapter+1),overflowScroll?document.getElementById("searchScroll").scrollTop=0:k.$getByHandle("searchScroll").scrollTop(),void y.search(y.searchContent.key,"all",e.chapter+1)):void(y.searchContent.more=!1)},y.searchBack=function(){if(!(y.searchStack.length<=1)){y.searchStack.pop();var e=y.searchStack.pop();overflowScroll?document.getElementById("searchScroll").scrollTop=0:k.$getByHandle("searchScroll").scrollTop(),y.search(y.searchContent.key,"all",e)}},y.locateInChapter=function(e){n.hide(),y.search(e,"chapter")},y.clearResults=function(){y.searchContent={},y.applyHeader("default"),overflowScroll?document.getElementById("searchScroll").scrollTop=0:k.$getByHandle("searchScroll").scrollTop()},y.searchItemClickedOld=function(e){{var t=e.item;e.index,e.matches}n.hide(),timeOut(function(){function e(){C.removeListener(e);var n=S.getElemsByLocation(t.location)[0];timeOut(function(){addClass(n,"searchItemHighlightFade"),timeOut(function(){removeClass(n,"searchItemHighlightFade")},2200)},1200)}C.addListener(e),E.path("/reader/chapter/"+t.chapter+"/"+t.location)},300)},y.searchItemClicked=function(e){var t=e.item,o=e.index,r=e.matches;n.hide(),timeOut(function(){function e(){C.removeListener(e),r.index=o,y.applyHeader("searchItems")}C.addListener(e),E.path("/reader/chapter/"+t.chapter+"/"+t.location)},300)},y.fxlZoomIn=function(e){o.fxlZoomIn(e)},y.fxlZoomOut=function(e){o.fxlZoomOut(e)},y.fxlZoomFit=function(e){o.fxlZoomFit(e)}}]),app.controller("SearchItemsCtrl",["$ionicScrollDelegate","cache","$ionicModal","$location","virt","$rootScope","$scope","selection",function(e,t,n,o,r,i,a,s){a.index=0,a.init=function(){a.index=0,a.titleMode=3,a.results=[];var e=a.searchContent.results[currentIndex];e&&(a.results=e.matches),a.results.index&&(a.index=a.results.index),0==a.results.length?a.titleMode="empty":a.highlightCurrentItem(),a.$on("$destroy",function(){a.removeHighlights()})},a.backClicked=function(){a.applyHeader("default")},a.up=function(){0==a.index&&(a.index=a.results.length),a.index--,a.highlightCurrentItem()},a.down=function(){a.index==a.results.length-1&&(a.index=-1),a.index++,a.highlightCurrentItem()},a.removeHighlights=function(){for(var e=document.getElementsByClassName("searchItemHighlight"),t=e.length;t--;)removeClass(e[t],"searchItemHighlight")},a.highlightCurrentItem=function(){if(a.results){a.removeHighlights();var e=a.results[a.index].location,t=s.getElemsByLocation(e);if(!t[0].offsetParent)return void(a.titleMode="hidden");a.titleMode="title",addClass(t[0],"searchItemHighlight"),r.safeScrollToElem("content",t[0],!0)}}}]),app.controller("SelectionCtrl",["$ionicScrollDelegate","translit","error","status","modals","notes","$window","$location","$sce","$rootScope","backend","hlights","$scope","selection","crdv","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m){p.tts=function(){if(config.tts){var e=f.getSelectedText();if(e){if(desktop)return void n.update({error:"speechUnsupportedInDesktop"});if(preview)return void n.update({error:"speechUnsupportedInPreview"});if(native&&"undefined"!=typeof TTS)g.tts(e,function(){});else try{if("speechSynthesis"in window&&SpeechSynthesisUtterance){o.showAndHide(t.get("preparingVoice"),600,{dots:!0}),window.speechSynthesis.cancel();var r=new SpeechSynthesisUtterance,i=window.speechSynthesis.getVoices();if(r.lang=config.defaultTtsLanguage?config.defaultTtsLanguage:"en-US",r.voice=i.filter(function(e){return e.lang==r.lang})[0],!r.voice)return;r.text=e,window.speechSynthesis.speak(r)}else n.update({error:"speechUnsupported"})}catch(a){n.update({error:"speechUnsupported"})}}}},p.copy=function(){if(config.clipboardCopy){var e=f.getSelectedText();if(e)if(native)g.copyToClipboard(e);else if(desktop){var n=require("nw.gui"),i=n.Clipboard.get();i.set(e,"text"),o.showAndHide(t.get("copiedToClipboard"),500)}else if(chromeApp){var a=document.createElement("textarea");document.body.appendChild(a),a.value=e,a.focus(),a.select(),document.execCommand("Copy"),a.remove(),o.showAndHide(t.get("copiedToClipboard"),500)}else noFlash&&(r.show({mode:"flashUnsupported",flashOb:{text:e}}),setTimeout(function(){document.getElementById("clipboardText").focus(),document.getElementById("clipboardText").select()},200))}},p.share=function(){if(config.share){var e=f.getSelectedText();e&&g.share(e)}},p.note=function(e){if(config.annotations){var t={};t.type="content",t.location=f.getLocation(),t.src=f.getSelectedText(),t.event=e,i.noteClicked(t,function(){f.reset()})}},p.highlight=function(){function e(){u.showPopup(t,function(){f.reset()})}if(config.annotations){var t={};t.location=f.getLocation();for(var n=f.getSelectedNodes(),o=0;o<n.length;o++)if(hasClass(n[o],"contentHlightBG")){var r=getClassThatStartsWith(n[o],"hlight");return t.hid=r.substr(6),void m.getHlightById(t.hid,function(n){t.color=n.color,e()})}e()}},p.google=function(){if(config.googleLookup){var e=f.getSelectedText();if(e)try{var t="http://www.google.com/custom?q="+e;return void d.externalLink(t,{secure:!0})}catch(n){}}},p.backClicked=function(){f.reset()}}]),app.controller("SelectionOptionsCtrl",["$scope","$http","stg","$ionicScrollDelegate","$ionicPopup","$timeout","selection",function(e,t,n,o,r,i,a){e.init=function(){},e.expand=function(){a.expand()},e.extendRight=function(){a.extendRight()},e.extendLeft=function(){a.extendLeft()}}]),app.controller("TabMenuCtrl",["$scope","cache","modals","nav","settings","book","$ionicSideMenuDelegate","$stateParams","$location","$sce","$ionicScrollDelegate","chapters","virt","translit","$ionicModal","hlights","$timeout","$filter","stg","crdv","selection",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b,y,k){e.init=function(){e.$watch(function(){return a.isOpenRight()},function(t){t||h(function(){e.setSideMenuMode("bookSettings")},100)})},e.chaptersClicked=function(){mobile&&o.resize(),b.data.settings.rtl?a.toggleRight():a.toggleLeft(),native&&y.vibrate()},e.mediaClicked=function(){if(b.data.settings.rtl){if(a.isOpenLeft()&&"media"!=e.sideMenuMode)return a.toggleLeft(),void h(e.mediaClicked,300)}else if(a.isOpenRight()&&"media"!=e.sideMenuMode)return a.toggleRight(),void h(e.mediaClicked,300);native&&y.vibrate(),e.setSideMenuMode("media"),mobile&&o.resize(),b.data.settings.rtl?a.toggleLeft():a.toggleRight()},e.notebookClicked=function(){native&&y.vibrate(),e.createNotebookArray(function(){overflowScroll||o.resize(),n.show({mode:"notebook",dynamic:!0,scope:e,animation:"slide-in-up",cb:function(){overflowScroll?document.getElementById("notebookContent").scrollTop=0:d.$getByHandle("notebookScroll").scrollTop()}})})},e.settingsClicked=function(){if(b.data.settings.rtl){if(a.isOpenLeft()&&"bookSettings"!=e.sideMenuMode)return a.toggleLeft(),void h(e.settingsClicked,300)}else if(a.isOpenRight()&&"bookSettings"!=e.sideMenuMode)return a.toggleRight(),void h(e.settingsClicked,300);native&&y.vibrate(),e.setSideMenuMode("bookSettings"),mobile&&o.resize(),b.data.settings.rtl?a.toggleLeft():a.toggleRight()},e.searchClicked=function(){native&&y.vibrate(),mobile&&o.resize(),n.show({mode:"search",dynamic:!0,animation:"slide-in-up",scope:e,cb:function(){e.searchContent.notEmpty||h(function(){y.showKeyboard()},200)}})},e.createNotebookArray=function(t){var n=new Array;b.getBookmarks(function(o){for(var r=0;r<o.length;r++){var a=o[r];n[a.chapter]||(n[a.chapter]=new Array),n[a.chapter].push(a)}b.getNotes(function(o){for(var r=0;r<o.length;r++){var a=o[r];n[a.chapter]||(n[a.chapter]=new Array),a.noteTrusted=l.trustAsHtml(a.note.replace(new RegExp("\r?\n","g"),"<br />")),n[a.chapter].push(a)}b.getHlights(function(o){for(var r=0;r<o.length;r++){var a=o[r];n[a.chapter]||(n[a.chapter]=new Array),n[a.chapter].push(a)}for(var a in n)n[a].title=i.getTitleByIndex(a);for(var r=0;r<n.length;r++)if(n[r])for(var s=0;s<n[r].length;s++){var c=n[r][s].location.split(",");n[r][s].locationDec=Number("0."+c[0].split(".").join(""))}e.notebookContent={results:n},t&&t()})})})},e.serializeNotebookTxt=function(){for(var t="\n",n=f.get("notebookFor")+' "'+e.data.book.meta.dc.title+'"'+t,o=n.length;o--;)n+="#";n+=t+t;for(var r=e.notebookContent.results,i=0;i<r.length;i++)if(r[i]){var a=f.get("chapter")+" "+(i+1);n+=a+t;for(var o=a.length;o--;)n+="_";n+=t+t;for(var s="........................",c=0;c<r[i].length;c++){var l=r[i][c];null!=l.nid?"page"==l.type?n+=f.get("pageNote")+": "+l.note+t:"content"==l.type&&(n+=f.get("noteFor")+' "'+l.src+'"'+t,n+=f.get("note")+": "+l.note+t):null!=l.hid?(n+=f.get("highlightFor")+' "'+l.src+'"'+t,n+=f.get("highlightColor")+" "+l.color+t):null!=l.bmid&&(n+=f.get("contentBookmark")+t),n+=s+t+t}}return n},e.serializeNotebookHtml=function(){function t(e,t,n){for(var o="",r=0;r<e.length;r++){var i=e[r],a=/^[\u0000-\u007f]*$/.test(i);if(a)o+=a?i:"<em>Non-unicode text</em>";else for(var s=0;s<i.length;s++){var a=/^[\u0000-\u007f]*$/.test(i[s]);o+=a?i[s]:"?"}}return"<"+t+(n?" "+n:"")+">"+o+"</"+t+">"}var n="<br/>",o="<html><body>";o+=t([f.get("notebookFor"),' "'+e.data.book.meta.dc.title+'"'],"h1"),o+=n+n;for(var r=e.notebookContent.results,i=0;i<r.length;i++)if(r[i]){var a="",s=t([f.get("chapter")+" "+(i+1)],"h2");a+=s+n;var c="..................................................................................";a+=t([c+c],"p");for(var l=0;l<r[i].length;l++){var d=r[i][l],u="";null!=d.nid?"page"==d.type?u+=t([f.get("pageNote")+": ",d.note],"p")+n:"content"==d.type&&(u+=t([f.get("noteFor"),' "'+d.src+'"'],"p")+n,u+=t([f.get("note")+": ",d.note],"p")+n):null!=d.hid?(u+=t([f.get("highlightFor"),' "'+d.src+'"'],"p")+n,u+=t([f.get("highlightColor")+": "+d.color+n],"p",'style="background-color:'+d.color+'"')):null!=d.bmid&&(u+=t([f.get("contentBookmark")],"p")+n),a+=t([u],"p")}o+=t([a],"p",'style="border:solid 3px #000;background-color:#ddd"')}return o+="</body></html>"},e.shareNotebook=function(){var t=e.serializeNotebookTxt();y.share(t)},e.pdfExport=function(){var t=e.serializeNotebookHtml(),n=(e.data.book.meta.dc.title?e.data.book.meta.dc.title:f.get("book"))+".pdf";h(function(){y.createPDF(t,n,function(){})},500)},e.deleteFromNotebookContent=function(t,n){for(var o=e.notebookContent.results,r=0;r<o.length;r++)if(o[r])for(var i=0;i<o[r].length;i++)if(o[r][i][t]==n)return void o[r].splice(i,1)},e.notebookClose=function(){n.hide(),e.bookmarkContent=null,e.noteContent=null,e.hlightContent=null,e.notebook={}},e.settingsClose=function(){n.hide(),b.writeSlot("settings"+b.getBookId(!0),e.data.settings)},e.noteBtnClicked=function(e,t){"all"==e?t.notes=t.bookmarks=t.hlights=!(t.notes&&t.bookmarks&&t.hlights):(t.notes=t.bookmarks=t.hlights=!1,t[e]=!0),overflowScroll?document.getElementById("notebookContent").scrollTop=0:d.$getByHandle("notebookScroll").scrollTop()},e.noteItemClicked=function(e){var t=e.chapter,o=e.location;n.hide(),h(function(){t==s.ch&&o==s.hash?u.loadChapterByIndex(t,{hash:o}):c.path("/reader/chapter/"+t+"/"+o)},100)},e.deleteBookmark=function(t,n){b.deleteBookmark(t,null,function(n){e.bookmarkContent=n,k.deleteBookMarker(t),e.deleteFromNotebookContent("bmid",t)}),n.stopPropagation()},e.deleteNote=function(t,n){b.deleteNote(t,null,function(n){e.noteContent=n,k.deleteNoteMarker(t),e.deleteFromNotebookContent("nid",t);for(var o=document.getElementsByClassName("note"+t),r=o.length;r--;)r==o.length-1&&(removeClass(o[r],"last"),o[r].removeAttribute("nloc"),o[r].removeAttribute("ncontent")),removeClass(o[r],"contentNoteBG"),removeClass(o[r],"note"+t)}),n.stopPropagation()},e.deleteHlight=function(t,n){m["delete"](t,null,function(o){e.hlightContent=o,e.deleteFromNotebookContent("hid",t),n.stopPropagation()})}}]),app.controller("TextSizeCtrl",["$scope","$location","cssParser","stg","settings","markers",function(e,t,n,o,r){var i=.1;e.backClicked=function(){e.applyHeader("default")},e.plus=function(){var t=r.getTextSize();t>30||(t=Math.round(10*(t+i))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize())},e.minus=function(){var t=r.getTextSize();.2>=t||(t=Math.round(10*(t-i))/10,e.data.settings.textSize=t+"em",r.updateTextSize(),r.writeTextSize())}}]),app.controller("ThumbCtrl",["$scope","$filter","$ionicModal","modals","chapters","backend","book","$location","$timeout","$ionicLoading","$ionicPopup","crdv",function(e,t){e.init=function(){e.book.coverImg=t("coverPath")(e.book.cover,e.book.path)}}]),app.filter("bookSetup",["$rootScope","stg","selection","media","chapters","cache","$ionicScrollDelegate",function(e,t,n,o,r,i){return function(){var a=document.getElementById("chaptersContent"),s=document.getElementById("epubContainer");i.setOb("epubContainer",s),i.setOb("chaptersContent",a);var c=document.getElementById("chapters");c.addEventListener("click",function(t){function n(e){for(var t=e.parentNode;t!=document.body;){if(hasClass(t,"menu")&&(hasClass(t,"menu-left")||hasClass(t,"menu-right")))return!0;t=t.parentNode}}var o=t.target;if("a"==o.nodeName.toLowerCase()){if(!n(o))return;var r=o.getAttribute("href");if(r.match(/http[s]?:/g))return;if(0==r.indexOf("/"))return;e.renderScope.chapterLink(o)}else if("i"==o.nodeName.toLowerCase()){if(!n(o))return;if(o.parentElement.getElementsByTagName("ol").length>0){o.offsetHeight+20,o.parentElement.classList.toggle("expanded")}}}),s.addEventListener(mobile&&!mobileDebug?"touchstart":"mousedown",function(e){n.active()&&n.reset();var t=e.target;if("sections"!=t.nodeName.toLowerCase()&&!hasClass(t,"k-section")){if("video"==t.nodeName.toLowerCase()||"audio"==t.nodeName.toLowerCase())return void e.stopPropagation();for(var o=t.childNodes.length;o--;)if("#text"==t.childNodes[o].nodeName&&""!=t.childNodes[o].nodeValue.replace(/\s+/g," ").trim())return void n.elementDown(t,e)}}),s.addEventListener("click",function(n){for(var i=n.target,a=i;a!=s;){if("a"==a.nodeName.toLowerCase()){if(hasClass(a,"ki-btn"))kInteractive.action(a,n);else{var c=a.getAttribute("href");if(!c)return void kInteractive.action(a,n);c.match(/http[s]?:/g)?e.renderScope.externalLink(a):0==c.indexOf("/")?window.open(c):(c=ph.join(t.data.book.chapter.url,c),r.applyChapterStateFromURL(c))
}return}a=a.parentNode}if("video"==i.nodeName.toLowerCase()||"audio"==i.nodeName.toLowerCase())return void n.stopPropagation();if("img"==i.nodeName.toLowerCase()){if(hasClass(i,"kInteractive")&&"none"!=kInteractive.readData(i).behavior)return void kInteractive.action(i,n);var l=i.parentNode;if(hasClass(l,"kInteractive")){if(hasClass(l,"widget"))return void kInteractive.action(i,n);if("none"!=kInteractive.readData(i).behavior)return void kInteractive.action(i,n)}var d=!0,u=kInteractive.readData(i);if(u?u.popup||(d=!1):d=!1,i.hasAttribute("static")&&(d=!1),i.hasAttribute("data-static")&&(d=!1),d){var p={thumbnail:i.getAttribute("src"),title:i.getAttribute("alt")};return void o.show(p)}}return hasClass(i,"ki-btn")?void kInteractive.action(i,n):hasClass(i,"kInteractive")?void kInteractive.action(i,n):void("input"==i.nodeName.toLowerCase())})}}]),app.filter("chapterHtml",function(){return function(e){if(e){for(var t=e.getElementsByTagName("li"),n=t.length;n--;){addClass(t[n],"item");var o=t[n].getElementsByTagName("ol").length?" parent":"";t[n].innerHTML='<i class="icon'+o+'"> </i> '+t[n].innerHTML}e.innerHTML=e.innerHTML.replace(/(<a.*?)(>)/g,'$1 onclick="return false;" $2')}}}),app.filter("contentHtml",["$rootScope","$filter","selection","stg",function(e,t,n,o){return function(e,t){function n(e){return e.match(/^http[s]?:/g)||0==e.indexOf("/")||0==e.indexOf("#dontparse")?void 0:!0}function r(e){if("#text"==e.nodeName){if(""==e.data.trim())return;for(var t=0,n=[0];;){if(t=e.data.indexOf(" ",t+1),-1==t)break;n.push(t)}for(var o=n.length;o--;)wrapNodeFromTo(e,"span",n[o],o<n.length-1?n[o+1]:e.data.length)}else for(var o=e.childNodes.length;o--;)r(e.childNodes[o])}function r(e){for(var t=e.childNodes.length;t--;)if("#text"==e.childNodes[t].nodeName){var n=e.childNodes[t].data;e.childNodes[t].data="{{!placemark}}";for(var o=e.innerHTML,i=n.split(" "),a=0;a<i.length;a++)i[a]="<span>"+i[a]+" </span>";n=i.join(" ");var s=o.replace("{{!placemark}}",n);e.innerHTML=XMLEscape(s)}else r(e.childNodes[t])}var i=document.createElement("div");i.setAttribute("id","epubContent"),t||(t=o.data.book.chapter.absoluteURL);for(var a=e.getElementsByTagName("body")[0],s=[],c=0;c<a.childNodes.length;c++)3==a.childNodes[c].nodeType&&s.push(a.childNodes[c]);for(var c=0;c<s.length;c++){var l=s[c],d=document.createElement("span");d.textContent=l.textContent,l.nextSibling?a.insertBefore(d,l.nextSibling):a.appendChild(d),a.removeChild(l)}kInteractive&&kInteractive.preRender(e);for(var u=getElementsByAttribute(e,"*","src"),c=0;c<u.length;c++){var p=u[c].getAttribute("src");n(p)&&u[c].setAttribute("src",ph.join(t,p)),"img"==u[c].nodeName.toLowerCase()&&(hasClass(u[c],"kInteractive")||hasClass(u[c].parentNode,"kInteractive")||u[c].style.height||u[c].getAttribute("height")||(u[c].style.maxWidth="100%"))}for(var f=getElementsByAttribute(e,"*","poster"),c=0;c<f.length;c++){var p=f[c].getAttribute("poster");n(p)&&f[c].setAttribute("poster",ph.join(t,p))}var g=document.createElement("sections"),m=e.getElementsByTagName("body")[0];if(partitionEnabled){for(var h=4e3,v=new Array,b=0;;){var y=!0,k=!1,w=0;v[b]=document.createElement("section"),v[b].setAttribute("sec",b),addClass(v[b],"k-section");for(var c=m.childNodes.length;c--;)if(!m.childNodes[c].style||"absolute"!=m.childNodes[c].style.position){if(w+=(null!=m.childNodes[c].textContent?m.childNodes[c].textContent:m.childNodes[c].data).length,!(h>w||y)){k=!0;break}y=!1,v[b].insertBefore(m.childNodes[c],v[b].firstChild)}if(!k)break;b++}for(var c=0;c<v.length;c++)g.insertBefore(v[c],g.firstChild)}else{var C=document.createElement("section");C.setAttribute("sec","0"),addClass(C,"k-section");for(var c=m.childNodes.length;c--;)C.insertBefore(m.childNodes[c],C.firstChild);g.appendChild(C)}if(m.appendChild(g),parseSecsSeparate)i.innerHTML=e.getElementsByTagName("body")[0].innerHTML;else{var T,E=1;if(1==E){T=e.getElementsByTagName("body")[0].innerHTML;var x=[],S=-1!=T.indexOf("<pre"),I=-1!=T.indexOf("<code"),B=-1!=T.indexOf("<script");S||I||B?(x.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),x.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),x.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])):(x.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),x.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),x.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])),x.push([/<([^\/][^\s>]*)([^<]*?>)(\s*[^<\s]+\s*)(<(?!\/\1))/g,"<$1$2<span>$3</span>$4"]),x.push([/(<[\/]+?[^\s>]*[^<]*?>)(\s*[^<\s]+\s*)(<)/g,"$1<span>$2</span>$3"]);for(var c=0;c<x.length;c++)for(var A=x[c][0],$=x[c][1];A.test(T);)T=T.replace(A,$)}2==E&&(r(e.getElementsByTagName("body")[0]),T=e.getElementsByTagName("body")[0].innerHTML),3==E&&(r(e.getElementsByTagName("body")[0]),T=e.getElementsByTagName("body")[0].innerHTML),i.innerHTML=T}return pauseVideoAndAudio(i),i}}]),app.filter("contentJs",["$rootScope","cache","cssParser","$filter","selection","stg","$q","settings","chapters","bookmarks","hlights","notes",function(e,t,n,o,r,i,a,s,c,l,d,u){return function(e){function n(){function e(){n++;var e=window.getComputedStyle(t.getOb("epubContent"));"#fe87d0"==rgb2hex(e.getPropertyValue("background-color"))&&(clearInterval(r),removeClass(o,"hide"),addClass(t.getOb("epubContent"),"bgInherit"),s.initialize(),c.resolve({}))}var n=0;removeClass(t.getOb("epubContent"),"bgInherit");var r=setInterval(e,30);e()}var o,c=a.defer(),p=t.getOb("epubContent");return document.getElementById("epubMeta")?(document.getElementById("epubMeta").innerHTML="",o=document.getElementById("epubMeta")):(o=document.createElement("div"),o.setAttribute("id","epubMeta"),o.className="hide",p.parentNode.insertBefore(o,p.nextSibling)),t.setOb("epubMeta",o),r.newChapter(),!parseSecsSeparate||e?i.getBookmarks(function(e){i.getNotes(function(t){i.getHlights(function(o){for(var r=0;r<e.length;r++)e[r].chapter==currentIndex&&l.addIcon(e[r]);for(var r=0;r<t.length;r++)t[r].chapter==currentIndex&&u.addIcon(t[r]);for(var r=0;r<o.length;r++)o[r].chapter==currentIndex&&d.addHlight(o[r]);n()})})}):n(),c.promise}}]),app.filter("contentVirt",["stg","bookmarks","notes","hlights","$timeout","$filter","cache",function(e,t,n,o,r,i,a){var s,c,l,d,u=[];return function(i,p){function f(e){for(var t=u.length;t--;)if(u[t]==e)return;var n=a.getOb("epubContent").className;addClass(a.getOb("epubContent"),"reveal");var o=e.offsetTop-a.getOb("epubContent").offsetTop;0!=o&&(e.style.marginTop=o+"px",u.push(e),a.getOb("epubContent").className=n)}function g(e,t){if(null==t&&(t=!0),!parseSecsSeparate)return e;if(hasClass(e,"parsed"))return e;addClass(e,"parsed");var n=e.innerHTML,o=[],r=-1!=n.indexOf("<pre"),i=-1!=n.indexOf("<code"),a=-1!=n.indexOf("<script");r||i||a?(o.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),o.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),o.push([/(<(?!code|pre|script)[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])):(o.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span><span>$5</span><span>$6</span><span>$7</span><span>$8</span>$9"]),o.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span><span>$3</span><span>$4</span>$5"]),o.push([/(<[^>]*?>)(\s*[^<\s]+\s+?)([^<])/g,"$1<span>$2</span>$3"])),o.push([/<([^\/][^\s>]*)([^<]*?>)(\s*[^<\s]+\s*)(<(?!\/\1))/g,"<$1$2<span>$3</span>$4"]),o.push([/(<[\/]+?[^\s>]*[^<]*?>)(\s*[^<\s]+\s*)(<)/g,"$1<span>$2</span>$3"]);for(var s=0;s<o.length;s++)for(var c=o[s][0],l=o[s][1];c.test(n);)n=n.replace(c,l);n=n.replace(/(<a.*?)(>)/g,'$1 onclick="return false;" $2');var d=replaceHTML(e,n);return t&&m(d),d}function m(i){for(var a=0,s=i;null!=(s=s.previousSibling);)a++;r(function(){e.getBookmarks(function(r){e.getNotes(function(i){e.getHlights(function(e){for(var s=0;s<r.length;s++)r[s].chapter==currentIndex&&r[s].location.split(".")[1]==a&&t.addIcon(r[s]);for(var s=0;s<i.length;s++)i[s].chapter==currentIndex&&i[s].location.split(".")[1]==a&&n.addIcon(i[s]);for(var s=0;s<e.length;s++)e[s].chapter==currentIndex&&e[s].location.split(".")[1]==a&&o.addHlight(e[s])})})})},1e3)}try{if("reset"==i)return s=c=null,l=!0,void(u=[]);var h=a.getOb("epubContent");if("reveal"==i)return void addClass(h,"reveal");if("undoReveal"==i)return void removeClass(h,"reveal");if("parse"==i)return void g(p,!1);if("parseAndAnnotations"==i)return void g(p);var v,b=h.parentNode.parentNode,y=b.style.webkitTransform||b.style.mozTransform||b.style.transform;v=!overflowScroll||!config.overflowScroll&&preview&&mobile?-Number(y.split(",")[1].slice(0,-2)):a.getOb("epubContainer").scrollTop;var k=d>v?"up":"down";d=v;var w,C,T=200,E=v+b.parentNode.offsetHeight,x=h.children[0];if(l){for(var S=[],I=0,B=0;B<x.childNodes.length;B++)S[B]={},x.childNodes[B].offsetTop+x.childNodes[B].offsetHeight<v-T?S[B].add=["cNone","noMargin"]:x.childNodes[B].offsetTop>E+T?S[B].add=["cNone","noMargin"]:(0==I&&(S[B].setMargin=!0,I=1,w=B),S[B].remove=["cNone","noMargin"],S[B].setParse=!0,C=B);for(var B=0;B<S.length;B++)S[B].setMargin&&f(x.childNodes[B]),S[B].setParse&&g(x.childNodes[B]),addRemoveClass(x.childNodes[B],S[B].add,S[B].remove);for(var B=0;B<S.length;B++);return null!=w&&(s=x.childNodes[w]),null!=C&&(c=x.childNodes[C]),void(l=!1)}if("up"==k){if(!(s.offsetTop+s.offsetHeight)<v-0&&!(s.offsetTop>v-T))return;if(c==x.childNodes[0])return}else if("down"==k){if(!(c.offsetTop>E+0||c.offsetTop+c.offsetHeight<E+T))return;if(s==x.childNodes[x.childNodes.length-1])return}s&&(s.offsetTop+s.offsetHeight<v-0?(addClass(s,"cNone"),addClass(s,"noMargin"),s.nextSibling&&(s=s.nextSibling,removeClass(s,"noMargin"),f(s),s=g(s))):s.offsetTop>v-T&&s.previousSibling&&(addClass(s,"noMargin"),s=s.previousSibling,removeClass(s,"cNone"),removeClass(s,"noMargin"),f(s),s=g(s))),c&&(c.offsetTop>E+0?(addClass(c,"cNone"),c.previousSibling&&(c=c.previousSibling,removeClass(c,"cNone"),c=g(c))):c.offsetTop+c.offsetHeight<E+T&&c.nextSibling&&(c=c.nextSibling,removeClass(c,"cNone"),c=g(c)))}catch(A){}}}]),app.filter("js",["$rootScope","$q","jsParser",function(e,t,n){return function(e,o){var r=t.defer();o||(o={});for(var i=[],a=e.getElementsByTagName("script"),s=0;s<a.length;s++)if(a[s].getAttribute("src")){var c=a[s].getAttribute("src");if(c.indexOf("/kotobeeInteractive.js")>=0)continue;i.push(c.indexOf(":/")>=0?{mode:"url",val:c}:{mode:"url",val:c})}else i.push({mode:"code",val:a[s].innerHTML});var l=e.getElementsByTagName("body")[0];return l.getAttribute("onload")&&i.push({mode:"code",val:l.getAttribute("onload")}),o.noJsParse?r.resolve():n.inject(i,function(e){r.resolve(e)}),r.promise}}]),app.filter("coverPath",["stg",function(e){return function(t,n){var o=(config.kotobee.liburl?config.kotobee.liburl:"")+"img/ui/defaultCover.png";return t?n?(config.kotobee.liburl?config.kotobee.liburl:"../../")+"books/"+n+"/EPUB/"+t:ph.join(bookPath,e.data.packageURL,t):o}}]),app.filter("nativeLinks",function(){return function(e){var t=document.createElement("div");t.innerHTML=e;for(var n=t.getElementsByTagName("a"),o=0;o<n.length;o++){var r=n[o].getAttribute("href");n[o].setAttribute("onclick","window.open('"+r+"', '_system');"),n[o].setAttribute("href","#")}return t.innerHTML}}),app.filter("moreDataExists",["stg",function(e){return function(t,n){try{if(!e.currentLibrary)return!1;if("categories"==n)return!1;if("downloaded"==n)return!1;var o;if("favorites"==n&&(o=e.favorites),"all"==n&&(o=e.currentLibrary.books),0==o.length)return!1}catch(r){return!1}return t}}]),app.filter("round",function(){return function(e){return Math.round(e)}}),app.filter("arrayEmpty",["$filter",function(e){return function(t){if(!t)return!0;for(var n=0;n<t.length;n++){if(!Array.isArray(t[n]))return!1;if(!e("arrayEmpty")(t[n]))return!1}return!0}}]),app.filter("langFromId",["stg",function(e){return function(t){for(var n=0;n<e.data.languages.length;n++)if(e.data.languages[n].val==t)return e.data.languages[n].label;return t}}]),app.filter("unsafe",["$sce",function(e){return e.trustAsHtml}]),app.filter("nl2br",function(){return function(e){return e?e.replace(/\n/g,"<br>"):""}}),app.filter("releasePlatform",function(){return function(e){switch(e){case"win32":return"Windows 32-bit";case"win64":return"Windows 64-bit";case"win":return"Windows";case"mac":return"Macintosh"}}}),app.filter("styles",["$rootScope","$q","cssParser","$filter","selection","stg",function(e,t,n){return function(e,o){var r=t.defer();o||(o={});for(var i=e.getElementsByTagName("link"),a=[],s=0;s<i.length;s++)"text/css"==i[s].getAttribute("type")&&i[s].getAttribute("href").length&&a.push(ph.join(o.path,i[s].getAttribute("href")));return o.noCssParse?r.resolve():n.inject(a,function(e){r.resolve(e)}),r.promise}}]),app.filter("t",["translit",function(e){return function(t){return e.get(t,Array.prototype.slice.call(arguments,2))}}]),app.factory("app",["$q","backend","modals","$location","sync","$ionicHistory","book","chapters","$compile","translit",function(){var e={};return e}]),app.factory("auth",["$q","backend","modals","$location","sync","$ionicHistory","stg","book","chapters","app","$compile","translit",function(e,t,n,o,r,i,a,s,c,l,d,u){function p(){var e={};if(e.watermarkPlaceholder){var t='<div id="watermark"><span>'+u.get("createdUsing")+'</span><a href="#" onclick="window.open(\'https://www.kotobee.com\', \'_system\');return false;"><img src="'+rootDir+'img/ui/authorLogo.png"></a></div>',n=document.createElement("div");n.innerHTML=t,document.body.insertBefore(n,document.getElementById("html5Fallback")),setTimeout(function(){addClass(document.getElementById("watermark"),"show")},2e3)}}var f={};return f.authenticate=function(r){r||(r={putTest:function(){},$$phase:!0});var i=e.defer();return r.putTest("inside"),f.getPermissions(function(e){t.cloudParam("public")||t.cloudParam("entry")?f.startup():e&&"offline"==e.error&&t.cloudParam("offline")&&native?f.startup({tab:"downloads"}):t.login().then(function(e){e.error?(n.hide(),o.path("/login")):f.startup()})}),i.promise},f.getPermissions=function(e){"library"==config.kotobee.mode?t.getPermissions(function(t){if(t||(t={}),"offline"==t.error)return void e(t);for(var n in t)config.kotobee[n]=t[n];e()}):"book"==config.kotobee.mode?(config.kotobee["public"]=!0,e()):l.getPermissions(e)},f.startup=function(e){if(e||(e={}),native&&p(),"library"==config.kotobee.mode){f.authenticated=!0;var t="";e.tab&&(t="/tab/"+e.tab);try{o.path("/library"+t)}catch(n){}i.clearHistory()}else"book"==config.kotobee.mode?s.loadBook().then(function(){f.authenticated=!0,o.path("/reader"),i.clearHistory(),r.initialize(),setTimeout(function(){c.initialize()},1e3)}):"app"==config.kotobee.mode&&(f.authenticated=!0,o.path("/app"),i.clearHistory())},f}]),app.factory("backend",["$http","error","translit","cache","$location","$ionicHistory","$rootScope","modals","$window","status","crdv","$sce","$timeout","stg","$q","sync",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g){var m={};m.getAuthVarsOld=function(){return{libid:config.kotobee.libid,email:f.data.user.email,pwd:f.data.user.pwd}},m.getAuthVars=function(){var e={email:f.data.user.email,pwd:f.data.user.pwd,code:f.data.user.code,env:config.kotobee.mode};return e.cloudid=config.kotobee.cloudid,"library"==e.env&&f.data.book&&(e.bid=f.data.book.id),uuid&&(e.fingerprint=uuid),e},m.initialize=function(e){e||(e={putTest:function(){},$$phase:!0});({func:arguments.callee,args:arguments});e.putTest("X");var n=g.defer();return e.putTest("Y"),e.putTest("Z"),e.putTest("J"),t.detect("s_authError",m.loginErrorDetection),e.putTest("K"),f.readSlot("user"+config.kotobee.cloudid,function(t){if(config.kotobee.cloudid){var o=t;o&&(f.data.user=o)}f.data.user||(f.data.user={}),0==f.data.user.length&&(f.data.user={}),f.data.user.loggedIn=!1,e.putTest("L"),d.initialize(e,function(){preview?n.resolve():m.getFingerprint(function(e){uuid=e,n.resolve()})})}),n.promise},m.getFingerprint=function(e){function t(){var t={excludeUserAgent:!0,excludeScreenResolution:!0,excludeDoNotTrack:!0,excludeAvailableScreenResolution:!0,excludeOpenDatabase:!0,excludePlugins:!0,excludeCanvas:!0,excludeWebGL:!0,excludeJsFonts:!0};t.excludeCanvas=!1,t.excludeWebGL=!1,new Fingerprint2(t).get(function(t,n){try{for(var o=0;o<n.length;o++);t||(t=process.env.USERNAME),f.writeSlot("fingerprint",t,function(){e(t)})}catch(r){}})}native?window.plugins.uniqueDeviceID.get(function(n){n&&(n.length?e(n):t())},t):desktop?"mac"==os?t():require("child_process").exec("wmic CPU get ProcessorId",{cwd:"."},function(n,o){if(o){var r=o.toUpperCase().split("PROCESSORID");if(r.length){var i=r[1].trim();i.length?e(i):t()}else t()}else t()}):t()};var h=null,v=null;m.setLibraryLoginCallback=function(e){h=e},m.setLibraryLogoutCallback=function(e){v=e},m.loginErrorDetection=function(e){f.data.user.loggedIn=!1,e&&(e.loginOptions.signIn=function(){s.hide(),setTimeout(function(){e.model&&(f.data.user.pwd=e.model.pwd),f.data.user.code=null,m.login({userInput:!0}).then(function(t){t.error||e.model&&(e.model.pwd=null)})},800)},e.loginOptions.register=function(){s.hide(),r.path("/register")},e.loginOptions.forgotPassword=function(){s.hide(),r.path("/forgotpwd")},e.loginOptions.redeemCode=function(){s.hide(),r.path("/redeemcode")})};var b,y=null;return m.login=function(o,r){o||(o={});var i={func:arguments.callee,args:arguments},a=s.show({mode:"loading",loadingMsg:n.get("pleaseWait"),timeLimit:1e4}),c=g.defer();f.data.user.loggedIn=!1,r&&(y=r);var l;"book"==config.kotobee.mode&&(l=config.kotobee.liburl+"library/auth"),"library"==config.kotobee.mode&&(l=config.kotobee.liburl+"library/get"),preview||(m.fingerprint=uuid);var d=m.getAuthVars();return o.userInput&&(d.input=!0),d.platformdesc=navigator.userAgent,native?(d.platform="mobile",device&&(d.platformdesc=device.platform+" "+device.model+" "+device.version+" "+(device.manufacturer?device.manufacturer:""))):d.platform=desktop?"desktop":"web",e.post(l,getFormData(d),postOptions).success(function(e){function n(){return e.cloudid||e.success?(f.data.user.loggedIn=!0,"library"==config.kotobee.mode&&(f.data.currentLibrary=e,h&&h()),c.resolve(e),void(y&&(y(e),y=null))):(o.dontShowErrorDialog||t.update({error:"s_authError"}),void c.resolve({error:"s_authError"}))}if(clearTimeout(b),s.hide(a),e.error)return o.dontShowErrorDialog||t.update(e),f.data.user.pwd=null,f.data.user.code=null,void c.resolve(e);if(f.data.user.pwd=e.pwd,f.data.user.rememberMe){var r={rememberMe:!0};f.data.user.email&&f.data.user.pwd?(r.email=f.data.user.email,r.pwd=f.data.user.pwd):f.data.user.code&&(r.code=f.data.user.code),f.writeSlot("user"+config.kotobee.cloudid,r,n)}else f.clearSlot("user"+config.kotobee.cloudid,n)}).error(function(){clearTimeout(b),s.hide(),t.update({error:"networkError",ref:i})}),c.promise},m.logout=function(){f.data.user.pwd=null,f.data.user.loggedIn=!1,f.data.user.email=null,f.data.user.code=null,f.writeSlot("user"+config.kotobee.cloudid,f.data.user,function(){"library"==config.kotobee.mode?p(function(){if(t.update({error:"s_authError"}),m.cloudParam("entry")){for(var e=0;e<f.data.currentLibrary.books.length;e++)f.data.currentLibrary.books[e].favorite=!1;d.applyExistingBooks()}else f.data.currentLibrary={};v&&v()},200):(r.path("/login"),i.clearHistory())})},m.getPermissions=function(n){var o={func:arguments.callee,args:arguments},r={};return r.env=config.kotobee.mode,r.cloudid=config.kotobee.cloudid,e.post(config.kotobee.liburl+"library/permissions",getFormData(r),postOptions).success(function(e){return e.error?(t.update({error:"errorAndCallback",msg:e,cb:d.exit}),angular.element(document.getElementById("home")).scope().hideLoading=!0,void(a.$$phase||a.$apply())):void(n&&n(e))}).error(function(){native&&m.cloudParam("offline")?n&&n({error:"offline"}):t.update({error:"networkError",ref:o})})},m.register=function(o,r){var i={func:arguments.callee,args:arguments},a=s.show({mode:"loading",loadingMsg:n.get("registeringAccount")}),c=m.getAuthVars();c.email=o.email1,c.root=config.kotobee.liburl;var l=getFormData(c);return e.post(config.kotobee.liburl+"user/register",l,postOptions).success(function(e){return s.hide(a),e.error?void t.update(e):void(r&&r(e))}).error(function(){t.update({error:"networkError",ref:i})})},m.forgotPwd=function(o,r){var i={func:arguments.callee,args:arguments},a=s.show({mode:"loading",loadingMsg:n.get("retrieving")}),c=m.getAuthVars();c.email=o.email,c.root=config.kotobee.liburl;var l=getFormData(c);return e.post(config.kotobee.liburl+"user/forgotpwd",l,postOptions).success(function(e){return s.hide(a),e.error?void t.update(e):void(r&&r(e))}).error(function(){t.update({error:"networkError",ref:i})})},m.downloadEbookTest=function(e,n){var o={responseType:"blob",onProgress:function(){}},r={id:e.id,mode:e.binary};return m.sendRawPost("http://192.168.1.5/files/test.zip",r,o,function(e){return e.error?(t.update(e),void n()):void n(e)})},m.downloadEbook=function(e,n,o){try{var r={responseType:"blob",onProgress:n},i={id:e.id,mode:"binary",requester:"reader"};return m.sendRawPost(config.kotobee.liburl+"library/ebook/download",i,r,function(e){return e.error?(t.update(e),void o()):void o(e)})}catch(a){}return},m.tincan=function(t,n){var o=getFormData(m.getAuthVars());for(var r in t)o.append(r,t[r]);e.post(config.kotobee.liburl+"tincan",o,postOptions).success(function(){n&&n()}).error(function(){})},m.getUnauthLibrary=function(n){if("library"==config.kotobee.mode){var o={func:arguments.callee,args:arguments},r=getFormData(m.getAuthVars());e.post(config.kotobee.liburl+"library/getbasic",r,postOptions).success(function(e){f.data.currentLibrary=e,n&&n()}).error(function(){native&&m.cloudParam("offline")?n&&n():t.update({error:"networkError",ref:o})})}},m.addtoFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(m.getAuthVars());i.append("bid",n.id),i.append("cloudid",m.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/add",i,postOptions).success(function(e){return e.error?(t.update(e),void o()):void o(e)}).error(function(){t.update({error:"networkError",ref:r})})},m.removeFav=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(m.getAuthVars());i.append("bid",n.id),i.append("cloudid",m.cloudParam("cloudid")),i.append("type","book"),e.post(config.kotobee.liburl+"library/favorite/remove",i,postOptions).success(function(e){return e.error?(t.update(e),void o()):void o(e)}).error(function(){t.update({error:"networkError",ref:r})})},m.addBookStat=function(t){if(t||(t={}),!preview&&config.kotobee.cloudid){var n=(window.location.href,getFormData(m.getAuthVars()));n.append("type",t.type),e.post(config.kotobee.liburl+"library/ebook/stat",n,postOptions).success(function(){}).error(function(){})}},m.addStat=function(t){if(t||(t={}),!preview){var n=window.location.href;if(!(n.indexOf("localhost/")>=0||n.indexOf("localhost:")>=0)){var o=getFormData(m.getAuthVars());o.append("software","reader"),o.append("platform",navigator.userAgent),o.append("assetType",config.kotobee.mode);try{o.append("assetName","book"==config.kotobee.mode?f.data.book.meta.dc.title:f.data.currentLibrary.name)}catch(r){}o.append("assetPath",n.split("#")[0]),config.kotobee.cloudid&&o.append("assetId",config.kotobee.cloudid),f.data.user.email&&o.append("email",f.data.user.email),f.data.user.code&&o.append("code",f.data.user.code),t.action&&o.append("action",t.action),t.param&&o.append("param",t.param),e.post(config.kotobee.liburl+"stat/add",o,postOptions).success(function(){}).error(function(){})}}},m.externalLink=function(e,t){try{if(t||(t={}),t.secure&&!native&&!desktop&&!preview)return void c.open(e);var o=function(e){native?d.openInNativeBrowser(e):desktop?require("nw.gui").Shell.openExternal(e):window.open(e,"_blank")},r={title:n.get("externalLink"),src:u.trustAsResourceUrl(e),openInNativeBrowser:o};r.status="loading";var i=setTimeout(function(){r.status="",r.error=n.get("errorLoadingPage"),a.$$phase||a.$apply()},1e4);r.loaded=function(){r.status="loaded",clearTimeout(i),a.$$phase||a.$apply()};var l=s.show({mode:"externalSite",animation:"slide-in-up",dynamic:!0,backdropClickToClose:!1,siteOptions:r});desktop||preview||m.getXframeOptions({url:e},function(t){function n(){s.hide(l),setTimeout(function(){s.show({mode:"xFrameError",errorOptions:{url:e,openInNativeBrowser:o}})},500)}if(r.status="loaded",a.$$phase||a.$apply(),t&&t.success){var i=t.success.toLowerCase();("sameorigin"==i||"deny"==i)&&n()}})}catch(p){}},m.getXframeOptions=function(t,n){var o=({func:arguments.callee,args:arguments},getFormData(m.getAuthVars()));o.append("url",t.url),e.post(config.kotobee.liburl+"getxframe",o,postOptions).success(function(e){return e.error?void n():void n(e)}).error(function(){})},m.hasAccessTo=function(t,n){if("library"!=config.kotobee.mode)return void(n&&n({success:!0}));var o=getFormData(m.getAuthVars());t||(t={});for(var r in t)o.append(r,t[r]);e.post(config.kotobee.liburl+"user/access",o,postOptions).success(function(e){n&&n(e)}).error(function(){n&&n({error:""})})},m.setLastChapter=function(t){var n=getFormData(m.getAuthVars());n.append("chapter",currentIndex),e.post(config.kotobee.liburl+"library/ebook/lastchap",n,postOptions).success(function(e){t&&t(e)}).error(function(){t&&t({error:""})})},m.cloudParam=function(e){return config.kotobee[e]},m.getEbooks=function(n,o){var r={func:arguments.callee,args:arguments},i=getFormData(m.getAuthVars());for(var a in n)i.append(a,n[a]);e.post(config.kotobee.liburl+"library/ebook/all",i,postOptions).success(function(e){e.error&&t.update(e),o&&o(e)}).error(function(){t.update({error:"networkError",ref:r}),o&&o({error:"networkError"})})},m.sendRawPost=function(e,t,n,o,r){r||(r=0);for(var i="",a=m.getAuthVars(),s=[a,t],c=0;c<s.length;c++)for(var l in s[c]){var d=s[c][l];void 0!=d&&"object"!=typeof d&&("string"==typeof d&&(d=encodeURIComponent(d=("."+d).substr(1))),"boolean"==typeof d&&(d=d?1:0),i+="&"+l+"="+d)}var u=new XMLHttpRequest;return u.open(n.method?n.method:"POST",e,!0),"GET"!=n.method&&u.setRequestHeader("Content-type","application/x-www-form-urlencoded"),n.onProgress&&(u.onprogress=function(e){e.lengthComputable&&n.onProgress(e.loaded/e.total)}),n.responseType&&(u.responseType=n.responseType),u.addEventListener("error",function(){o({error:"networkError"})},!1),u.onreadystatechange=function(){u.aborted||4==u.readyState&&(200==u.status?p(function(){o(u.response)}):u.onerror())},u.onerror=function(){return r>=3?void p(function(){o({error:"d_connectionTimedOut"})}):m.sendRawPost(e,t,n,o,++r)},"GET"!=n.method?u.send(i):u.send(),u},m.abort=function(e){e&&4!=e.readyState&&(e.aborted=!0,e.abort())},m}]),app.factory("book",["$http","error","$timeout","$rootScope","crdv","translit","modals","cssInjector","jsParser","chapters","cssParser","$q","status","backend","tinCan","stg","$sce","$filter",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v){function b(e){for(var t=document.createElement("ol"),n=0;n<e.childNodes.length;n++)if(e.childNodes[n]){var o=e.childNodes[n];if(8!=o.nodeType&&"#text"!=o.nodeName&&"navpoint"==o.nodeName.toLowerCase()){for(var r,i,a,s=0;s<o.childNodes.length;s++)if(o.childNodes[s]){var c=o.childNodes[s].nodeName.toLowerCase();"content"==c?i=o.childNodes[s].getAttribute("src"):"navlabel"==c?r=o.childNodes[s].textContent.trim():"navpoint"==c&&(a||(a=b(o)))}var l=document.createElement("li"),d=document.createElement("a");d.innerHTML=r?r:"",d.setAttribute("href",i?ph.join(m.data.tocPath,i):""),l.appendChild(d),a&&l.appendChild(a),t.appendChild(l)}}return t}var y={};return y.initialize=function(){},y.loadBook=function(){function n(){f.addStat({action:"open"}),v("chapterHtml")(m.data.toc),m.data.book.chapters=m.data.toc.innerHTML,h.resolve()}var s={func:arguments.callee,args:arguments},h=u.defer();return m.resetBook(),d.clearCache(),c.clearCache(),l.clearCache(),e.get(cacheBust(bookPath+"META-INF/container.xml")).success(function(c){function l(n){window.location.origin;"book"==config.kotobee.mode&&!o.readerApp&&f>=1.3&&!h?e.get("js/templates.js").success(n).error(function(){t.update({error:"networkError",ref:s})}):n()}config.kotobee.encodekey&&(c=config.v>=1.1?CryptoJS.AES.decrypt(c,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,c));var d=parser.parseFromString(c,"text/xml");m.data.epub={};try{m.data.packageURL=d.getElementsByTagName("rootfile")[0].getAttribute("full-path")}catch(u){return p.update(),void t.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit})}var f=config.v,h=native||"https://www.kotobee.com"==window.location.origin||"https://qa.kotobee.com"==window.location.origin||"http://dev.kotobee.net"==window.location.origin||"http://k.localhost"==window.location.origin;l(function(r){e.get(cacheBust(bookPath+m.data.packageURL)).success(function(t){function s(){var e=angular.element(document.getElementById("home"));e&&(e.scope().hideLoading=!0,o.$$phase||o.$apply()),p.update(),a.show({mode:"generalError",errorOptions:{msg:i.get("errorLoadingPage")}})}if("book"==config.kotobee.mode&&!o.readerApp)if(f>=1.3){if(h){if(0!=config.checksum.indexOf(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()))return void s()}else if(CryptoJS.MD5(t.replace(/\s+/g,"")).toString()+CryptoJS.MD5(r).toString()!=config.checksum)return void s()}else if(f>=1.2&&CryptoJS.MD5(t).toString()!=config.checksum)return void s();config.kotobee.encodekey&&(t=config.v>=1.1?CryptoJS.AES.decrypt(t,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,t));var c=parser.parseFromString(t,"text/xml");m.data.epub.metadata=c.getElementsByTagName("metadata")[0],m.data.epub.manifest=c.getElementsByTagName("manifest")[0],m.data.epub.spine=c.getElementsByTagName("spine")[0];for(var l=0;l<m.data.epub.spine.childNodes.length;l++){var d=m.data.epub.spine.childNodes[l];8!=d.nodeType&&"#text"!=d.nodeName&&"no"==d.getAttribute("linear")&&m.data.epub.spine.removeChild(m.data.epub.spine.childNodes[l--])}m.data.mediaList=[],m.data.book.meta={},m.data.book.version=3;try{for(var l=0;l<m.data.epub.metadata.childNodes.length;l++){var d=m.data.epub.metadata.childNodes[l];if(8!=d.nodeType&&"#text"!=d.nodeName)if(d.hasAttribute("name")&&"meta"==d.nodeName.toLowerCase())m.data.book.meta[d.getAttribute("name")]=d.getAttribute("content");else{var u;u=d.hasAttribute("property")?d.getAttribute("property"):d.nodeName;for(var y=u.split(":"),k=m.data.book.meta,w=0;w<y.length;w++)w==y.length-1?k[y[w].toLowerCase()]=d.innerHTML?d.innerHTML:d.textContent:(k[y[w].toLowerCase()]||(k[y[w].toLowerCase()]={}),k=k[y[w].toLowerCase()])}}}catch(C){}for(var T="image/.*",E=getElementsByAttribute(m.data.epub.manifest,"item","media-type",T),l=0;l<E.length;l++){var x=E[l].getAttribute("href");if(0!=x.indexOf("js/widgets/")&&(0!=x.indexOf("xhtml/pdf")||-1==x.indexOf("/page"))){var k={};k.thumbnail=ph.join(bookPath,m.data.packageURL,E[l].getAttribute("href")),k.title=ph.removeExtension(ph.basename(k.thumbnail));var T=E[l].getAttribute("media-type");k.type=T.split("image/")[1],m.data.mediaList.push(k)}}var S=getElementsByAttribute(m.data.epub.manifest,"item","properties","cover-image");
S.length>0?m.data.epub.bookThumb=v("coverPath")(S[0].getAttribute("href")):m.data.book.meta.cover&&(S=getElementsByAttribute(m.data.epub.manifest,"item","id",m.data.book.meta.cover),S.length>0&&(m.data.epub.bookThumb=v("coverPath")(S[0].getAttribute("href"))));try{m.data.tocPath=getElementsByAttribute(m.data.epub.manifest,"item","properties","[s]*nav[s]*")[0].getAttribute("href")}catch(C){var I=m.data.epub.spine.getAttribute("toc");if(!I)return void n();try{m.data.book.version=2,m.data.tocPath=getElementsByAttribute(m.data.epub.manifest,"item","id",I)[0].getAttribute("href")}catch(C){return void n()}}e.get(cacheBust(ph.join(bookPath,m.data.packageURL,m.data.tocPath))).success(function(e){if(config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e)),2==m.data.book.version){var t=parser.parseFromString(e,"text/xml"),o=t.getElementsByTagName("navMap");o.length&&(m.data.toc=b(o[0]))}else for(var t=parser.parseFromString(e,"text/html"),r=t.getElementsByTagName("ol"),i=0,a=0;a<r.length;a++){var s=r[a].getElementsByTagName("a");if(!(s.length<i)){i=s.length,m.data.toc=r[a];for(var c=s.length;c--;)s[c].getAttribute("href")?s[c].setAttribute("href",ph.join(m.data.tocPath,s[c].getAttribute("href"))):s[c].setAttribute("href","")}}n()}),g.send({verb:"opened",activity:"Book: "+m.data.book.meta.dc.title})}).error(function(){t.update({error:"networkError",ref:s})})})}).error(function(){p.update(),t.update(native||desktop||"file://"!=window.location.origin?{error:"errorAndCallback",msg:"cantReadConfigFile",cb:r.exit}:{error:"This browser failed to run the ebook app locally. Please try a different browser, or upload the web files to your server and run the web app online"})}),h.promise},y.getTitleByIndex=function(e){if(m.data.toc)try{var t=m.data.toc.getElementsByTagName("li"),n=t[e];return n.getElementsByTagName("a")[0].innerHTML}catch(o){}},y}]),app.factory("cache",function(){var e={},t={};return e.initialize=function(){e.setOb("body",document.getElementsByTagName("body")[0]),e.setOb("title",document.getElementsByTagName("title")[0])},e.setOb=function(e,n){return t[e]=n,n},e.getOb=function(e){return t[e]},e}),app.factory("chapters",["$http","tinCan","backend","error","crdv","$stateParams","sync","scorm","cache","modals","status","$injector","$timeout","virt","$ionicPopup","translit","selection","$ionicScrollDelegate","$filter","$rootScope","cssInjector","cssParser","jsParser","$location","$sce","$q","stg",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g,m,h,v,b,y,k,w,C,T,E,x,S){function I(){addClass(document.getElementById("ebookLoaderAnim"),"hide")}function B(){removeClass(document.getElementById("ebookLoaderAnim"),"hide")}function A(e,t){e||(e={});var n=c.getOb("epubContainer");if(null==currentIndex)return n.style.opacity=0,B(),void(t&&t());if(e.page!=currentIndex-1&&e.page!=currentIndex+1)return n.style.opacity=0,B(),void(t&&t());var o=e.page>currentIndex?"next":"prev",r=document.getElementById(o+"Page"),i=L(ph.join(bookPath,S.data.packageURL,j.getChapterURL(e.page)));if(i&&i.viewport){var a=r.getElementsByTagName("iframe");if(a.length){var s=(a[0].contentDocument.getElementById("epubContainer"),a[0].contentDocument.getElementById("epubContent")),l=a[0].contentDocument.getElementById("epubScroller");if(s&&(s.style.width=i.viewport.width+"px",s.style.height=i.viewport.height+"px"),l){var d=u.get("nav").getFxlBestFit(i,s);autoprefixTransform(l,"scale("+d+")")}}}if("navSlide"==S.data.settings.navAnim)r.style.transform=S.data.settings.rtl?"translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)":"translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)",setTimeout(function(){e.animID==D&&(S.data.settings.rtl?autoprefixTransform(n,"translate3d("+("next"==o?"":"-")+n.offsetWidth+"px,0,0)"):autoprefixTransform(n,"translate3d("+("next"==o?"-":"")+n.offsetWidth+"px,0,0)"),r.style.transform="translate3d(0,0,0)",addClass(n,"anim"),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==D&&(autoprefixTransform(n,null),removeClass(n,"anim"),t&&t())},330))},30);else if("navFade"==S.data.settings.navAnim)r.style.left=0,r.style.opacity=1,addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==D&&t&&t()},330);else if("navFlip"==S.data.settings.navAnim)addClass(n,"anim"),S.data.settings.rtl?(autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"),autoprefixTransform(r,"next"==o?"rotateY(-90deg)":"rotateY(90deg)")):(autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)"),autoprefixTransform(r,"next"==o?"rotateY(90deg)":"rotateY(-90deg)")),setTimeout(function(){e.animID==D&&(autoprefixTransform(r,null),addClass(r,"anim"),addClass(r,"activeSlidePage"),setTimeout(function(){e.animID==D&&(removeClass(n,"anim"),autoprefixTransform(n,null),t&&t())},630))},30);else if("navBookBlock"==S.data.settings.navAnim){var p=document.createElement("div");p.className="shadow",p.style.opacity=0,p.appendChild(document.createElement("div")),n.appendChild(p),addClass(n,"anim"),S.data.settings.rtl?autoprefixTransform(n,"next"==o?"rotateY(90deg)":"rotateY(-90deg)"):autoprefixTransform(n,"next"==o?"rotateY(-90deg)":"rotateY(90deg)");var f=n.style.transform||n.style.webkitTransform||n.style.mozTransform;n.style.transformOrigin=n.style.webkitTransformOrigin=n.style.mozTransformOrigin="rotateY(90deg)"==f?"right top":"left top",addClass(r,"anim"),addClass(r,"activeSlidePage");var g=document.createElement("div");g.className="shadow",g.style.opacity=.7,r.appendChild(g),p.style.opacity=0,p.style.height=n.scrollHeight+"px",setTimeout(function(){e.animID==D&&(g.style.opacity=null,setTimeout(function(){p.style.opacity=.4,setTimeout(function(){n.style.transformOrigin=n.style.webkitTransformOrigin=n.style.mozTransformOrigin=null,g.parentNode&&g.parentNode.removeChild(g),p.parentNode&&p.parentNode.removeChild(p),e.animID==D&&(removeClass(n,"anim"),autoprefixTransform(n,null),t&&t())},430)},200))},30)}}function $(){var e=c.getOb("epubContainer");null!=e.style.opacity&&(e.style.opacity=null,I()),native&&(e.scrollTop=0);var t=document.getElementsByClassName("activeSlidePage");if(t.length){var n=t[0];"navSlide"==S.data.settings.navAnim?n.style.transform=null:"navFade"==S.data.settings.navAnim?n.style.opacity=null:"navFlip"==S.data.settings.navAnim?autoprefixTransform(n,null):"navBookBlock"==S.data.settings.navAnim&&autoprefixTransform(n,null),removeClass(n,"anim"),removeClass(n,"activeSlidePage");var o='<h3 id="ebookLoaderAnim"><div class="splashSpinner large"><div class="dot1"></div><div class="dot2"></div></div></h3>';document.getElementById("nextPage").innerHTML=o,document.getElementById("prevPage").innerHTML=o}}function N(){function t(t,o){function r(t){return F?void t():void(n?e.get("/bundles/vijualib/templates/reader/cloud/css/styles.min.css").success(function(e){F=e,t()}).error(function(){t()}):e.get("lib/ionic/release/css/ionic.min.css").success(function(n){z=n;var o="css/styles.min.css",r="http://localhost:8100"==window.location.origin;r&&(o="css/style.css"),e.get(o).success(function(n){return F=n,r?void e.get("css/base.css").success(function(n){F=n+F,e.get("css/kotobeeInteractive.css").success(function(e){F+=e,t()}).error(function(){t()})}).error(function(){t()}):void t()}).error(function(){t()})}).error(function(){t()}))}function i(e){r(function(){var r=ph.removeHash(window.location.href),i=document.createElement("html"),a=document.createElement("head");ios&&(a.innerHTML="<meta http-equiv=\"Content-Security-Policy\" content=\"default-src * filesystem: data:; style-src 'self' 'unsafe-inline' filesystem: data:; script-src 'self' 'unsafe-inline' 'unsafe-eval' https://*.youtube.com http://*.youtube.com https://*.ytimg.com http://*.ytimg.com;img-src * filesystem: data: file:\">"),i.appendChild(a);var s=document.createElement("base"),c=document.getElementsByTagName("base");c.length&&(r=ph.join(window.location.origin,c[0].getAttribute("href"))),s.setAttribute("href",ph.join(r,ph.removeFilename(t))+"/"),a.appendChild(s);var l=document.createElement("style"),d="";d+=z;var p=" body{margin:0; padding-top:1px;} #epubContainer{padding-top:1px;position:absolute;top:0;left:0;right:0;bottom:0 !important}";if(d+=p,d+="html,#epubContainer{overflow-y:"+(mobile?"hidden":"auto")+"}",d+="#epubScroller{position: static;height: 100%;width: 100%;padding:10px;box-sizing: border-box;}",S.data.settings.rtl&&(d+="#epubContainer{direction:rtl !important}"),e.viewport&&e.viewport.width){var f=u.get("nav").getFxlBestFit(e,document.createElement("div"));d+="#epubScroller{transform:scale("+f+");-webkit-transform:scale("+f+");-moz-transform:scale("+f+");-ms-transform:scale("+f+");}",d+="#epubScroller{transform-origin: top left; height: 100%;}",d+="#epubContent{width:"+e.viewport.width+"px;height:"+e.viewport.height+"px}",d+="html{overflow-x:"+(mobile?"hidden":"auto")+"}",f>=1&&(d+="#epubContainer #epubContent{margin-left:auto !important; margin-right:auto !important}")}d+=e.styles,d+=" #epubContent{background-color:inherit !important; margin: 20px 30px !important}",d+=" #epubContent.hide{display:block !important}",S.data.settings.textSize&&(d+=" #epubContent{font-size: "+S.data.settings.textSize+"}"),d+=F,l.innerHTML=d,l.setAttribute("type","text/css"),a.appendChild(l);var g=document.createElement("div");g.className="stylesEnabled",g.id="epubContainer";var m=document.createElement("div");m.id="epubScroller",g.appendChild(m);var h=e.content;y.readerApp||n||(h=h.replace(/src="(?!http[s]?\:\/\/)([^"]*)?"/g,'src="'+ph.relative(t,"$1")+'"'));'function clearAudioVideo(){                            var audio = document.getElementsByTagName("audio");                            console.log(\'audio.length: \'+audio.length);                            for (var k = audio.length; k--;) {                                try {                                    audio[k].pause();                                    if (!audio[k].children.length) audio[k].src = "";                                } catch(er) {console.log(\'audio error \'+er);}                            }                            var video = document.getElementsByTagName("video");                            for (var k = video.length; k--;) {                                video[k].pause();                                if (!video[k].children.length) video[k].src = "";                            }}                            console.log(\'window.onload\');                            console.log(\''+e.title+"');                            clearAudioVideo();                            setTimeout(clearAudioVideo,30);                            ";m.innerHTML=h;for(var v=m.getElementsByTagName("audio"),b=v.length;b--;){try{v[b].pause(),v[b].children.length||(v[b].src="")}catch(k){}var w=v[b].parentNode;w.previousSibling&&hasClass(w.previousSibling,"playBtn")&&removeClass(w.previousSibling,"hide"),w.removeChild(v[b])}var C=document.createElement("body");S.data.settings.rtl&&C.setAttribute("class","rtl"),C.appendChild(g),i.appendChild(C);var T=document.createElement("iframe");if(T.setAttribute("srcdoc",i.outerHTML),detectIE()||native&&ios){var E="javascript: window.frameElement.getAttribute('srcdoc');";T.setAttribute("src",E),T.contentWindow&&(T.contentWindow.location=E)}o.innerHTML="",o.appendChild(T)})}var a=L(t);a?i(a):M(t,{},i)}var n="https://www.kotobee.com"==window.location.origin||"https://qa.kotobee.com"==window.location.origin||"http://dev.kotobee.net"==window.location.origin||"http://k.localhost"==window.location.origin;if(!j.isLastChapter()){var o=ph.join(bookPath,S.data.packageURL,j.getChapterURL(currentIndex+1)),r=document.getElementById("nextPage");t(o,r)}if(!j.isFirstChapter()){var i=ph.join(bookPath,S.data.packageURL,j.getChapterURL(currentIndex-1)),a=document.getElementById("prevPage");t(i,a)}}function L(e){for(var t=0;t<q.length;t++)if(q[t].url==e){var n=q[t];return q.splice(t,1),q.push(n),n}}function O(){timeOut(function(){d.update(null)},1e3)}function M(t,n,r){n||(n={}),e.get(cacheBust(t)).success(function(e){config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e));for(var n=parser.parseFromString(e,"text/html"),o=b("contentHtml")(n,t),i=n.getElementsByTagName("meta"),a=null,s=0;s<i.length;s++){var c=i[s].getAttribute("name");if(c&&"viewport"==c.toLowerCase()){a={};var l=i[s].getAttribute("content");if(!l)break;for(var d=l.split(","),u=0;u<d.length;u++){var p=d[u].split("=");a[p[0].trim()]=Number(p[1].trim())}}}b("js")(n).then(function(e){b("styles")(n,{path:t}).then(function(i){var s,c=n.getElementsByTagName("title");if(c.length)s=c[0].textContent.trim();else{var l=n.getElementsByTagName("h1");l.length&&(s=l[0].textContent.trim())}s||(s=S.data.book.meta.dc.title);var d={url:t,title:s,viewport:a,content:o.outerHTML,styles:i,script:e};j.addToCache(d),r&&r(d)})})}).error(function(){n.showError&&(o.update({error:"networkError",ref:ref}),n.deferred&&n.deferred.reject({}),O())})}var H,R,P,D,z,F,j={},V=[],q=[];return j.busy=!0,j.initialize=function(){currentIndex=null,H=S.data.epub.spine.getElementsByTagName("itemref").length;var e=S.data.book.chapters?S.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+m.get("noTOC")+"</h5>";replaceHTML(document.getElementById("chaptersInner"),e),c.setOb("title",replaceHTML(c.getOb("title"),S.data.book.meta.dc.title)),n.addBookStat({type:"view"}),R||(m.addListener(function(){var e=document.getElementById("chaptersInner");if(e){var t=S.data.book.chapters?S.data.book.chapters:'<h5 class="panelEmpty"><i class="icon ion-alert-circled"></i> '+m.get("noTOC")+"</h5>";replaceHTML(e,t)}}),R=!0),b("bookSetup")(),B();var t=0,o=0;if(null!=j.startChapter&&"book"==config.kotobee.mode){var r="/reader/chapter/"+j.startChapter;return j.startHash&&(r+="/"+j.startHash),T.path(r),I(),a.trigger(),void y.$apply()}S.readSlot("lastLoc"+S.getBookId(),function(e){S.readSlot("lastLocY"+S.getBookId(),function(n){config.preserveLoc&&"app"!=config.kotobee.mode&&(t=e?Number(e):0,o=n?Number(n):0),null!=config.kotobee.lastchapter&&(t=Number(config.kotobee.lastchapter));var r=s.getBookmark();r&&(t=Number(r));var i={noPopup:!0};o&&(i.scroll=o),j.loadChapterByIndex(t,i).then(function(){I(),a.trigger()})})})},j.clearCache=function(){q=[]},j.addListener=function(e){V.push(e)},j.removeListener=function(e){for(var t=V.length;t--;)V[t]==e&&V.splice(t,1)},j.loadLocation=function(e,t){var n=x.defer();if(t||(t={}),e.match(/[^0-9.]/g))f.safeAnchorScroll("content",e,!0),n.resolve();else{var o=h.getElemsByLocation(e);if(!o[0])return;f.safeScrollToElem("content",o[0],!0),n.resolve()}return n.promise},j.indexFromUrl=function(e){var t;e=ph.removeHash(ph.normalize(e));for(var n=S.data.epub.manifest.getElementsByTagName("item"),o=0;o<n.length;o++)if(ph.removeHash(ph.normalize(n[o].getAttribute("href")))==e){t=n[o].getAttribute("id");break}for(n=S.data.epub.spine.getElementsByTagName("itemref"),o=0;o<n.length;o++)if(n[o].getAttribute("idref")==t)return o},j.nextChapter=function(){!j.isLastChapter(),j.isLastChapter()?r.toast(m.get("inLastChapter")):T.path("/reader/chapter/"+(currentIndex+1))},j.prevChapter=function(){!j.isFirstChapter(),j.isFirstChapter()?r.toast(m.get("inFirstChapter")):T.path("/reader/chapter/"+(currentIndex-1))},j.loadChapterByIndex=function(e,t){var n=x.defer();if(void 0==e&&(e=currentIndex),0>e)return n.resolve(),n;e>H&&(e=0);var o=j.getChapterURL(e);return t||(t={}),t.index=e,y.renderScope.applyHeader("default"),P&&clearTimeout(P),$(),setTimeout(function(){D=Math.round(1e4*Math.random());var r={page:e,animID:D};A(r,function(){j.loadChapterByURL(o,t,function(){setTimeout(function(){r.animID==D&&($(),N(),n.resolve())},mobile?500:0)})})}),n.promise},j.urlMatchesIndex=function(e,t){if(null!=t){var n,o=ph.removeHash(ph.normalize(e)),r=S.data.epub.spine.getElementsByTagName("itemref")[t];if(r){for(var i=S.data.epub.manifest.getElementsByTagName("item"),a=0;a<i.length;a++)i[a].getAttribute("id")==r.getAttribute("idref")&&(n=i[a].getAttribute("href"));return n?ph.removeHash(ph.normalize(n))==ph.removeHash(ph.normalize(o)):!1}}},j.applyChapterStateFromURL=function(e,t){if(t||(t={}),0==e.indexOf("#"))return void T.path("/reader/chapter/"+currentIndex+"/"+e.substr(1));var n=ph.getHash(e),o=t.index?t.index:j.indexFromUrl(e);if(null!=o){if(j.urlMatchesIndex(e,currentIndex)){if(currentIndex=o,!n)return void v.$getByHandle("content").scrollTop(!0);if(n==i.hash)return void j.loadLocation(n)}var r="/reader/chapter/"+o;n&&(r+="/"+n),T.path(r),y.$$phase||y.$apply()}},j.loadChapterByURL=function(e,t,o){t||(t={});var r=x.defer();if(0==e.indexOf("#"))return o&&o(),j.loadLocation(e.substr(1));var a=t.hash?t.hash:ph.getHash(e),s=t.index?t.index:j.indexFromUrl(e);if(null==s)return void(o&&o());if(j.urlMatchesIndex(e,currentIndex))return currentIndex=s,a?(o&&o(),j.loadLocation(a)):(i.hash?(v.$getByHandle("content").scrollTop(!0),r.resolve()):r.resolve(),o&&o(),r.promise);if(desktop){var c=require("nw.gui");c.App.clearCache()}return kInteractive.clearAudioVideo(document),S.data.book.chapter.absoluteURL&&j.addToCache({url:S.data.book.chapter.absoluteURL,title:S.data.book.chapter.title,viewport:S.data.book.chapter.viewport,content:document.getElementById("epubInner").innerHTML,styles:w.getStyles(),script:C.getScript()}),currentIndex=s,mobile&&v.$getByHandle("content").resize(),j.busy=!0,j.loadChapterByURLRaw(e,t).then(function(e){if(j.busy=!1,t.scroll){var r=v.$getByHandle("content");r.scrollTo(0,t.scroll,!1)}config.kotobee.cloudid&&(config.kotobee["public"]||n.setLastChapter()),a?(j.loadLocation(a),O(),o&&o()):setTimeout(function(){f.reset(),C.replaceScript(e?e:[]),O(),o&&o()},30)})},j.addToCache=function(e){var t=L(e.url);return t?(t.url=e.url,t.title=e.title,t.viewport=e.viewport,t.content=e.content,t.styles=e.styles,void(t.script=e.script)):(q.length>20&&q.shift(),void q.push(e))},j.loadChapterByURLRaw=function(e,o){function r(){M(S.data.book.chapter.absoluteURL,{showError:!0,deferred:a},function(e){i(e.title,e.content,e.viewport,e.styles,e.script)})}function i(e,o,r,i,l,d){S.data.book.chapter.title=e,t.send({verb:"navigated",activity:(currentIndex?"Chapter "+currentIndex+": ":"")+e}),n.addStat({action:"chapter",param:e});var u=replaceHTML("epubInner",o);pauseVideoAndAudio(u),c.setOb("epubContent",document.getElementById("epubContent")),c.getOb("epubContainer").focus(),r&&(r.width&&(c.getOb("epubContent").style.width=r.width-0+"px"),r.height&&(c.getOb("epubContent").style.height=r.height-0+"px")),S.data.book.chapter.viewport=r,S.data.book.chapter.notLastChapter=!j.isLastChapter(),S.data.book.chapter.notFirstChapter=!j.isFirstChapter();var p=document.getElementById("chapters");removeClass(p,["rfl","fxl"]),addClass(p,S.data.book.chapter.viewport?"fxl":"rfl"),kInteractive.postRender(document),w.replaceStyles(i),config.preserveLoc&&"app"!=config.kotobee.mode&&S.writeSlot("lastLoc"+S.getBookId(),currentIndex),S.writeSlot("lastLocY"+S.getBookId(),0);for(var g=0;g<V.length;g++)V[g]("newChapter");b("contentJs")(d).then(function(){h.reset(),f.unlock(),s.setBookmark(currentIndex);var t={};t.id="chapter-"+currentIndex,t.description="View chapter: "+e,t.learnerResponses="Viewed",t.type="other",t.timestamp=new Date,s.setInteractions([t]),a.resolve(l)})}var a=({func:arguments.callee,args:arguments},x.defer());o||(o={}),S.data.book.chapter.url=e,S.data.book.chapter.absoluteURL=ph.join(bookPath,S.data.packageURL,S.data.book.chapter.url);ph.getHash(S.data.book.chapter.url);f.disable(),f.lock(),d.update(null);var l=L(S.data.book.chapter.absoluteURL);return l?i(l.title,l.content,l.viewport,l.styles,l.script,!0):(o.noPopup,r()),a.promise},j.clearContent=function(){replaceHTML("epubInner","")},j.getChapterURL=function(e){void 0==e&&(e=currentIndex);try{j.currentID=S.data.epub.spine.getElementsByTagName("itemref")[e].getAttribute("idref")}catch(t){}var n=getElementsByAttribute(S.data.epub.manifest,"item","id",j.currentID)[0].getAttribute("href");return n},j.isFirstChapter=function(){return 0==currentIndex},j.isLastChapter=function(){return currentIndex==H-1},j}]),app.factory("crdv",["stg","status","error","translit","$rootScope","$http","$ionicSideMenuDelegate",function(e,t,n,o,r,i,a){function s(){e.data.settings.rtl?a.toggleLeft():a.toggleRight()}function c(){try{return cordova,!0}catch(e){return!1}}function l(e,n,o,r){try{t.updateProgress(0),e.getEntries(function(i){function a(){if(s>=i.length)return void e.close(function(){o&&o()});t.updateProgress(s/i.length);var c=i[s];s++,c.getData(new zip.BlobWriter,function(e){try{if("/"==c.filename.substr(-1))return void a();u.writeFile(e,ph.join(n,c.filename),u.libEbooksDirectory,function(){a()})}catch(t){r&&r()}},function(){})}var s=0;a()})}catch(i){r&&r()}}function d(e){var t="";switch(e.code){case FileError.QUOTA_EXCEEDED_ERR:t="QUOTA_EXCEEDED_ERR";break;case FileError.NOT_FOUND_ERR:t="NOT_FOUND_ERR";break;case FileError.SECURITY_ERR:t="SECURITY_ERR";break;case FileError.INVALID_MODIFICATION_ERR:t="INVALID_MODIFICATION_ERR";break;case FileError.INVALID_STATE_ERR:t="INVALID_STATE_ERR";break;default:t="Unknown Error"}}var u={};return u.initialize=function(t,o){return t.putTest("in1"),c()?(t.putTest("in3"),e.data.cordova=!0,t.putTest("in4"),t.putTest("in5"),t.$$phase||t.$apply(),u.initDirectories(function(){i.get("permit.json").success(function(e){function t(){var e={error:"errorAndCallback",msg:"noAppPermit",cb:u.exit};n.update(e),r.$$phase||r.$apply()}var i;(i="udid"==e.type?window.plugins.uniqueDeviceID.get:"mac"==e.type?window.MacAddress.getMacAddress:window.plugins.imeiplugin.getImei)(function(n){n||t();try{for(var r,i=e.list.split("\n"),a=0;a<i.length;a++){var s=i[a].trim().split(" ")[0].trim(),c=i[a].trim().split("/")[0].trim();if(s==n||c==n){r=!0;break}}}catch(l){return void t()}r?o():t()},t)}).error(function(){o()})}),document.addEventListener("menubutton",s,!1),void(t.$$phase||t.$apply())):void o()},u.showKeyboard=function(){try{{cordova.plugins.Keyboard.show()}}catch(e){}},u.tts=function(e,t){TTS.speak(e,function(){t(!0)},function(){u.toast(o.get("ttsUnavailableMsg")),t(!1)})},u.toast=function(e){c()&&window.plugins.toast.showShortBottom(e)},u.copyToClipboard=function(e){if(c())try{cordova.plugins.clipboard?cordova.plugins.clipboard.copy(e):window.plugins.clipboard.copy(e),u.toast(o.get("copiedToClipboard"))}catch(t){}},u.share=function(e){if(c())try{window.plugins.socialsharing.share(e)}catch(t){}},u.createPDF=function(e,t){try{var n=new jsPDF;margins={top:10,bottom:0,left:10,width:180},n.fromHTML(e,margins.left,margins.top,{width:margins.width},function(){try{cordova,u.docDirectory.getFile(t,{create:!0},function(e){e.createWriter(function(e){e.onwriteend=function(){},e.onerror=function(){},e.write(n.output()),u.toast(o.get("pdfSaved"))},d)},d)}catch(e){try{setTimeout(function(){n.save(t)},1e3)}catch(e){}}},margins)}catch(r){}},u.initDirectories=function(e){function t(e){}window.requestFileSystem=window.requestFileSystem||window.webkitRequestFileSystem,window.requestFileSystem(window.TEMPORARY,10485760,function(n){u.cacheDirectory=n.root,window.requestFileSystem(window.PERSISTENT,0,function(n){u.docDirectory=n.root;var o="kotobeeReader";r.readerApp?o="kotobeeReaderApp":config.kotobee.cloudid&&(o+=config.kotobee.cloudid),u.docDirectory.getDirectory(o,{create:!0},function(n){u.appDirectory=n,u.appDirectory.getDirectory("library",{create:!0},function(n){u.libEbooksDirectory=n,u.appDirectory.getDirectory("local",{create:!0},function(n){u.localDirectory=n,u.localDirectory.getDirectory("books",{create:!0},function(n){u.localBooksDirectory=n,u.localDirectory.getDirectory("thumbs",{create:!0},function(t){u.localThumbsDirectory=t,e()},t)},t)},t)},t)},t)},t)},t)},u.exit=function(){c()&&(navigator.app?navigator.app.exitApp():navigator.device&&navigator.device.exitApp())},u.applyExistingBooksOld=function(e,t){function n(e){return Array.prototype.slice.call(e||[],0)}if(!c())return void t();var o=u.libEbooksDirectory.createReader(),r=[],i=function(){o.readEntries(function(o){if(o.length)r=r.concat(n(o)),i();else{for(var a=0;a<r.length;a++)for(var s=r[a].name,c=0;c<e.length;c++)e[c].path==s&&(e[c].exists=!0);t()}},function(){})};i()},u.applyExistingBooks=function(t){if(c()&&(t||e.data.currentLibrary&&(t=e.data.currentLibrary.books),t)){for(var n=0;n<t.length;n++)t[n].exists=!1;for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].favorite=!1;for(var o=0;o<e.data.downloaded.length;o++){var i=e.data.downloaded[o].path;e.data.downloaded[o].favorite=null;for(var n=0;n<t.length;n++)if(t[n].path==i){t[n].exists=!0,e.data.downloaded[o].favorite=t[n].favorite;break}}r.$$phase||r.$apply()}},u.vibrate=function(e){c()&&(e||(e=40),ios||(ios&&(e/=4),navigator&&navigator.notification&&navigator.notification.vibrate&&navigator.notification.vibrate(e)))},u.deleteEbook=function(t,n){u.libEbooksDirectory.getDirectory(t.path,{},function(o){o.removeRecursively(function(){for(var o=0;o<e.data.downloaded.length;o++)e.data.downloaded[o].path==t.path&&(t.exists=!1,e.data.downloaded.splice(o,1),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){n()}))},function(){})},d)},u.writeEbook=function(t,n,o,r){var i=o;u.libEbooksDirectory.getDirectory(n.path,{create:!0},function(){var o=ph.join(n.path,t);u.writeFile(i,o,u.libEbooksDirectory,function(){u.unzipViaPlugin(ph.join(u.libEbooksDirectory.nativeURL,o),ph.join(u.libEbooksDirectory.nativeURL,n.path,"EPUB"),function(){n.exists=!0,e.data.downloaded.push(n),u.applyExistingBooks(e.data.currentLibrary.books),e.writeSlot("downloaded"+e.getBookId(!0),e.data.downloaded,function(){r()})})})})},u.unzip=function(e,t,n,o){u.unzipBlob(e,t,n,o)},u.unzipBlob=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.BlobReader(e),function(e){l(e,t,n,o)})},u.unzipViaPlugin=function(e,t,n,o){zip.unzip(e,t,n,o)},u.unzipURLOld=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",zip.createReader(new zip.HttpReader(e),function(e){l(e,t,n,o)})},u.unzipData64=function(e,t,n,o){zip.workerScriptsPath="lib/zip/",setTimeout(function(){zip.createReader(new zip.Data64URIReader(e),function(e){setTimeout(function(){l(e,t,n,o)},100)})},100)},u.writeFile=function(e,t,n,o){var r=ph.basename(t);try{u.getDirectoryRelativeToBooks(ph.normalize(t),n,function(t){try{t.getFile(r,{create:!0},function(t){t.createWriter(function(t){function n(){var a=Math.min(i,e.size-r),s=e.slice(r,r+a);t.write(s),r+=a,t.onwrite=function(){r<e.size?n():o&&o(!0)},t.onerror=function(){o&&o(!1)}}var r=0,i=4194304;n()},d)},function(){})}catch(n){}})}catch(i){}},u.getDirectoryRelativeToBooks=function(e,t,n){t||(t=u.libEbooksDirectory);var o=e.split("/");if(1==o.length)return void n(t);var r=o[0];t.getDirectory(r,{create:!0},function(e){o.shift();var t=o.join("/");u.getDirectoryRelativeToBooks(t,e,n)},function(){})},u.openInNativeBrowser=function(e){try{return void window.open(e,"_system")}catch(t){}},u}]),app.factory("cssParser",["$http","cache","stg",function(e,t){var n,o,r={},i=[];return r.clearCache=function(){i=[]},r.inject=function(t,o){function r(e){for(var t=0;t<i.length;t++)if(i[t].url==e)return i.push(i[t]),i[t]}function a(e){i.length>5&&i.shift(),i.push(e)}function s(o,i){function d(e){e&&(l+=e),n++,n<t.length?s(t[n],i):(l="#epubContent { background-color:#fe87d0 !important} "+l,i&&i(l))}if(!o||o.indexOf("EPUB/css/kotobeeInteractive.css")>=0)return void d();var u=r(o);u?d(u.val):e.get(cacheBust(o)).success(function(e){var t=/url\((.*?)\)/g;e=e.replace(t,function(e,t){return 0==t.indexOf('"')&&(t=t.substr(1,t.length-2)),0==t.indexOf("'")&&(t=t.substr(1,t.length-2)),-1==t.indexOf("http://")&&-1==t.indexOf("https://")&&(t=ph.join(o,t)),"url("+t+")"}),e=e.replace(/\/\*[\s\S]*?\*\//g,"");for(var n="#epubContainer.stylesEnabled #epubContent",r=e.split("}"),i=0;i<r.length;i++)if(r[i].indexOf("@keyframes")>=0||r[i].indexOf("@-webkit-keyframes")>=0||r[i].indexOf("@-moz-keyframes")>=0)for(var s=i+1;s<r.length&&""!=r[s].trim();s++)r[i]+="}"+r[s];else{var l=r[i].split("{");if(!(l.length<=1)){l[0]=l[0].replace(";",",");for(var u=l[0].split(","),s=0;s<u.length;s++)if(u[s]=" "+u[s],"@"!=u[s].trim()[0]){var p=u[s].toLowerCase().split("body");p.length>1&&(p[0]="",u[s]=p.join("")),u[s]=" "+n+u[s]}l[0]=u.join(","),r[i]=l.join("{")}}e=r.join("}"),e=c(e),a({url:o,val:e}),d(e)}).error(function(){d()})}function c(e){var t=e;return t=t.replace(/\/\*(?:(?!\*\/)[\s\S])*\*\/|[\r\n\t]+/g,""),t=t.replace(/ {2,}/g," "),t=t.replace(/ ([{:}]) /g,"$1"),t=t.replace(/([;,]) /g,"$1"),t=t.replace(/ !/g,"!")}var l="";n=0,s(t[n],o)},r.getStyles=function(){return o},r.replaceStyles=function(e){for(var t,n=document.getElementsByTagName("style"),r=0;r<n.length;r++)if(void 0!=n[r].getAttribute("kotobee")){t=n[r];break}o=e,t=replaceHTML(t,o)},r.hideStyles=function(){removeClass(t.getOb("epubContainer"),"stylesEnabled")},r.showStyles=function(){addClass(t.getOb("epubContainer"),"stylesEnabled")},r.stylize=function(e,t){for(var n=document.getElementById(e),o=n.getAttribute("style"),r=Object.keys(t),i=o?o+";":"",a=0;a<r.length;a++)i+=r[a]+":"+t[r[a]]+";";n.setAttribute("style",i)},r}]),app.factory("design",["cssParser","$interpolate","$http",function(e,t,n){var o,r,i={};return i.getBgStyle=function(){return o||(o={"background-image":'url("'+(config.splashBg?"imgUser/"+config.splashBg:rootDir+"img/ui/defaultWelcomeBG.jpg")+'")',"background-color":config.splashBgColor?config.splashBgColor:"white",color:(config.splashColor?config.splashColor:"#000")+" !important","background-size":config.splashBgSize?config.splashBgSize:"cover"},"stretch"==o["background-size"]&&(o["background-size"]="100% 100%")),o},i.injectUserCSS=function(e){function o(){for(var n=document.getElementsByTagName("style"),o=0;o<n.length;o++)if(n[o].hasAttribute("user")){n[o].innerHTML=t(r)(e);break}}r?o():n.get(cacheBust(rootDir+"css/user.css")).success(function(e){r=e,o()})},i.stylize=function(t,n){e.stylize(t,n)},i}]),app.factory("error",["modals","translit","$injector","$location","$ionicHistory",function(e,t,n,o,r){var i={},a=[];return i.modal=null,i.update=function(s){var c,l=n.get("backend");if(s)switch(s.error){case"s_authError":"library"==config.kotobee.mode&&l.cloudParam("entry")?c={mode:"login",dynamic:!0,animation:"slide-in-up",loginOptions:{}}:(o.path("/login"),r.clearHistory());break;case"networkError":c={mode:"networkError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"localonlyError":c={mode:"localOnlyError",errorOptions:{ref:s.ref,retry:i.retry}};break;case"errorAndCallback":c={mode:"generalError",errorOptions:{msg:t.get(s.msg),cb:s.cb}};break;default:c={mode:"generalError",errorOptions:{msg:t.get(s.error)}}}for(var d=0;d<a.length;d++)a[d].error==s.error&&a[d].func(c);c&&e.show(c)},i.retry=function(t){e.hide(),timeOut(function(){t.func.apply(null,t.args)},100)},i.detect=function(e,t){a.push({error:e,func:t})},i.removeDetection=function(e,t){for(var n=0;n<a.length;n++)if(t==a[n].func&&e==a[n].error)return void a.splice(n,1)},i}]),app.factory("initializer",["$rootScope","translit","scorm","cssParser","tinCan","$location","chapters","error","modals","$ionicHistory","$ionicPlatform","crdv","cache","auth","design","stg","backend","settings",function(e,t,n,o,r,i,a,s,c,l,u,p,f,g,m,h,v,b){function y(){document.onkeydown=function(t){"app"!=config.kotobee.mode&&document.activeElement&&"epubContainer"==document.activeElement.id&&(c.shown()||(t=t||window.event,"37"==t.keyCode?(a.prevChapter(),e.$$phase||e.$apply()):"39"==t.keyCode&&(a.nextChapter(),e.$$phase||e.$apply())))}}function k(){function e(e){var t=e.data.split(":");"next"==t[0]?a.nextChapter():"prev"==t[0]?a.prevChapter():"notebook"==t[0]?angular.element(document.getElementById("tabMenu")).scope().notebookClicked():"goto"==t[0]&&i.path("/reader/chapter/"+Number(t[1]))}window.addEventListener("message",e,!1),window.kbOpenChapterURL=function(e){e&&(-1==e.indexOf(":/")&&(e=ph.join(h.data.book.chapter.url,e)),a.applyChapterStateFromURL(e))
}}function w(e){var t=document.getElementById("iconDetector");C(t,function(){B||(B=setTimeout(function(){t.style.opacity=1,e&&e()},8e3)),t.offsetWidth<10?setTimeout(function(){w(e)},1e3):(clearTimeout(B),t.style.opacity=1,setTimeout(function(){e&&e()},1e3))})}function C(e,t){e.className="",setTimeout(function(){e.className="icon fa fa-cog fa-spin size16",setTimeout(t,400)},500)}function T(){if(x)for(;x.items.length;)x.removeAt(0);E()}function E(){function n(){this.label.toLowerCase()==t.get("exit").toLowerCase()&&i.App.quit()}function o(){var t=this.label;setTimeout(function(){for(var n=0;n<h.data.languages.length;n++)if(h.data.languages[n].label==t)return h.data.settings.language=h.data.languages[n].val,b.langChanged(),void(e.$$phase||e.$apply())},300)}function r(e,t,n){return t&&(e.click=t),n&&(e.submenu=n),new i.MenuItem(e)}var i=require("nw.gui");x||(x=new i.Menu({type:"menubar"}));var a=new i.Menu;a.append(r({label:t.get("exit")},n)),x.append(r({label:t.get("file")},n,a));for(var s=new i.Menu,c=new i.Menu,l=h.data.languages,d=0;d<l.length;d++)c.append(r({label:l[d].label},o));s.append(r({label:t.get("language")},n,c)),x.append(r({label:t.get("settings")},n,s)),i.Window.get().menu=x}var x,S,I={};I.preInitialize=function(e){e.putTest("preInitialize"),m.stylize("home",m.getBgStyle()),m.injectUserCSS(config);for(var o=I.getLogo(),i=document.getElementsByTagName("link"),a=0;a<i.length;a++)if("shortcut icon"==i[a].getAttribute("rel")){i[a].setAttribute("href",config.icon?config.icon:o.logo);break}e.putTest("preInitialize2"),f.initialize(),r.initialize(),h.initialize(),n.initialize(),h.initializeSettings(function(){b.langChanged(),e.putTest("preInitialize3"),k(),desktop&&E(),native||y(),e.putTest("preInitialize4"),f.setOb("title",replaceHTML(f.getOb("title"),t.get("loading")+"..")),t.addListener(function(){e.putTest("translit.addListener"),desktop&&T(),S||f.setOb("title",replaceHTML(f.getOb("title"),t.get("loading")+"..")),e.putTest("translit.addListener2"),S=!0}),e.putTest("preInitialize5")})},I.getLogo=function(){var e=config.logo?"imgUser/"+config.logo:rootDir+"img/ui/defaultWelcomeLogo.png",t=config.slogan?config.slogan:"";return{logo:e,slogan:t}},I.postInitialize=function(t){t.putTest("postInitialize start"),w(function(){t.putTest("postInitialize start2"),v.initialize(t).then(function(){if(t.putTest("MM"),t.$$phase||t.$apply(),"library"==config.kotobee.mode||e.readerApp){try{h.readSlot("downloaded"+h.getBookId(!0),function(e){h.data.downloaded=e,t.putTest("MMMM")})}catch(n){h.data.downloaded=[]}h.data.downloaded||(h.data.downloaded=[])}else"book"==config.kotobee.mode?(d=h.data,bookPath="epub/"):"app"==config.kotobee.mode||(status.update(),s.update({error:"errorAndCallback",msg:"cantReadConfigFile",cb:p.exit}));g.authenticate(t)}),u.registerBackButtonAction(function(){var t=l.currentView();"forgotPwd"==t.stateId?i.path("/login"):"register"==t.stateId?i.path("/login"):"library"==t.stateId&&e.readerApp?i.path("/app"):c.show({mode:"exit",backdropClickToClose:!1,exitOptions:{exit:function(){p.exit()}}}),e.$apply()},101),I.initialized=!0})};var B;return I}]),app.factory("jsParser",["$http","cache",function(e){var t,n,o,r={},i=[];return r.clearCache=function(){i=[]},r.inject=function(n,o){function r(e){for(var t=0;t<i.length;t++)if(i[t].url==e)return i.push(i[t]),i[t]}function a(e){i.length>5&&i.shift(),i.push(e)}function s(o,i){function d(e){e&&l.push(e),u()}function u(){t++,t<n.length?s(n[t],i):(c(),i&&i(l))}if(!o)return void u();if("code"==o.mode)l.push(o.val),u();else{var p=r(o.val);p?d(p.val):e.get(cacheBust(o.val)).success(function(e){a({url:o.val,val:e}),d(e)}).error(function(){d()})}}function c(){for(var e=0;e<l.length;e++)if(l[e]){var t;l[e].indexOf("window.location.href")>=0&&(t=/window\.location\.href[\s]*?=(.*?)[;\n]/g,l[e]=l[e].replace(t,"try { kbOpenChapterURL($1); } catch(er){};")),l[e].indexOf("event.stopPropagation()")>=0&&(t=/event\.stopPropagation\(\)/g,l[e]=l[e].replace(t,"void(0)")),l[e].indexOf("<![CDATA[")>=0&&(t=/<!\[CDATA\[/g,l[e]=l[e].replace(t,"//<![CDATA["),t=/\]\]>/g,l[e]=l[e].replace(t,"//]]>"))}}var l=[];t=0,s(n[t],o)},r.getScript=function(){return n},r.replaceScript=function(e){if(n=e,o&&o.length)for(var t=0;t<o.length;t++)o[t].parentNode&&o[t].parentNode.removeChild(o[t]);o=[];for(var t=0;t<e.length;t++){var r=document.createElement("script");r.setAttribute("kotobee",""),r.setAttribute("type","text/javascript"),r.innerHTML=e[t],o.push(r);try{document.head.appendChild(r)}catch(i){}}},r}]),app.factory("library",["stg","translit","cache","$rootScope","backend","crdv",function(e,t,n,o,r,i){function a(){l.maxResults=20}function s(){l.maxResults+=6}function c(){for(var e=0;e<d.length;e++)d[e].apply(this,arguments)}var l={},d=[];return l.sortMethod={},l.initialize=function(){l.setBrowserTitle(),a(),d=[]},l.setBrowserTitle=function(){n.setOb("title",replaceHTML(n.getOb("title"),e.data.currentLibrary.name?e.data.currentLibrary.name:t.get("library")))},l.addListener=function(e){d.push(e)},l.getEbooks=function(t,n){function o(n){try{t.favs?e.data.favorites=n:e.data.currentLibrary.books=n}catch(o){}}if(t||(t={}),c("preload",t),!t.accumulated){var d=document.getElementById("libraryThumbs");addClass(d,"dim")}t.more?s():a(),t.sort=l.sortMethod.data,t.sortDir=l.sortMethod.dir,t.max=l.maxResults,r.getEbooks(t,function(r){removeClass(document.getElementById("libraryThumbs"),"dim"),r.error||(i.applyExistingBooks(r),o(r));var a=t.favs?e.data.favorites:e.data.currentLibrary.books;a&&a.length||(r.empty=!0),c("postload",t,r),n&&n(r)})},l}]),app.factory("markers",["$rootScope","error","cache","stg","$location","$injector","$ionicScrollDelegate",function(e,t,n,o,r,i,a){function s(){return r.path()&&0==r.path().indexOf("/reader")?!1:!0}var c={},l=new Array,d={};return c.addMarker=function(e){l.push(e),c.refreshMarker(e)},c.deleteMarker=function(e){for(var t=0;t<l.length;t++)l[t].id==e&&l.splice(t,1)},c.windowResize=function(){s()||(d.width!=window.innerWidth||d.height!=window.innerHeight)&&(c.refreshMarkers(),d.width=window.innerWidth,d.height=window.innerHeight)},c.refreshMarkers=function(){for(var e=0;e<l.length;e++)c.refreshMarker(l[e])},c.refreshMarkerById=function(e){for(var t=0;t<l.length;t++)if(l[t].id==e)return void c.refreshMarker(l[t])},c.getMarker=function(e){for(var t=0;t<l.length;t++)if(l[t].id==e)return l[t]},c.refreshMarker=function(e){var t=e.target();if(t&&e.elem){var r="",s="page";(hasClass(e.elem,"contentSideNoteMarker")||hasClass(e.elem,"contentBookMarker"))&&(s="side");var c=e.elem.offsetParent,l=n.getOb("epubContent");if(c){var d=t.getBoundingClientRect(),u=c.getBoundingClientRect(),p=l.getBoundingClientRect(),f=0,g=0,m=1;if(mobile){var h=a.$getByHandle("content").getScrollPosition();h&&(f=h.top,g=h.left,m=h.zoom)}else f=n.getOb("epubContainer").scrollTop,g=n.getOb("epubContainer").scrollLeft;var v=i.get("nav");m=v.getFxlScale();var b,y,k,w=(d.top-u.top+f)/m;if("side"==s){b=0;var C=p.left-u.left+g,T=u.right-p.right+g;k=o.data.book.chapter.viewport?C:T>C?C:T,30>k&&(k=30),o.data.settings.rtl&&(y=0,b=null)}else{if(0==e.elem.offsetWidth)return;b=(d.left-u.left+g)/m}null!=w&&(r+="top: "+(w+e.offsetTop)+"px; "),null!=b&&(r+="left: "+(b+e.offsetLeft)+"px; "),null!=y&&(r+="right: "+(y-e.offsetLeft)+"px; "),null!=k&&(r+="width: "+k+"px; ");var E=1/m;r+="transform:scale("+E+");-webkit-transform:scale("+E+");-moz-transform:scale("+E+");",""!=r&&(e.elem.style.cssText=r),e.callback&&e.callback()}}},c.show=function(){for(var e=0;e<l.length;e++)l[e].elem.style.visibility="shown"},c.hide=function(){for(var e=0;e<l.length;e++)l[e].elem.style.visibility="hidden"},window.addEventListener("resize",c.windowResize,!0),c}]),app.factory("media",["$ionicModal","tinCan","$rootScope","modals",function(e,t,n,o){var r={};return r.show=function(e){t.send({verb:"viewed image",activity:e.title?e.title:e.thumbnail}),o.show({mode:"image",dynamic:!0,animation:"slide-in-up",image:e})},r.hide=function(){o.hide()},r}]),app.factory("modals",["$ionicModal","$q","$ionicPlatform","$rootScope",function(e,t){function n(){if(i=null,c.length){var e=c[0];if(e){if(i=e,i.hidden)return void n();l.backdropClickToClose=e.backdropClickToClose?e.backdropClickToClose:!1,l.animation=e.animation?e.animation:"zoom-in",d().then(function(){r.modal=e,o&&(o.show(),r.$$phase||r.$apply(),i.timeLimit&&(a=setTimeout(function(){var e=i;s.hide(i);var t={wait:function(){s.hide(),s.show(e)}};s.show({mode:"waitTimeout",timeoutOptions:t})},i.timeLimit)),setTimeout(function(){e.cb&&e.cb(o)},750))})}}}var o,r,i,a,s={},c=[],l={animation:"zoom-in",focusFirstInput:!1,backdropClickToClose:!1};s.setScope=function(e){function t(){for(var e=document.getElementsByClassName("modal-backdrop"),t=e.length;t--;)hasClass(e[t],"hide")&&e[t].parentNode.removeChild(e[t])}r=e,r.hideModal=s.hide,o||d(),r.$on("modal.hidden",function(){a&&clearTimeout(a),setTimeout(function(){c.shift(),n(),t()},500)})};var d=function(){var n=t.defer(),i=clone(l);return i.scope=r,e.fromTemplateUrl(kTemplate("modals/modals.html"),i).then(function(e){o=e,n.resolve()}),n.promise};return s.show=function(e){return o?(c.push(e),q=c,1==c.length&&n(),e):void d().then(function(){s.show(e)})},s.shown=function(){return o?o.isShown():!1},s.hide=function(e,t){o&&(e?i==e?o.hide():e.hidden=!0:o.hide(),t&&t())},s}]),app.factory("nav",["cache","crdv","$ionicGesture","$location","selection","markers","settings","$timeout","chapters","$ionicScrollDelegate","stg",function(e,t,n,o,r,i,a,s,c,l,d){function u(){if(S=l.$getByHandle("content"),mobile){var e=S.getScrollView().options;e.scrollbarFadeDelay=0,e.scrollingY=!0,e.minZoom=.2,e.maxZoom=3.5,e.zooming=!0,d.data.book.chapter.viewport?(e.deceleration=.85,e.scrollingX=!0,e.scrollbarY=!1,setTimeout(function(){S.zoomTo(C.getFxlBestFit(),!1),S.scrollTop(0,0,!1),setTimeout(p,1e3)},500)):(S.scrollTo(0,0,!1),e.zooming&&S.zoomTo(1,!1),e.deceleration=.95,e.scrollbarY=!0,config.textSizeControls||(e.zooming=!1),setTimeout(function(){e.scrollingX=!1,config.textSizeControls||(e.zooming=!1)},500)),setTimeout(i.refreshMarkers,1e3)}else S.scrollTop(!1),d.data.book.chapter.viewport?(S.scrollTop(!1),m(C.getFxlBestFit(),!0)):(S.scrollTo(0,0,!1),m(1,!0))}function p(){if(mobile){var e=C.getFxlScale(),t=C.getFxlBestFit(),n=S.getScrollView().options;n.scrollingX=t>=e?!1:!0}}function f(e){if(!(k()||mobile&&v())){var t=d.data.book.chapter.viewport?1:.8,n=d.data.book.chapter.viewport?100:70;if(!(Math.abs(e.gesture.velocityX)<t||Math.abs(e.gesture.distance)<n||e.gesture.touches.length>1))return!0}}function g(){return o.path()&&0==o.path().indexOf("/reader")?!1:!0}function m(t,n){var o=e.getOb("epubContainer").children[0];b(o)!="scale("+t+")"&&(y(o,"scale("+t+")"),n&&(o.style.transition="initial"),setTimeout(function(){n&&(o.style.transition=null),redrawForChrome(document.body)},500),setTimeout(i.refreshMarkers,1e3))}function h(){var e=document.fullscreenElement||document.webkitFullscreenElement||document.mozFullscreenElement||document.msFullscreenElement;return e?(document.exitFullscreen?document.exitFullscreen():document.webkitExitFullscreen?document.webkitExitFullscreen():document.mozExitFullscreen?document.mozExitFullscreen():document.msExitFullscreen&&document.msExitFullscreen(),!0):void 0}function v(){var e=document.getElementById("readerBody").style.transform||document.getElementById("readerBody").style.webkitTransform;return e&&"translate3d(0px, 0px, 0px)"!=e&&"translate3d(0px, 0, 0)"!=e?!0:void 0}function b(e){return e.style.webkitTransform||e.style.mozTransform||e.style.transform}function y(e,t){autoprefixTransform(e,t)}function k(){return E>T}var w,C={},T=15,E=0,x={};C.init=function(e){n.on("swipeleft",C.swipeLeft,e),n.on("swiperight",C.swipeRight,e),n.on("dragstart",C.dragStart,e),n.on("drag",C.drag,e),n.on("doubletap",C.fxlToggleTapZoom,e),n.on("transformstart",C.transformstart,e),n.on("transformend",C.transformend,e),w||(window.addEventListener("resize",C.windowResize,!0),x.width=window.innerWidth,x.height=window.innerHeight,c.addListener(u),w=!0,document.body.addEventListener("keyup",function(e){27==e.keyCode&&h()}))};var S;return C.windowResize=function(){g()||(x.width!=window.innerWidth||x.height!=window.innerHeight)&&(C.fxlZoomFit(),x.width=window.innerWidth,x.height=window.innerHeight)},C.getScroller=function(){return S},C.transformstart=function(){},C.transformend=function(){if(!g())if(d.data.book.chapter.viewport){var t=C.getFxlScale(),n=C.getFxlBestFit(),o=3;n>t?l.$getByHandle("content").zoomTo(n,!0):t>o&&l.$getByHandle("content").zoomTo(o,!0),p(),C.repaint()}else{if(!config.textSizeControls)return;var r=S.getScrollPosition().zoom,s=r,c=a.getTextSize(),u=Math.round(s*c*10)/10;.2>u&&(u=.2),d.data.settings.textSize=u+"em",a.updateTextSize(),a.writeTextSize(),S.zoomTo(1,!0);var f=angular.element(e.getOb("epubContent")).scope();f.header.mode="textSize",f.$$phase||f.$apply(),setTimeout(i.refreshMarkers,1e3)}},C.repaint=function(){redrawForChrome(e.getOb("epubContent"))},C.resize=function(){S.resize()},C.swipeRight=function(n){if(!g()&&f(n)){if(S.resize(),native&&t.vibrate(),"chapter"==swipeMode)return void(d.data.settings.rtl?c.nextChapter():c.prevChapter());var o=l.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)c.prevChapter();else if(o.getScrollPosition().top<=10)c.prevChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),s(function(){o.scrollBy(0,-o.getScrollView().__clientHeight)},200),s(function(){removeClass(r,"fadeOut")},300)}}},C.swipeLeft=function(n){if(!g()&&f(n)){if(S.resize(),native&&t.vibrate(),"chapter"==swipeMode)return void(d.data.settings.rtl?c.prevChapter():c.nextChapter());var o=l.$getByHandle("content");if(o.getScrollView().__clientHeight>o.getScrollView().__contentHeight)c.nextChapter();else if(o.getScrollPosition().top>=o.getScrollView().__contentHeight-o.getScrollView().__clientHeight-30)c.nextChapter();else{var r=e.getOb("epubContainer");addClass(r,"fadeOut"),s(function(){o.scrollBy(0,o.getScrollView().__clientHeight)},200),s(function(){removeClass(r,"fadeOut")},300)}}},C.dragStart=function(){g()||(d.data.book.chapter.viewport||S.zoomTo(1,!1),E=0,S.freezeScroll(!1))},C.drag=function(){E++},C.fxlToggleTapZoom=function(t){if(e.getOb("epubContent")&&d.data.book.chapter.viewport&&d.data.book.chapter.viewport.width){var n=C.getFxlScale(),o=C.getFxlBestFit();n!=o?C.fxlZoomFit(t):(l.$getByHandle("content").zoomTo(2*C.getFxlBestFit(),!0,t.gesture.center.pageX,t.gesture.center.pageY),r.reset()),setTimeout(p,1e3),setTimeout(i.refreshMarkers,1e3),setTimeout(C.repaint,1e3)}},C.fxlZoomIn=function(){r.reset();{var e=1.2*C.getFxlScale();C.getFxlBestFit()}e>3&&(e=3),mobile?l.$getByHandle("content").zoomTo(e,!0):m(e),setTimeout(p,1e3),setTimeout(i.refreshMarkers,1e3)},C.fxlZoomOut=function(){r.reset();var e=.8*C.getFxlScale(),t=C.getFxlBestFit();t>e&&(e=t),mobile?l.$getByHandle("content").zoomTo(e,!0):m(e),setTimeout(p,1e3),setTimeout(i.refreshMarkers,1e3)},C.fxlZoomFit=function(){e.getOb("epubContent")&&d.data.book.chapter.viewport&&d.data.book.chapter.viewport.width&&(r.reset(),mobile?S.zoomTo(C.getFxlBestFit(),!0):m(C.getFxlBestFit()),setTimeout(p,1e3),setTimeout(i.refreshMarkers,1e3))},C.getFxlBestFit=function(t,n){t||(t={}),t.viewport||(t.viewport=d.data.book.chapter.viewport);var o=30,r=10;mobile||(o=30);var i=t.viewport.width+2*o+2*r,a=t.viewport.height,s=document.getElementById("readerBody"),c=document.getElementById("readerHeader"),l=document.getElementById("tabMenu");n||(n=e.getOb("epubContent"));var u=s.getBoundingClientRect().width/i,p=u;p>=1&&(p=1);var f=(s.getBoundingClientRect().height-c.getBoundingClientRect().height-l.getBoundingClientRect().height)/(a+2*o);f/=p;var g=!1;if(1>f&&f>=.75&&(p*=f,g=!0),p>=1)n.style.setProperty("margin-left","auto","important"),n.style.setProperty("margin-right","auto","important");else if(g){var m=(s.getBoundingClientRect().width-1*r-t.viewport.width*p)/2;n.style.setProperty("margin-left",Math.round(m/p)+"px","important"),n.style.setProperty("margin-right",Math.round(m/p)+"px","important")}else n.style.marginLeft&&(n.style.marginLeft=n.style.marginRight=null);return p},C.getFxlScale=function(){if(mobile)return l.$getByHandle("content").getScrollPosition().zoom;var t=b(e.getOb("epubContainer").children[0]);if(!t)return 1;if(""==t)return 1;var n=t.split("scale");if(n.length<=1)return 1;var o=n[1].split("(");if(o.length<=1)return 1;var r=o[1].split(")");return Number(r[0])},C.fullscreen=function(){var e=document.body;h()||(e.requestFullscreen?e.requestFullscreen():e.webkitRequestFullscreen?e.webkitRequestFullscreen():e.mozRequestFullScreen?e.mozRequestFullScreen():e.msRequestFullscreen&&e.msRequestFullscreen())},C}]),app.factory("popovers",["$ionicPopover","$q","$rootScope",function(e,t,n){function o(){if(0!=s.length){var e=s.shift();e.apply?i.$apply(function(){i.popover=e}):i.popover=e,r&&(r.isShown()||r.show(e.event))}}var r,i,a={},s=[];a.setScope=function(e){i=e,r||c()};var c=function(){var o=t.defer();return i||(i=n),e.fromTemplateUrl(kTemplate("modals/popovers.html"),{scope:i}).then(function(e){r=e,o.resolve()}),o.promise};return a.show=function(e){return r?(s.push(e),void(1==s.length&&o())):void c().then(function(){a.show(e)})},a.shown=function(){return r?r.isShown():!1},a.hide=function(){r&&(i.popover=null,r&&r.hide(),o())},a}]),app.factory("scorm",["scormWrapper",function(e){function t(e){var t=e.getSeconds();10>t&&(t="0"+t);var n=e.getMinutes();10>n&&(n="0"+n);var o=e.getHours();return 10>o&&(o="0"+o),o+":"+n+":"+t}function n(e){var t=e.toISOString(),n=t.split(".");return n.splice(n.length-1,1),n.join(".")}function o(e){var t=Math.floor(e/3600);e-=60*t*60;var n=Math.floor(e/60);return e-=60*n,10>e&&(e="0"+e),10>t&&(t="0"+t),10>n&&(n="0"+n),t+":"+n+":"+e}function r(e){var t="P",n=e,o=31104e3,r=2592e3,i=86400,a=3600,s=60,c=Math.floor(n/o);n=e-c*o;var l=Math.floor(n/r);n=e-l*r;var d=Math.floor(n/i);n=e-d*i;var u=Math.floor(n/a);n=e-u*a;var p=Math.floor(n/s);n=e-p*s;var f=n,t="P"+c+"Y"+l+"M"+d+"DT"+u+"H"+p+"M"+f+"S";return t}function i(){if(p.length){for(var e=Number(c("cmi.objectives._count")),t={},n=0;n<p.length;n++)t[p[n].qid]=p[n];for(var n=0;e>n;n++){var o=c("cmi.objectives."+n+".id");if(o){var r=0;for(var i in t)t[i].objective==o&&(r+=t[i].scoreMax);g.setObjective({id:o,scoreMax:r},!0),g.setObjective({id:o,scoreRaw:0},!0)}}var r=0;for(var i in t)r+=t[i].scoreMax;l(1.2==f?"cmi.core.score.max":"cmi.score.max",r),l(1.2==f?"cmi.core.score.min":"cmi.score.min",0),l(1.2==f?"cmi.core.score.raw":"cmi.score.raw",0);for(var a=0;a<p.length;a++){for(var d=p[a],u=null,m=null,n=0;e>n;n++)d.objective==s("cmi.objectives",n,"id")&&(u=d.objective,m=n);if(u){var h=Number(c("cmi.objectives."+m+".score.raw"));h||(h=0);var v={};v.id=u,v.scoreRaw=d.result*d.weighting+h,v.scoreMin=0,v.scoreScaled=v.scoreRaw/v.scoreMax,v.completionStatus="unknown",v.successStatus="unknown",g.setObjective(v,!0)}var b=Number(c(1.2==f?"cmi.core.score.raw":"cmi.score.raw"));b||(b=0),l(1.2==f?"cmi.core.score.raw":"cmi.score.raw",d.result*d.weighting+b)}}}function a(){e.doLMSCommit("")}function s(e,t,n){var o=c(e+"."+t+"."+n);return o&&""!=o||(o=c(e+"_"+t+"."+n)),o}function c(t){return e.doLMSGetValue(t)}function l(t,n){return e.doLMSSetValue(t,n)}function d(){try{var e=c("cmi.suspend_data");return JSON.parse(e)}catch(t){return[]}}function u(e){try{l("cmi.suspend_data",JSON.stringify(e))}catch(t){}}var p,f,g={};return g.initialize=function(){if(!(config.v<1.2)){kInteractive.scorm=this;try{if(!scormEnabled)return}catch(t){return}e.doLMSInitialize(""),f=e.getAPIVersion(),1.2==f?"not attempted"==c("cmi.core.lesson_status")&&(l("cmi.core.lesson_status","browsed"),a()):"not attempted"==c("cmi.completion_status")&&(l("cmi.completion_status","unknown"),a()),p=d();try{for(var n=0;n<config.scorm.objectives.length;n++){var o=Number(c("cmi.objectives._count"));o||(o=0);for(var r=o,i=config.scorm.objectives[n],u=0;o>u;u++)s("cmi.objectives",u,"id")==i.id&&(r=u);l("cmi.objectives."+r+".id",i.id),1.2!=f&&l("cmi.objectives."+r+".description",i.name)}}catch(t){}a()}},g.setBookmark=function(e,t){try{if(!scormEnabled)return}catch(n){return}l(1.2==f?"cmi.core.lesson_location":"cmi.location",e),t||a()},g.getBookmark=function(){try{if(!scormEnabled)return}catch(e){return}return c(1.2==f?"cmi.core.lesson_location":"cmi.location")},g.setInteractions=function(e){try{if(!scormEnabled)return}catch(t){return}for(var n=0;n<e.length;n++){for(var o=p.length,r=0;r<p.length;r++)p[r].id==e[n].id&&(o=r);p[o]=e[n],g.setInteraction(o,e[n],!0)}i(e),u(p),a()},g.setInteraction=function(e,i,s){try{if(!scormEnabled)return}catch(c){return}i.id&&l("cmi.interactions."+e+".id",i.id),i.result&&l("cmi.interactions."+e+".result",i.result),i.correctResponses&&l("cmi.interactions."+e+".correct_responses.0.pattern",i.correctResponses),i.type&&l("cmi.interactions."+e+".type",i.type),i.weighting&&l("cmi.interactions."+e+".weighting",i.weighting),i.objective&&l("cmi.interactions."+e+".objectives.0.id",i.objective),1.2==f?(i.timestamp&&l("cmi.interactions."+e+".time",t(i.timestamp)),i.latency&&l("cmi.interactions."+e+".latency",o(i.latency)),i.learnerResponses&&l("cmi.interactions."+e+".student_response",i.learnerResponses)):(i.timestamp&&l("cmi.interactions."+e+".timestamp",n(i.timestamp)),i.latency&&l("cmi.interactions."+e+".latency",r(i.latency)),i.learnerResponses&&l("cmi.interactions."+e+".learner_responses",i.learnerResponses),i.description&&l("cmi.interactions."+e+".description",i.description)),s||a()},g.setObjective=function(e,t){try{if(!scormEnabled)return}catch(n){return}for(var o=Number(c("cmi.objectives._count")),r=o,i=0;o>i;i++)s("cmi.objectives",i,"id")==e.id&&(r=i);null!=e.id&&l("cmi.objectives."+r+".id",e.id),null!=e.scoreRaw&&l("cmi.objectives."+r+".score.raw",e.scoreRaw),null!=e.scoreMin&&l("cmi.objectives."+r+".score.min",e.scoreMin),null!=e.scoreMax&&l("cmi.objectives."+r+".score.max",e.scoreMax),1.2==f?null!=e.successStatus&&l("cmi.objectives."+r+".status",e.successStatus):(null!=e.description&&l("cmi.objectives."+r+".description",e.description),null!=e.successStatus&&l("cmi.objectives."+r+".success_status",e.successStatus),null!=e.completionStatus&&l("cmi.objectives."+r+".completion_status",e.completionStatus),null!=e.scoreScaled&&l("cmi.objectives."+r+".score.scaled",e.scoreScaled)),t||a()},g.interactionExistsOld=function(e){try{if(!scormEnabled)return}catch(t){return}for(var n=Number(c("cmi.interactions._count")),o=0;n>o;o++)if(s("cmi.interactions",o,"id")==e)return!0},g.interactionExists=function(e){try{if(!scormEnabled)return}catch(t){return}for(var n=0;n<p.length;n++)if(p[n].id==e)return!0},g.objectiveExists=function(e){try{if(!scormEnabled)return}catch(t){return}for(var n=Number(c("cmi.objectives._count")),o=0;n>o;o++)if(s("cmi.objectives",o,"id")==e)return!0},g}]),app.factory("search",["$http","error","book","chapters","cache","$timeout","$filter","translit","virt","selection","stg",function(e,t,n,o,r,i,a,s,c,l,d){function u(e,t,n,o){function r(e){for(var o=e,r=l.convertElemsToLocation([o],t),i='<span class="searchItem">'+o.textContent+"</span>",a=(i.toLowerCase().indexOf(m.key.toLowerCase()),70),s=i.length+Math.round((a-i.length)/2);;){if(!o.previousSibling)break;if(i.length>=s)break;o.previousSibling.textContent&&(i=o.previousSibling.textContent+i),o=o.previousSibling}a-i.length;for(o=e;;){if(!o.nextSibling)break;if(i.length>=a)break;o.nextSibling.textContent&&(i+=o.nextSibling.textContent),o=o.nextSibling}m.result[n].matches.push({chapter:n,elem:e,hint:i.trim(),location:r})}function i(e){var t=e.textContent.toLowerCase();return(t.match(new RegExp(m.key.toLowerCase(),"g"))||[]).length}if(0==e.children.length)return void(i(e)>0&&r(e));for(var a=0;a<e.children.length;a++)0!=i(e.children[a])&&(o=!1,hasClass(e.children[a],"k-section")&&c.checkIfRequiresParse(e.children[a]),u(e.children[a],t,n,!0));o&&r(e)}function p(e,t){var n=0;e.start&&(n=e.start);var o=f(),r=function(i){return e.limit&&f()-o>=e.limit?void t({results:m.result,more:!0,key:m.key}):void(i?g(n++,r):t({results:m.result,key:m.key}))};g(n,r)}function f(){for(var e=0,t=m.result.length;t--;)if(m.result[t])for(var n=m.result[t].matches.length;n--;)e++;return e}function g(t,n){var o=d.data.epub.spine.getElementsByTagName("itemref");if(t>o.length-1)return void n(!1);var r=o[t].getAttribute("idref"),i=getElementsByAttribute(d.data.epub.manifest,"item","id",r)[0].getAttribute("href"),c=ph.join(bookPath,d.data.packageURL,i);return e.get(cacheBust(c)).success(function(e){config.kotobee.encodekey&&(e=config.v>=1.1?CryptoJS.AES.decrypt(e,config.kotobee.encodekey).toString(CryptoJS.enc.Utf8):kInteractive.XORCipher().decode(config.kotobee.encodekey,e));var o=parser.parseFromString(e,"text/html"),e=a("contentHtml")(o),r=o.getElementsByTagName("title");m.result[t]=[],m.result[t].title=r.length?r[0].textContent:s.get("chapter")+": "+(t+1),m.result[t].matches=[],u(e,e,t),n(!0)}).error(function(){n(!1)})}var m={};return m.start=function(e,t){if(m.key=e.key,m.result=e.array?e.array:new Array,"all"==e.mode)p(e,t);else if("chapter"==e.mode){var n=r.getOb("epubContent");m.result[currentIndex]=[],m.result[currentIndex].matches=[],u(n,n,currentIndex),t({results:m.result,key:m.key})}},m}]),app.factory("selection",["markers","cache","error","stg","virt","$rootScope","$ionicScrollDelegate",function(e,t,n,o,r,a,s){function c(e,t){for(t||(t=e);!e.nextSibling;)if(e=e.parentNode,e==t)return;for(e=e.nextSibling;e.childNodes[0];)e=e.childNodes[0];return"#text"==e.nodeName&&e.textContent.trim()?e:c(e,t)}function l(e,t){for(t||(t=e);!e.previousSibling;)if(e=e.parentNode,e==t)return;for(e=e.previousSibling;e.childNodes.length;)e=e.childNodes[e.childNodes.length-1];return"#text"==e.nodeName&&e.textContent.trim()?e:l(e,t)}function d(e){return 8==e.nodeType||"#text"==e.nodeName||"br"==e.nodeName.toLowerCase()?!0:0==e.offsetWidth?!0:void 0}var u,p,f,g,m,h,v,b,y,k,w,C,T,E,x,S,I,B,A,$,N={},L=-45,O=-10;N.getLocation=function(){return x};var M;N.elementDown=function(e,t){if(k=e,!mobile){var n=!0;"a"==e.nodeName.toLowerCase()&&(n=!1),hasClass(e,"ki-noHighlight")&&(n=!1),e.parentNode&&("a"==e.parentNode.nodeName.toLowerCase()&&(n=!1),hasClass(e.parentNode,"ki-noHighlight")&&(n=!1)),n&&addClass(e,"highlightOver")}redrawForChrome(k.parentElement),C=setTimeout(N.elementHeld,mobile&&!mobileDebug?400:100),mobile&&!mobileDebug?(E=t.touches[0],A=E.clientX,$=E.clientY):(A=t.clientX,$=t.clientY,E=t),document.body.addEventListener(mobile&&!mobileDebug?"touchend":"mouseup",N.elementUp),document.body.addEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",H)};var H=function(e){E=mobile&&!mobileDebug?e.touches[0]:e,"activated"==S&&e.stopPropagation()};N.elementUp=function(){k&&(mobile||removeClass(k,"highlightOver"),k=null,clearTimeout(C)),M&&removeClass(t.getOb("epubContent"),"disableEvents"),M=!1,document.body.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",N.elementUp),document.body.removeEventListener(mobile&&!mobileDebug?"touchmove":"mousemove",H),a.$$phase||a.$apply()},N.elementHeld=function(){Math.abs(E.clientX-A)>(mobile?20:10)||Math.abs(E.clientY-$)>(mobile?20:10)||hasClass(k,"ki-noHighlight")||(addClass(k,"highlightSelected"),J(k),N.elementUp())},N.getSelectedText=function(){for(var e=document.getElementsByClassName("highlightSelected"),t="",n=0;n<e.length;n++)t+=e[n].textContent;return t},N.getElemsByLocation=function(e){var n=t.getOb("epubContent"),o=new Array;if(!e)return o;for(var i=e.split(","),a=0;a<i.length;a++)if(i[a]){for(var s=i[a].split("."),c=n,l=0;l<s.length;l++)c&&(1==l&&r.checkIfRequiresParseAndAnnotations(c.children[Number(s[l])]),c=c.children[Number(s[l])]);o.push(c)}return o},N.expand=function(){f=f.parentNode,F(),f=g=y,V(),mobile&&R(),z()},N.extendRight=function(e){if(!e&&"rtl"==getComputedStyle(f).direction)return void N.extendLeft(!0);if(T){var n=c(f,t.getOb("epubContent"));if(f=n.parentNode,d(f))return void N.extendRight(e)}else{var n=c(g,t.getOb("epubContent"));if(g=n.parentNode,d(g))return void N.extendRight(e)}F(),V(),mobile&&R(),z()},N.extendLeft=function(e){if(!e&&"rtl"==getComputedStyle(f).direction)return void N.extendRight(!0);if(T){var n=l(f,t.getOb("epubContent"));if(g=n.parentNode,d(g))return void N.extendLeft(e)}else{var n=l(f,t.getOb("epubContent"));if(f=n.parentNode,d(f))return void N.extendLeft(e)}F(),V(),mobile&&R(),z()},N.newChapter=function(){mobile&&(e.deleteMarker("anchor1Marker"),e.deleteMarker("anchor2Marker"),u=N.createAnchorMarker("anchor1"),p=N.createAnchorMarker("anchor2"),addClass(u,"disable"),addClass(p,"disable"))},N.getTopCornerLocation=function(){var e=N.getTopCornerElement();return N.convertElemsToLocation([e])},N.getTopCornerElement=function(){for(var e=t.getOb("epubContent"),n=t.getOb("epubContainer"),o=e.children[0],r=s.$getByHandle("content").getScrollPosition().top+25,i=new Array,a=o.getElementsByClassName("k-section"),c=0;c<a.length;c++)hasClass(a[c],"cNone")||i.push(a[c]);for(var l,d=document.getElementById("readerHeader"),u=d.offsetHeight+10,p=60,c=0;c<i.length;c++)for(var f=i[c].getElementsByTagName("*"),g=0;g<f.length;g++){var m=f[g].getBoundingClientRect();if(m.bottom>u){if(m.top>u&&m.top<u+p)return f[g];var h=m.top-u;l?h<l.distance&&m.bottom<u+n.offsetHeight&&(l={elem:f[g],bounds:m,distance:h}):l={elem:f[g],bounds:m,distance:h}}}if(l)return l.elem;for(var c=0;c<i.length;c++)if(i[c].offsetTop-r>0)return i[c];return i[0]},N.getIdArray=function(){for(var e=N.getTopCornerElement(),n=[];;){if(!e)break;if(e==t.getOb("epubContent"))break;e.getAttribute&&e.getAttribute("id")&&n.push(e.getAttribute("id")),e=e.previousSibling?e.previousSibling:e.parentNode}return n};var R=function(){e.refreshMarkerById("anchor1Marker"),e.refreshMarkerById("anchor2Marker")},P=function(e){for(var t=0;e=e.previousSibling;)"#text"!=e.nodeName&&8!=e.nodeType&&t++;return t},D=function(e,n){n||(n=t.getOb("epubContent"));for(var o="";e!=n;){var r=P(e);o=r+"."+o,e=e.parentNode}return""==o?"":o.substr(0,o.length-1)},z=function(){return x=N.convertElemsToLocation(document.getElementsByClassName("highlightSelected"))};N.convertElemsToLocation=function(e,n){var o="";n||(n=t.getOb("epubContent"));for(var r=0;r<e.length;r++)o+=(r?",":"")+D(e[r],n);return o};var F=function(){m=new Array,h=new Array;for(var e=t.getOb("epubContent").parentNode,n=f;;)if(m.push(n),n=n.parentNode,n==e)break;for(n=g;;)if(h.push(n),n=n.parentNode,n==e)break;var o=function(){for(i=0;i<m.length;i++)for(j=0;j<h.length;j++)if(h[j]==m[i])return[h[j],i,j]}();for(y=o[0],v=o[1],b=o[2],i=0;i<y.childNodes.length;i++){if(y.childNodes[i]==m[v-1]){T=!1;break}if(y.childNodes[i]==h[b-1]){T=!0;break}}},V=function(){try{if(_(),addClass(f,"highlightSelected"),addClass(g,"highlightSelected"),f==g)return void(x=D(f));if(f==y)return void(x=D(f));if(g==y)return void(x=D(g));var e=T?g:f,t=T?f:g;q(e,t)}catch(n){}},q=function(e,t,n){var o;if(n||(n="first"),"first"==n){if(e.parentNode==y)return void q(e,t,"second");for(o=e;(o=o.nextSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");q(e.parentNode,t,"first")}else if("second"==n){if(t.parentNode==y)return void q(e,t,"third");for(o=t;(o=o.previousSibling)&&o;)"#text"!=o.nodeName&&8!=o.nodeType&&addClass(o,"highlightSelected");q(e,t.parentNode,n)}else if("third"==n){var r,a=T?h[b-1]:m[v-1],s=T?m[v-1]:h[b-1];for(i=0;i<y.childNodes.length;i++)if(a!=y.childNodes[i]){if(s==y.childNodes[i])break;r&&"#text"!=y.childNodes[i].nodeName&&8!=y.childNodes[i].nodeType&&addClass(y.childNodes[i],"highlightSelected")}else r=!0}},U=function(){_(),mobile&&(addClass(u,"disable"),addClass(p,"disable"),removeClass(u,"tween"),removeClass(p,"tween")),S=null,T=null,N.listener&&N.listener("deactivated")},_=function(){try{var e=document.getElementsByClassName("highlightSelected");if(!e)return;for(var t=e.length;t--;)removeClass(e[t],"highlightSelected");mobile&&r.forceRepaint()}catch(n){}};N.listener=null,N.addSpanAtCloseTag=function(){var e=document.createElement("span"),t=T?f:g;return t.parentNode.insertBefore(e,t.nextSibling),e},N.getSelectedNodes=function(){return document.getElementsByClassName("highlightSelected")
},N.reset=function(){U()},N.deleteNoteMarker=function(t){var n=document.getElementById("note"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("noteMarker"+t)},N.getNoteMarker=function(t){return e.getMarker("noteMarker"+t)},N.createNoteMarker=function(n,o,r){r||(r={});var i=document.getElementById("note"+n.nid);if(!i){var a=document.createElement("span");return a.setAttribute("id","note"+n.nid),addClass(a,r["class"]?r["class"]:"contentNoteMarker"),t.getOb("epubMeta").appendChild(a),e.addMarker({id:"noteMarker"+n.nid,elem:a,offsetTop:-17,target:function(){return this.offsetLeft=hasClass(this.elem,"contentNoteMarker")?o.getBoundingClientRect().width-13:0,o},callback:n.callback}),a}},N.deleteBookMarker=function(t){var n=document.getElementById("bookmark"+t);n&&n.parentNode&&n.parentNode.removeChild(n),e.deleteMarker("bookMarker"+t)},N.createBookMarker=function(n,o){var r=document.createElement("span");return r.setAttribute("id","bookmark"+n.bmid),addClass(r,"contentBookMarker"),t.getOb("epubMeta").appendChild(r),e.addMarker({id:"bookMarker"+n.bmid,elem:r,offsetLeft:0,offsetTop:-10,target:function(){return o},callback:n.callback}),r},N.embedAnchorMarker=function(){},N.createAnchorMarker=function(n){var o=document.createElement("span");return o.setAttribute("id",n+"Marker"),o.setAttribute("anchor",n),addClass(o,"anchorMarker"),t.getOb("epubMeta").appendChild(o),o.addEventListener(mobileDebug?"mousedown":"touchstart",function(e){w=o,addClass(w,"selected"),B=null,document.addEventListener(mobileDebug?"mousemove":"touchmove",W),I&&clearInterval(I),I=setInterval(K,60),document.addEventListener(mobileDebug?"mouseup":"touchend",Y),addClass(t.getOb("epubContent"),"defaultCursor"),S="anchorDragged",e.stopPropagation()}),e.addMarker({id:n+"Marker",elem:o,offsetTop:L,offsetLeft:O,target:function(){var e=0,t=s.$getByHandle("content").getScrollPosition(),o=t.zoom;if(o||(o=1),"anchor1"==n){if(elem=f,!elem)return void(this.offsetLeft=O);var r;try{r="rtl"==getComputedStyle(elem).direction}catch(i){}e=T?r?0:elem.getBoundingClientRect().width/o:r?elem.getBoundingClientRect().width/o:0}else{if(elem=g,!elem)return void(this.offsetLeft=O);var r;try{r="rtl"==getComputedStyle(elem).direction}catch(i){}e=T?r?elem.getBoundingClientRect().width/o:0:r?0:elem.getBoundingClientRect().width/o}return this.offsetLeft=O+e,elem}}),o};var W=function(e){B=e,e.stopPropagation()},K=function(e){try{if(e&&e.stopPropagation(),mobile){if("anchorDragged"!=S)return;if(!B)return}var n;if(mobile){var o=mobileDebug?B:B.targetTouches[0];n=document.elementFromPoint(o.clientX,Math.round(o.clientY+u.offsetHeight/2))}else n=e.target;if(t.getOb("epubContent")==n)return;if(!t.getOb("epubContent").contains(n))return;if((n.textContent.match(new RegExp(" ","g"))||[]).length>1)return;if(mobile)if("anchor1"==w.getAttribute("anchor")){if(f==n)return;f=n}else{if(g==n)return;g=n}else g=n;F(),V(),redrawForChrome(f.parentElement),redrawForChrome(g.parentElement),mobile&&R()}catch(r){}},Y=function(e){try{var n=t.getOb("epubContainer");document.removeEventListener(mobile&&!mobileDebug?"touchend":"mouseup",Y),mobile?(document.removeEventListener(mobileDebug?"mousemove":"touchmove",W),removeClass(w,"selected"),clearInterval(I)):n.removeEventListener("mousemove",K),removeClass(t.getOb("epubContent"),"defaultCursor"),w=null,x=z(),S="selectionFixed",N.listener&&N.listener(S),e.stopPropagation()}catch(o){}},J=function(e){try{var n=t.getOb("epubContainer");f=g=e,mobile?(removeClass(u,"disable"),removeClass(p,"disable"),timeOut(function(){addClass(u,"tween"),addClass(p,"tween")},100),R()):(n.addEventListener("mousemove",K),document.addEventListener("mouseup",Y)),z(),S="activated",N.listener&&N.listener(S)}catch(o){}};return N.active=function(){return"selectionFixed"==S||"activated"==S},N}]),app.factory("settings",["$http","error","book","cache","modals","$ionicScrollDelegate","translit","$timeout","virt","selection","stg","markers","sync","crdv","cssParser",function(e,t,n,o,r,i,a,s,c,l,d,u,p,f,g){var m={};return m.pinchActive=!1,m.stylesInitialize=function(){},m.initialize=function(){m.stylingChanged(),m.lineAdjustChanged(),m.updateTextSize(),u.refreshMarkers()},m.getTextSize=function(){return Number(d.data.settings.textSize.slice(0,-2))},m.updateTextSize=function(){try{var e=o.getOb("epubContent"),t=o.getOb("epubContent").style;if(t.fontSize==d.data.settings.textSize)return;t.fontSize=d.data.settings.textSize;var n,r=o.getOb("epubContainer"),a=e.parentNode.parentNode,s=a.style.webkitTransform||a.style.mozTransform||a.style.transform;n=overflowScroll?o.getOb("epubContainer").scrollTop:Number(s.split(",")[1].slice(0,-2));var l=e.offsetHeight,u=r.offsetTop,p=r.offsetHeight;p+u>l+n?c.safeScroll("content",0,u+l-p,!0):p>l&&i.$getByHandle("content").scrollTop(!1),c.reset()}catch(f){}},m.writeTextSize=function(){d.writeSlot("settings"+d.getBookId(!0),d.data.settings,function(){u.refreshMarkers()})},m.stylingChanged=function(){d.data.settings.styling?g.showStyles():g.hideStyles(),u.refreshMarkers()},m.saveSettings=function(){d.writeSlot("settings"+d.getBookId(!0),d.data.settings)},m.langChanged=function(){d.data.settings.rtl="ar"==d.data.settings.language?!0:!1,d.writeSlot("settings"+d.getBookId(!0),d.data.settings,function(){a.setLang(d.data.settings.language),u.refreshMarkers()})},m.lineAdjustChanged=function(){d.data.settings.lineAdjust?addClass(o.getOb("epubContent"),"adjustedLineHeight"):removeClass(o.getOb("epubContent"),"adjustedLineHeight"),u.refreshMarkers()},m.sync=function(){p.onOnline(function(){native?f.toast(a.get("syncComplete")):r.show({mode:"success",successOptions:{msg:a.get("syncComplete")}})})},m}]),app.factory("status",["$ionicLoading","translit","$q",function(e,t,n){function o(){i&&(clearTimeout(i),i=null)}function r(){o(),s&&(i=setTimeout(function(){a.update().then(function(){a.showAndHide(t.get("statusTimeoutError"),3e3)})},s))}var i,a={},s=1e4;return a.update=function(t,i,c){var l=n.defer();if(c||(c={}),c.dots&&(t+=' <ion-spinner icon="dots" class="loadingSpinner"></ion-spinner>'),c.progress&&(t+='<div class="loadingProgress"></div>'),s=c.timeoutDuration?c.timeoutDuration:1e4,o(),t){r();var d={template:t};for(var u in c)d[u]=c[u];e.show(d),a.updateProgress()}else e.hide();return timeOut(function(){l.resolve()},i?i:250),l.promise},a.updateProgress=function(e){e||(e=0),e>1&&(e=1);var t=document.getElementsByClassName("loadingProgress");t.length&&(t[0].style.width=Math.round(100*e)+"%"),e>0&&r()},a.showAndHide=function(e,t){a.update(e,t).then(function(){a.update()})},a}]),app.factory("stg",["sync","$rootScope",function(e){var t={};return t.data={},t.initialize=function(){t.reset(),t.setLanguages(),preview&&t.clearSlots()},t.initializeSettings=function(e){function n(){t.applyDefaultSettings();try{if(config.defaultLanguage&&(t.data.settings.language=config.defaultLanguage),t.data.settings.navAnim=config.defaultNavAnim?config.defaultNavAnim:"navBookBlock",t.data.settings.navMode=config.defaultNavMode?config.defaultNavMode:"v",!preview)return void t.readSlot("settings"+t.getBookId(!0),function(n){n&&(n.language&&(t.data.settings.language=n.language),n.navAnim&&(t.data.settings.navAnim=n.navAnim),n.navMode&&(t.data.settings.navMode=n.navMode)),e&&e()})}catch(n){}e&&e()}try{t.readSlot("settings"+t.getBookId(!0),function(e){t.data.settings=e,0==t.data.settings.length&&(t.data.settings={}),n()})}catch(o){t.data.settings={},n()}},t.reset=function(){t.resetBook(),t.resetLibrary()},t.setLanguages=function(){t.data.languages=[{label:"English",val:"en"},{label:"Français",val:"fr"},{label:"Español",val:"es"},{label:"Português",val:"pt"},{label:"Nederlands",val:"nl"},{label:"Deutsch",val:"de"},{label:"Magyar",val:"hu"},{label:"Italiano",val:"it"},{label:"Svenska",val:"sw"},{label:"Melayu",val:"ms"},{label:"Polski",val:"pl"},{label:"Român",val:"ro"},{label:"Pусский",val:"ru"},{label:"Türkçe",val:"tr"},{label:"العربية",val:"ar"},{label:"中國",val:"zh"},{label:"日本人",val:"jp"},{label:"한국의",val:"ko"}]},t.resetBook=function(){t.data.epub={},t.data.toc="",t.data.mediaList=[],t.data.packageURL="",t.data.book={},t.data.book.chapter={}},t.resetLibrary=function(){t.data.downloaded=[],t.data.favorites=[],t.data.currentLibrary={}},t.applyDefaultSettings=function(){t.data.settings&&(t.data.settings.styling||(t.data.settings.styling=!0),t.data.settings.textSize||(t.data.settings.textSize="1em"),t.data.settings.lineAdjust||(t.data.settings.lineAdjust=!0),t.data.settings.language||(t.data.settings.language="en"))},t.getBookId=function(e){if(!config.kotobee.cloudid){var n,o="",r="";try{n=t.data.book.meta.dc.identifier}catch(i){}if(desktop){var a=require("nw.gui");r=n?n:a.App.manifest.name+(a.App.manifest.rand?a.App.manifest.rand:"")}else if(native)r=n?n:cordova.rand?cordova.rand:"";else{r=location.href.split("#")[0],r=r.replace("https://","http://"),r=r.replace("http://www.","http://"),r=r.replace("http://","");try{o=e?"":n?n:t.data.book.meta.dc.title}catch(i){}}return"_"+(r+o).replace(/[\/\s:#]/g,"")}return"book"==config.kotobee.mode?"_"+config.kotobee.cloudid:"library"==config.kotobee.mode?"_"+config.kotobee.cloudid+"_"+(e?"":t.data.book.id):void 0},t.addBookmark=function(n,o){t.readSlot("bookmark"+t.getBookId(),function(r){function i(r){r&&(a=r),n.chapter=currentIndex,n.cloudid=config.kotobee.cloudid,a.push(n),t.writeSlot("bookmark"+t.getBookId(),a,function(){return e.queue("bookmark/add",n),o&&o(!0),!0})}var a=r;null!=n.bmid?t.deleteBookmark(n.bmid,null,i):t.uniqueId(a,"bmid",function(e){n.bmid=e,i()})})},t.getBookmarks=function(e){t.readSlot("bookmark"+t.getBookId(),function(t){e&&e(t)})},t.deleteBookmark=function(n,o,r){t.readSlot("bookmark"+t.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].bmid==n){var s=i[a];return i.splice(a,1),void t.writeSlot("bookmark"+t.getBookId(),i,function(){o||e.queue("bookmark/delete",s),r&&r(i)})}})},t.deleteNote=function(n,o,r){t.readSlot("note"+t.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].nid==n){var s=i[a];return i.splice(a,1),void t.writeSlot("note"+t.getBookId(),i,function(){o||e.queue("note/delete",s),r&&r(i)})}})},t.addNote=function(n,o){try{t.readSlot("note"+t.getBookId(),function(r){function i(i){i&&(r=i),n.chapter=currentIndex,n.cloudid=config.kotobee.cloudid;var a={};for(var s in n)"event"!=s&&(a[s]=n[s]);r.push(a),t.writeSlot("note"+t.getBookId(),r,function(){return e.queue("note/add",a),o&&o(!0),!0})}null!=n.nid?t.deleteNote(n.nid,null,i):t.uniqueId(r,"nid",function(e){n.nid=e,i()})})}catch(r){}return!0},t.getNotes=function(e){t.readSlot("note"+t.getBookId(),e)},t.deleteHlight=function(n,o,r){t.readSlot("hlight"+t.getBookId(),function(i){for(var a=0;a<i.length;a++)if(i[a].hid==n){var s=i[a];return i.splice(a,1),void t.writeSlot("hlight"+t.getBookId(),i,function(){o||e.queue("hlight/delete",s),r&&r(i)})}})},t.addHlight=function(n,o){t.readSlot("hlight"+t.getBookId(),function(r){function i(i){i&&(r=i),n.chapter=currentIndex,n.cloudid=config.kotobee.cloudid,r.push(n),t.writeSlot("hlight"+t.getBookId(),r,function(){return e.queue("hlight/add",n),o&&o(!0),!0})}null!=n.hid?t.deleteHlight(n.hid,null,i):t.uniqueId(r,"hid",function(e){n.hid=e,i()})})},t.getHlightById=function(e,n){t.getHlights(function(t){for(var o=0;o<t.length;o++)if(t[o].hid==e)return n&&n(t[o]),t[o]})},t.getHlights=function(e){t.readSlot("hlight"+t.getBookId(),e)},t.addAction=function(e,n){t.readSlot("actions"+t.getBookId(),function(o){o.push(e),t.writeSlot("actions"+t.getBookId(),o,function(){return n&&n(!0),!0})})},t.deleteAction=function(e,n){t.readSlot("actions"+t.getBookId(),function(o){for(var r=0;r<o.length;r++)if(JSON.stringify(e)==JSON.stringify(o[r]))return o.splice(r,1),void t.writeSlot("actions"+t.getBookId(),o,function(){return n&&n(o),o});n&&n()})},t.getActions=function(e){t.readSlot("actions"+t.getBookId(),e)},t.readSlot=function(e,t){var n;if(!chromeApp){if(n=localStorage[e],!n)return t&&t([]),[];var o=JSON.parse(n);return t&&t(o),o}chrome.storage.local.get(e,function(n){n=n?isEmpty(n)?[]:n[e]:[],t&&t(n)})},t.writeSlot=function(e,t,n){if(chromeApp){var o={};o[e]=t,chrome.storage.local.set(o,function(){n&&n()})}else localStorage[e]=JSON.stringify(t),n&&n()},t.clearSlot=function(e,t){chromeApp?chrome.storage.local.remove(e,t):(delete localStorage[e],t&&t())},t.clearSlots=function(e){function n(){if(i++,i>=o.length)return void(e&&e());var r=o[i];0==r.indexOf("note_")?t.clearSlot(r,n):0==r.indexOf("bookmark_")?t.clearSlot(r,n):0==r.indexOf("hlight_")?t.clearSlot(r,n):0==r.indexOf("settings_")&&t.clearSlot(r,n)}var o=[];for(var r in localStorage)o.push(r);var i=-1;n()},t.uniqueId=function(e,n,o){var r=0;n||(n="id");for(var i=0;i<e.length;i++)Number(e[i][n])>r&&(r=Number(e[i][n]));t.readSlot("actions"+t.getBookId(),function(e){for(var t=0;t<e.length;t++)Number(e[t].data[n])>r&&(r=Number(e[t].data[n]));return o&&o(r+1),r+1})},t}]),app.factory("sync",["$injector","translit","$rootScope","$http","error",function(e,t,n,o,r){function i(){n.data.syncing||(n.data.syncing=!0,n.$$phase||n.$apply())}function a(){n.data.syncing&&(n.data.syncing=!1,n.$$phase||n.$apply())}var s,c,l,d,u,p,f,g,m={};return m.initialize=function(){l||(l=e.get("backend")),config.kotobee.cloudid&&(c||(c=e.get("stg")),d||(d=e.get("bookmarks")),u||(u=e.get("notes")),p||(p=e.get("hlights")),f||(f=e.get("chapters")),c.getActions(function(e){s=e,window.addEventListener?(window.addEventListener("offline",m.onOffline,!1),window.addEventListener("online",m.onOnline,!1)):(document.addEventListener("offline",m.onOffline,!1),document.addEventListener("online",m.onOnline,!1))}))},m.trigger=function(){m.offline()?m.onOffline():m.onOnline()},m.offline=function(){if(l.cloudParam("sync"))try{return"NONE"==navigator.network.connection.type.toUpperCase()&&"UNKNOWN"==navigator.network.connection.type.toUpperCase()}catch(e){return!1}},m.onOffline=function(){l.cloudParam("sync")},m.onOnline=function(e){l.cloudParam("sync")&&(g||m.applyChanges(function(){i();var t=({func:arguments.callee,args:arguments},getFormData(l.getAuthVars()));o.post(config.kotobee.liburl+"library/notebook/all",t,postOptions).success(function(t){if(a(),t.error)return r.update(t),void(e&&e());var n=t.notes?t.notes:[],o=t.bookmarks?t.bookmarks:[],i=t.hlights?t.hlights:[];u.deleteAll(!0,function(){u.addNotesFromSync(n,function(){d.deleteAll(!0,function(){d.addBookmarksFromSync(o,function(){p.deleteAll(!0,function(){p.addHlightsFromSync(i,function(){e&&e()})})})})})})}).error(function(){n.data.syncing=!1,r.update({error:"cantLoadNodes"}),e&&e()})}))},m.queue=function(e,t){if(c&&config.kotobee.cloudid){var n={type:e,data:clone(t)};s.push(n),c.addAction(n,function(){m.offline()||g||m.applyChanges()})}},m.applyChanges=function(e){if(a(),l.cloudParam("sync")&&c&&c.data.user&&(c.data.user.email||c.data.user.code))try{var t={func:arguments.callee,args:arguments};if(0==s.length)return g=!1,void(e&&e());i(),g=!0;var n=s[0],d=getFormData(l.getAuthVars());for(var u in n.data)d.append(u,n.data[u]);o.post(config.kotobee.liburl+"library/"+n.type,d,postOptions).success(function(){s.splice(0,1),c.deleteAction(n,function(){m.applyChanges()})}).error(function(){g=!1,setTimeout(a,300),r.update({error:"syncOnConnectionMsg",ref:t})})}catch(p){}},m}]),app.factory("tinCan",["stg","backend",function(e,t){var n={};return n.initialize=function(){},n.send=function(n){t.cloudParam("tincan")&&(n.name=e.data.user.name?e.data.user.name:"User",e.data.user.email?n.email=e.data.user.email:e.data.user.code&&(n.email=e.data.user.code+"@promocode"),n.lrs=t.cloudParam("tincanlrs"),n.lrsver=t.cloudParam("tincanlrsver"),n.lrsuser=t.cloudParam("tincanlrsuser"),n.lrspwd=t.cloudParam("tincanlrspwd"),t.tincan(n))},n}]),app.factory("translit",["$interpolate","$http","$rootScope","cache",function(e,t,n,o){function r(){for(var e=0;e<l.length;e++)l[e](i)}var i,a,s={},c={},l=[];return s.addListener=function(e){l.push(e)},s.setLangOld=function(e){i=e},s.setLang=function(e,s){t.get(cacheBust(rootDir+"locales/"+e+".js")).success(function(t){a=t,i=e,n.data&&(n.data.lc||(n.data.lc=0),n.data.lc=Number(n.data.lc)+1),r(),o.getOb("viewContainer")||o.setOb("viewContainer",document.getElementsByClassName("view-container")[0]),"ar"==e?(addClass(o.getOb("body"),"rtl"),o.getOb("viewContainer").setAttribute("dir","rtl")):(removeClass(o.getOb("body"),"rtl"),o.getOb("viewContainer").setAttribute("dir","ltr")),s&&s()}).error(function(){})},s.get=function(t,n){if(!a)return t;if(!i)return t;if(a[t]&&(t=a[t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},s.getOld=function(t,n){if(c[i][t]&&(t=c[i][t]),n)for(var o=0;o<n.length;o++)t=e(t)(n[o]);return t},s}]),app.factory("virt",["$ionicScrollDelegate","$filter","$location","cache","$q",function(e,t,n,o,r){var i,a,s,c,l={},d=60;l.lock=function(){a=!0},l.unlock=function(){a=!1},l.enable=function(){i||a||(i=!0,c&&clearInterval(c),s=setInterval(u,d),u())},l.disableAfter=function(e){c&&clearInterval(c),c=setInterval(function(){l.disable(),clearInterval(c)},e)},l.disable=function(){i&&(a||(i=!1,clearInterval(s)))};var u=function(){a||t("contentVirt")()};return l.reset=function(){a||(l.reveal(!0),t("contentVirt")("reset"),t("contentVirt")(),l.reveal(!1))},l.checkIfRequiresParse=function(e){parseSecsSeparate&&(hasClass(e,"parsed")||t("contentVirt")("parse",e))},l.checkIfRequiresParseAndAnnotations=function(e){hasClass(e,"parsed")||t("contentVirt")("parseAndAnnotations",e)},l.reveal=function(e){a||t("contentVirt")(e?"reveal":"undoReveal")},l.safeAnchorScroll=function(e,t,n){if(!a){var o=r.defer();l.reveal(!0);var i=document.getElementById(t);return l.safeScrollToElem(e,i,n),timeOut(function(){l.reset(),o.resolve()},1300),o.promise}},l.safeScroll=function(t,n,o,i){if(!a){var s=r.defer();return i||(i=!0),l.reveal(!0),e.$getByHandle(t).scrollTo(Math.round(n),Math.round(o),i),timeOut(function(){l.reset(),s.resolve()},1300),s.promise}},l.safeScrollToElem=function(t,n,r){if(n&&!a){l.reveal(!0);var i=e.$getByHandle(t).getScrollPosition().top-o.getOb("epubContainer").getBoundingClientRect().top-25;return l.safeScroll(t,0,n.getBoundingClientRect().top+i,r)}},l.forceRepaint=function(){var e=document.createTextNode(" ");document.appendChild(),setTimeout(function(){e.parentNode.removeChild(e)},0)},l}]),log("Directives DECLARED!!!"),app.directive("iframeOnload",[function(){return{scope:!1,link:function(e,t){t.on("load",function(){return e.modal.siteOptions.loaded()})}}}]),app.directive("enterWithoutShift",function(){return function(e,t,n){var o;t.bind("keydown keypress",function(t){o=t.shiftKey,o||13===t.which&&(e.$apply(function(){e.$eval(n.enterWithoutShift)}),t.preventDefault())})}}),app.directive("searchheader",["$timeout","$parse",function(e,t){return{restrict:"E",replace:!1,scope:{obj:"=obj",prop:"=prop",kotobeeGradient:"=kotobeeGradient",onValue:"=onValue",offValue:"=offValue",noCancel:"=noCancel",searchKeyOb:"=searchKeyOb",onsearch:"&"},templateUrl:kTemplate("headers/headerSearch.html"),link:function(n,o,r){n.$watch("obj[prop]",function(i){i===t(r.onValue)(n)&&e(function(){o[0].getElementsByTagName("input")[0].focus()})}),n.hide=function(){n.obj[n.prop]=n.offValue}}}}]),app.directive("ngEnter",function(){return function(e,t,n){t.bind("keydown keypress",function(t){13===t.which&&(e.$apply(function(){e.$eval(n.ngEnter)}),t.preventDefault())})}}),app.directive("nextchapterscroll",function(){return{restrict:"E",templateUrl:kTemplate("components/nextChapterScroll.html")}}),app.directive("autofocusme",["$timeout",function(e){return{link:function(t,n){e(function(){n[0].focus()},350)}}}]),app.directive("readerheader",function(){return{restrict:"E",templateUrl:kTemplate("headers/readerHeader.html"),scope:!1}}),app.directive("headerdefault",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerDefault.html"),scope:!1}}),app.directive("headerselection",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSelection.html"),scope:!1}}),app.directive("headersearchitems",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerSearchItems.html"),scope:!1}}),app.directive("headertextsize",function(){return{restrict:"E",templateUrl:kTemplate("headers/headerTextSize.html"),scope:!1}}),app.directive("mouseEvents",["$ionicGesture","settings","nav","stg","$ionicScrollDelegate",function(e,t,n){return{restrict:"A",link:function(e,t){n.init(t)}}}]),app.directive("vanillaScroll",function(){return{restrict:"A",link:function(e,t){t[0].addEventListener("scroll",function(){e.scroll(this)})}}}),app.directive("selectOptions",function(){return{restrict:"E",templateUrl:kTemplate("headers/selectOptions.html")}}),app.directive("media",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/media.html"),scope:!1}}),app.directive("noteitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/noteItem.html")}}),app.directive("bookmarkitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/bookmarkItem.html")}}),app.directive("hlightitem",function(){return{restrict:"E",templateUrl:kTemplate("panels/notebook/hlightItem.html")}}),app.directive("bookThumb",function(){return{restrict:"E",replace:!0,templateUrl:kTemplate("panels/bookThumb.html")}}),app.directive("thumbnail",function(){return{restrict:"A",link:function(e,t){var n="background-size:cover,width:50px,height:50px";t.attr("style",n)}}}),app.directive("showafterimageload",function(){return{restrict:"A",link:function(e,t){t.bind("load",function(e){e.currentTarget.style.opacity=1,autoprefixTransform(e.currentTarget,"translate(-50%, -50%) scale(1)")})}}}),app.factory("bookmarks",["selection","translit","crdv","popovers","stg","cache","modals","virt","chapters",function(e,t,n,o,r,i,a,s,c){function l(e,t){r.readSlot("bookmark"+r.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(c.busy||arrayContainsProperty(n,"bmid",e.bmid)||d.addIcon(e)),n.push(e),r.writeSlot("bookmark"+r.getBookId(),n,t)})}var d={};return d.addBookmark=function(){var o={};o.chapter=currentIndex,o.location=e.getTopCornerLocation(),r.addBookmark(o,function(){d.addIcon(o),n.toast(t.get("bookmarked"))})},d.addBookmarksFromSync=function(e,t){function n(){return o++,o>=e.length?void(t&&t()):void l(e[o],n)}var o=-1;n()},d.addIconIfNotShown=function(e){d.addIcon(e)},d.addIcon=function(n){var r=e.getElemsByLocation(n.location);if(r[0]){var i=e.createBookMarker(n,r[0]);i.className="contentBookMarker",i.setAttribute("bmid",n.bmid),i.setAttribute("bloc",r[0].offsetTop),i.addEventListener("click",function(){s.safeScrollToElem("content",i,!0);var e={};e.bmid=this.getAttribute("bmid"),e.location=this.getAttribute("bloc")}),i.addEventListener("hold",function(){var e=[{name:t.get("delete"),func:function(){d["delete"](n.bmid),o.hide()}},{name:t.get("cancel"),func:function(){o.hide()}}];o.show({mode:"list",listOb:e,backdropClickToClose:!1})})}},d["delete"]=function(t,n,o){e.deleteBookMarker(t),r.deleteBookmark(t,n,o)},d.deleteAll=function(e,t){r.getBookmarks(function(n){function o(){return r++,r>=n.length?void(t&&t()):void d["delete"](n[r].bmid,e,o)}var r=-1;o()})},d}]),app.factory("hlights",["selection","crdv","backend","stg","$rootScope","modals","chapters",function(e,t,n,o,r,i,a){function s(e,t){o.readSlot("hlight"+o.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(a.busy||arrayContainsProperty(n,"hid",e.hid)||c.addHlight(e)),n.push(e),o.writeSlot("hlight"+o.getBookId(),n,t)})}var c={};return c.addHlightsFromSync=function(e,t){function n(){return o++,o>=e.length?void(t&&t()):void s(e[o],n)}var o=-1;n()},c.addHlight=function(t){for(var n=document.getElementsByClassName("hlight"+t.hid),o=n.length;o--;)n[o].style.backgroundColor=null,removeClass(n[o],"contentHlightBG"),removeClass(n[o],"hlight"+t.hid);n=e.getElemsByLocation(t.location);for(var o=n.length;o--;)n[o]&&(addClass(n[o],"contentHlightBG"),addClass(n[o],"hlight"+t.hid),n[o].style.backgroundColor=t.color);return c},c.showPopup=function(t,n){var a=r.$new(!0);a.hlightOb={},t||(t={});var s={};s.save=function(r){t.chapter||(t.chapter=currentIndex),t.color=r,t.src=e.getSelectedText(),o.addHlight(t,function(){c.addHlight(t),timeOut(function(){i.hide(),n&&n(!0)},300)})},t.color&&(s.color=t.color),t.hid&&(s["delete"]=function(){c["delete"](t.hid,null,function(){timeOut(function(){i.hide(),n&&n()},300)})}),i.show({mode:"hlight",hlightOptions:s})},c["delete"]=function(e,t,n){for(var r=document.getElementsByClassName("hlight"+e),i=r.length;i--;)i==r.length-1&&removeClass(r[i],"last"),removeClass(r[i],"contentHlightBG"),r[i].style.backgroundColor=null,removeClass(r[i],"hlight"+e);o.deleteHlight(e,t,n)},c.deleteAll=function(e,t){o.getHlights(function(n){function o(){return r++,r>=n.length?void(t&&t()):void c["delete"](n[r].hid,e,o)}var r=-1;o()})},c}]),app.factory("notes",["selection","translit","crdv","stg","$rootScope","cache","modals","popovers","virt","$timeout","chapters",function(e,t,n,o,r,i,a,s,c,l,d){function u(e,t){o.readSlot("note"+o.getBookId(),function(n){n||(n=[]),e.chapter==currentIndex&&(d.busy||arrayContainsProperty(n,"nid",e.nid)||p.addIcon(e)),n.push(e),o.writeSlot("note"+o.getBookId(),n,t)})}var p={};return p.addNotesFromSync=function(e,t){function n(){return o++,o>=e.length?void(t&&t()):void u(e[o],n)}var o=-1;n()},p.addIcon=function(n){if("page"==n.type){var r=e.getElemsByLocation(n.location);if(!r[0])return;var i=e.createNoteMarker(n,r[0],{"class":"contentSideNoteMarker"});i.setAttribute("nid",n.nid),i.setAttribute("ncontent",n.note?n.note:""),i.setAttribute("nloc",n.location),i.addEventListener("click",function(){c.safeScrollToElem("content",i,!0);var e={};e.note=this.getAttribute("ncontent"),e.nid=this.getAttribute("nid"),e.location=this.getAttribute("nloc"),e.type="page",p.noteClicked(e)}),i.addEventListener("hold",function(){var r=[{name:t.get("edit"),func:function(){s.hide(),p.noteClicked(n)}},{name:t.get("delete"),func:function(){o.deleteNote(n.nid,null,function(){e.deleteNoteMarker(n.nid),s.hide()})}},{name:t.get("cancel"),func:function(){s.hide()}}];s.show({mode:"list",listOb:r,backdropClickToClose:!1})})}if("content"==n.type){for(var r=e.getElemsByLocation(n.location),a=0;a<r.length;a++)r[a]&&(addClass(r[a],"contentNoteBG"),addClass(r[a],"note"+n.nid));var d=r[r.length-1];if(!d)return;d.setAttribute("ncontent",n.note?n.note:""),d.setAttribute("nloc",n.location),addClass(d,"last"),l(function(){try{var t=e.createNoteMarker(n,d);t&&(t.onclick=function(e){var t=this.getAttribute("id"),n=document.getElementsByClassName(t),o=n[n.length-1],r=(o.getAttribute("ncontent"),{});r.note=o.getAttribute("ncontent"),r.location=o.getAttribute("nloc"),r.nid=t.substr(4),r.type="content",r.src=o.textContent,p.noteClicked(r),e.stopPropagation(),e.preventDefault()})}catch(o){}})}},p.noteClicked=function(t,n){try{t||(t={});var r={};r.save=function(r){t.chapter||(t.chapter=currentIndex),t.location||(t.location=e.getTopCornerLocation()),t.type||(t.type="page"),t.src||(t.src="content"==t.type?e.getSelectedText():"");var i=null==t.nid;t.note=r,o.addNote(t,function(){if(i)p.addIcon(t);else{var o=e.getNoteMarker(t.nid);o.elem.setAttribute("ncontent",t.note);var r=e.getElemsByLocation(t.location),s=r[r.length-1];s&&s.setAttribute("ncontent",t.note)}l(function(){a.hide(),n&&n(!0)},300)})},t.nid&&(r["delete"]=function(){p["delete"](t.nid,null,function(){l(function(){a.hide(),n&&n()},300)})}),t.note&&(r.note=t.note),a.show({mode:"note",dynamic:!0,animation:"slide-in-up",noteOptions:r,event:t.event})}catch(i){}},p["delete"]=function(t,n,r){e.deleteNoteMarker(t);for(var i=document.getElementsByClassName("note"+t),a=i.length;a--;)a==i.length-1&&(removeClass(i[a],"last"),i[a].removeAttribute("nloc"),i[a].removeAttribute("ncontent")),removeClass(i[a],"contentNoteBG"),removeClass(i[a],"note"+t);o.deleteNote(t,n,r)},p.deleteAll=function(e,t){o.getNotes(function(n){function o(){return r++,r>=n.length?void(t&&t()):void p["delete"](n[r].nid,e,o)}var r=-1;o()})},p}]);